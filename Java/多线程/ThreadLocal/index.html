<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="ThreadLocal æœ‰ä»€ä¹ˆç”¨ï¼Ÿ **ThreadLocalç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†ThreadLocal**ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚
å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªThreadLocalå˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯ThreadLocalå˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ get() å’Œ set() æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
å¦‚ä½•ä½¿ç”¨ ThreadLocalï¼Ÿ ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„è§£é‡Šï¼Œå¤§å®¶å·²ç»ææ‡‚ ThreadLocal ç±»æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿äº†ã€‚ä¸‹é¢ç®€å•æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åœ¨é¡¹ç›®ä¸­å®é™…ä½¿ç”¨ ThreadLocal ã€‚
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  import java."><meta property="og:title" content><meta property="og:description" content="ThreadLocal æœ‰ä»€ä¹ˆç”¨ï¼Ÿ **ThreadLocalç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†ThreadLocal**ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚
å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªThreadLocalå˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯ThreadLocalå˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ get() å’Œ set() æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
å¦‚ä½•ä½¿ç”¨ ThreadLocalï¼Ÿ ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„è§£é‡Šï¼Œå¤§å®¶å·²ç»ææ‡‚ ThreadLocal ç±»æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿äº†ã€‚ä¸‹é¢ç®€å•æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åœ¨é¡¹ç›®ä¸­å®é™…ä½¿ç”¨ ThreadLocal ã€‚
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  import java."><meta property="og:type" content="website"><meta property="og:image" content="https://quartz.jzhao.xyz/icon.png"><meta property="og:url" content="https://quartz.jzhao.xyz/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/ThreadLocal/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="ThreadLocal æœ‰ä»€ä¹ˆç”¨ï¼Ÿ **ThreadLocalç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†ThreadLocal**ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚
å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªThreadLocalå˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯ThreadLocalå˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ get() å’Œ set() æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
å¦‚ä½•ä½¿ç”¨ ThreadLocalï¼Ÿ ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„è§£é‡Šï¼Œå¤§å®¶å·²ç»ææ‡‚ ThreadLocal ç±»æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿äº†ã€‚ä¸‹é¢ç®€å•æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åœ¨é¡¹ç›®ä¸­å®é™…ä½¿ç”¨ ThreadLocal ã€‚
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  import java."><meta name=twitter:image content="https://quartz.jzhao.xyz/icon.png"><meta name=twitter:site content="_jzhao"><title>ğŸª´ Quartz 3.3</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://quartz.jzhao.xyz//icon.png><link href=https://quartz.jzhao.xyz/styles.19109a40042e9f0e72e952fda4442a34.min.css rel=stylesheet><link href=https://quartz.jzhao.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://quartz.jzhao.xyz/js/darkmode.63d6a3e095d0bd2b935b62adec9dc11b.min.js></script>
<script src=https://quartz.jzhao.xyz/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script defer src=https://quartz.jzhao.xyz/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://quartz.jzhao.xyz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://quartz.jzhao.xyz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://quartz.jzhao.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://quartz.jzhao.xyz/",fetchData=Promise.all([fetch("https://quartz.jzhao.xyz/indices/linkIndex.26897e4d1acf67c094aa607e8f2e6316.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://quartz.jzhao.xyz/indices/contentIndex.3f0c2b1dbf20ac151925c366cb9c3faf.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://quartz.jzhao.xyz",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://quartz.jzhao.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/quartz.jzhao.xyz\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=quartz.jzhao.xyz src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://quartz.jzhao.xyz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://quartz.jzhao.xyz/>ğŸª´ Quartz 3.3</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/Java/%e5%a4%9a%e7%ba%bf%e7%a8%8b/ThreadLocal.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#threadlocal-çš„æ•°æ®ç»“æ„>ThreadLocal çš„æ•°æ®ç»“æ„</a></li></ol><ol><li><a href=#java-çš„å››ç§åº”ç”¨ç±»å‹>Java çš„å››ç§åº”ç”¨ç±»å‹</a></li><li><a href=#key-ä¸ºå•¥è®¾è®¡é™ˆå¼±åº”ç”¨>Key ä¸ºå•¥è®¾è®¡é™ˆå¼±åº”ç”¨</a></li></ol><ol><li><a href=#åŸç†æ˜¯å•¥>åŸç†æ˜¯å•¥ï¼Ÿ</a></li></ol><ol><li><a href=#threadlocalmapçš„hashç®—æ³•>ThreadLocalMapçš„Hashç®—æ³•ï¼Ÿ</a></li><li><a href=#threadlocalmapçš„hashå†²çª>ThreadLocalMapçš„Hashå†²çª</a></li><li><a href=#threadlocalmapsetè¯¦è§£>ThreadLocalMap.setè¯¦è§£</a></li><li><a href=#threadlocalmapæ‰©å®¹æœºåˆ¶>ThreadLocalMapæ‰©å®¹æœºåˆ¶</a></li><li><a href=#threadlocalmapgetè¯¦è§£>ThreadLocalMap.getè¯¦è§£</a></li><li><a href=#threadlocalmap-è¿‡æœŸkeyçš„å¯å‘å¼æ¸…ç†è¿‡ç¨‹>ThreadLocalMap è¿‡æœŸKeyçš„å¯å‘å¼æ¸…ç†è¿‡ç¨‹</a></li></ol></nav></details></aside><a href=#threadlocal-æœ‰ä»€ä¹ˆç”¨><h1 id=threadlocal-æœ‰ä»€ä¹ˆç”¨><span class=hanchor arialabel=Anchor># </span>ThreadLocal æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h1></a><p>**<code>ThreadLocal</code><strong><strong>ç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°†</strong></strong><code>ThreadLocal</code>**<strong>ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚</strong></p><p>å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ª<code>ThreadLocal</code>å˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„æœ¬åœ°å‰¯æœ¬ï¼Œè¿™ä¹Ÿæ˜¯<code>ThreadLocal</code>å˜é‡åçš„ç”±æ¥ã€‚ä»–ä»¬å¯ä»¥ä½¿ç”¨ <code>get()</code> å’Œ <code>set()</code> æ–¹æ³•æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p><a href=#å¦‚ä½•ä½¿ç”¨-threadlocal><h1 id=å¦‚ä½•ä½¿ç”¨-threadlocal><span class=hanchor arialabel=Anchor># </span>å¦‚ä½•ä½¿ç”¨ ThreadLocalï¼Ÿ</h1></a><p>ç›¸ä¿¡çœ‹äº†ä¸Šé¢çš„è§£é‡Šï¼Œå¤§å®¶å·²ç»ææ‡‚ <code>ThreadLocal</code> ç±»æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿äº†ã€‚ä¸‹é¢ç®€å•æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•åœ¨é¡¹ç›®ä¸­å®é™…ä½¿ç”¨ <code>ThreadLocal</code> ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.text.SimpleDateFormat</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.Random</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ThreadLocalExample</span> <span class=kd>implements</span> <span class=n>Runnable</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=c1>// SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹éƒ½è¦æœ‰è‡ªå·±ç‹¬ç«‹çš„å‰¯æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>SimpleDateFormat</span><span class=o>&gt;</span> <span class=n>formatter</span> <span class=o>=</span> <span class=n>ThreadLocal</span><span class=o>.</span><span class=na>withInitial</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=o>(</span><span class=s>&#34;yyyyMMdd HHmm&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ThreadLocalExample</span> <span class=n>obj</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocalExample</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=o>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=n>0</span> <span class=o>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++){</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(</span><span class=n>obj</span><span class=o>,</span> <span class=s>&#34;&#34;</span><span class=o>+</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=k>new</span> <span class=n>Random</span><span class=o>().</span><span class=na>nextInt</span><span class=o>(</span><span class=n>1000</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Thread Name= &#34;</span><span class=o>+</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()+</span><span class=s>&#34; default Formatter = &#34;</span><span class=o>+</span><span class=n>formatter</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>toPattern</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=k>new</span> <span class=n>Random</span><span class=o>().</span><span class=na>nextInt</span><span class=o>(</span><span class=n>1000</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//formatter pattern is changed here by thread, but it won&#39;t reflect to other threads
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>formatter</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Thread Name= &#34;</span><span class=o>+</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>()+</span><span class=s>&#34; formatter = &#34;</span><span class=o>+</span><span class=n>formatter</span><span class=o>.</span><span class=na>get</span><span class=o>().</span><span class=na>toPattern</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¾“å‡ºç»“æœ :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>Thread Name= 0 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 0 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 1 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 2 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 1 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 3 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 2 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 4 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 3 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 4 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 5 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 5 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 6 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 6 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 7 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 7 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 8 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 9 default Formatter = yyyyMMdd HHmm
</span></span><span class=line><span class=cl>Thread Name= 8 formatter = yy-M-d ah:mm
</span></span><span class=line><span class=cl>Thread Name= 9 formatter = yy-M-d ah:mm
</span></span></code></pre></td></tr></table></div></div><p>ä»è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶ <code>Thread-0</code> å·²ç»æ”¹å˜äº† <code>formatter</code> çš„å€¼ï¼Œä½† <code>Thread-1</code> é»˜è®¤æ ¼å¼åŒ–å€¼ä¸åˆå§‹åŒ–å€¼ç›¸åŒï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¸€æ ·ã€‚</p><p>ä¸Šé¢æœ‰ä¸€æ®µä»£ç ç”¨åˆ°äº†åˆ›å»º <code>ThreadLocal</code> å˜é‡çš„é‚£æ®µä»£ç ç”¨åˆ°äº† Java8 çš„çŸ¥è¯†ï¼Œå®ƒç­‰äºä¸‹é¢è¿™æ®µä»£ç ï¼Œå¦‚æœä½ å†™äº†ä¸‹é¢è¿™æ®µä»£ç çš„è¯ï¼ŒIDEA ä¼šæç¤ºä½ è½¬æ¢ä¸º Java8 çš„æ ¼å¼(IDEA çœŸçš„ä¸é”™ï¼)ã€‚å› ä¸º ThreadLocal ç±»åœ¨ Java 8 ä¸­æ‰©å±•ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„æ–¹æ³•<code>withInitial()</code>ï¼Œå°† Supplier åŠŸèƒ½æ¥å£ä½œä¸ºå‚æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>SimpleDateFormat</span><span class=o>&gt;</span> <span class=n>formatter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ThreadLocal</span><span class=o>&lt;</span><span class=n>SimpleDateFormat</span><span class=o>&gt;(){</span><span class=nd>@Overrideprotected</span> <span class=n>SimpleDateFormat</span> <span class=nf>initialValue</span><span class=o>(){</span><span class=k>return</span> <span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=o>(</span><span class=s>&#34;yyyyMMdd HHmm&#34;</span><span class=o>);}};</span>
</span></span></code></pre></td></tr></table></div></div><a href=#threadlocal-åŸç†äº†è§£å—><h1 id=threadlocal-åŸç†äº†è§£å—><span class=hanchor arialabel=Anchor># </span>ThreadLocal åŸç†äº†è§£å—ï¼Ÿ</h1></a><a href=#threadlocal-çš„æ•°æ®ç»“æ„><h2 id=threadlocal-çš„æ•°æ®ç»“æ„><span class=hanchor arialabel=Anchor># </span>ThreadLocal çš„æ•°æ®ç»“æ„</h2></a><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-114.png width=auto alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Thread</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ThreadLocal</span><span class=o>.</span><span class=na>ThreadLocalMap</span> <span class=n>threadLocals</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„InheritableThreadLocalå€¼ã€‚ç”±InheritableThreadLocalç±»ç»´æŠ¤
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ThreadLocal</span><span class=o>.</span><span class=na>ThreadLocalMap</span> <span class=n>inheritableThreadLocals</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>ä»ä¸Šé¢<code>Thread</code>ç±» æºä»£ç å¯ä»¥çœ‹å‡º<code>Thread</code> ç±»ä¸­æœ‰ä¸€ä¸ª <code>threadLocals</code> å’Œ ä¸€ä¸ª <code>inheritableThreadLocals</code> å˜é‡ï¼Œå®ƒä»¬éƒ½æ˜¯ <code>ThreadLocalMap</code> ç±»å‹çš„å˜é‡,é»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ nullï¼Œåªæœ‰å½“å‰çº¿ç¨‹è°ƒç”¨ <code>ThreadLocal</code> ç±»çš„ <code>set</code>æˆ–<code>get</code>æ–¹æ³•æ—¶æ‰åˆ›å»ºå®ƒä»¬ã€‚</p><ul><li><p>æ¯ä¸ªçº¿ç¨‹åœ¨å¾€<code>ThreadLocal</code>é‡Œæ”¾å€¼çš„æ—¶å€™ï¼Œ<strong>éƒ½ä¼šå¾€è‡ªå·±çš„</strong>**<code>ThreadLocalMap</code>**<strong>é‡Œå­˜</strong>ï¼Œè¯»ä¹Ÿæ˜¯ä»¥<code>ThreadLocal</code>ä½œä¸ºå¼•ç”¨ï¼Œåœ¨è‡ªå·±çš„<code>map</code>é‡Œæ‰¾å¯¹åº”çš„<code>key</code>ï¼Œä»è€Œå®ç°äº†çº¿ç¨‹éš”ç¦»ã€‚</p></li><li><p><code>ThreadLocalMap</code>æœ‰ç‚¹ç±»ä¼¼<code>HashMap</code>çš„ç»“æ„ï¼Œ<strong>åªæ˜¯</strong>**<code>HashMap</code><strong><strong>æ˜¯ç”±æ•°ç»„+é“¾è¡¨å®ç°çš„ï¼Œè€Œ</strong></strong><code>ThreadLocalMap</code>**<strong>ä¸­å¹¶æ²¡æœ‰é“¾è¡¨ç»“æ„</strong>ã€‚</p></li></ul></li></ul><p><code>ThreadLocal</code>ç±»çš„<code>set()</code>æ–¹æ³•</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-115.png width=auto alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>set</span><span class=o>(</span><span class=n>T</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//è·å–å½“å‰è¯·æ±‚çš„çº¿ç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å–å‡º Thread ç±»å†…éƒ¨çš„ threadLocals å˜é‡(å“ˆå¸Œè¡¨ç»“æ„)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ThreadLocalMap</span> <span class=n>map</span> <span class=o>=</span> <span class=n>getMap</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>map</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å°†éœ€è¦å­˜å‚¨çš„å€¼æ”¾å…¥åˆ°è¿™ä¸ªå“ˆå¸Œè¡¨ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>map</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>createMap</span><span class=o>(</span><span class=n>t</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=n>ThreadLocalMap</span> <span class=nf>getMap</span><span class=o>(</span><span class=n>Thread</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>t</span><span class=o>.</span><span class=na>threadLocals</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„</strong> <strong><code>ThreadLocalMap</code></strong> <strong>ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨</strong> <strong><code>ThreadLocal</code></strong> <strong>ä¸Šï¼Œ****<code>ThreadLocal</code></strong> <strong>å¯ä»¥ç†è§£ä¸ºåªæ˜¯</strong>**<code>ThreadLocalMap</code>**<strong>çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚</strong> <code>ThrealLocal</code> ç±»ä¸­å¯ä»¥é€šè¿‡<code>Thread.currentThread()</code>è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡<code>getMap(Thread t)</code>å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„<code>ThreadLocalMap</code>å¯¹è±¡ã€‚</p></li><li><p><strong>æ¯ä¸ª</strong>**<code>Thread</code><strong><strong>ä¸­éƒ½å…·å¤‡ä¸€ä¸ª</strong></strong><code>ThreadLocalMap</code><strong><strong>ï¼Œè€Œ</strong></strong><code>ThreadLocalMap</code><strong><strong>å¯ä»¥å­˜å‚¨ä»¥</strong></strong><code>ThreadLocal</code>**<strong>ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚</strong></p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>ThreadLocalMap</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>firstKey</span><span class=o>,</span> <span class=n>Object</span> <span class=n>firstValue</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//......
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¯”å¦‚æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å£°æ˜äº†ä¸¤ä¸ª <code>ThreadLocal</code> å¯¹è±¡çš„è¯ï¼Œ <code>Thread</code>å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ä»…æœ‰çš„é‚£ä¸ª<code>ThreadLocalMap</code> å­˜æ”¾æ•°æ®çš„ï¼Œ<code>ThreadLocalMap</code>çš„ key å°±æ˜¯ <code>ThreadLocal</code>å¯¹è±¡ï¼Œvalue å°±æ˜¯ <code>ThreadLocal</code> å¯¹è±¡è°ƒç”¨<code>set</code>æ–¹æ³•è®¾ç½®çš„å€¼ã€‚</p><p><code>ThreadLocal</code> æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-110.png width=auto alt></p><p><code>ThreadLocalMap</code>æ˜¯<code>ThreadLocal</code>çš„é™æ€å†…éƒ¨ç±»ã€‚</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-111.png width=auto alt></p><a href=#threadlocal-å†…å­˜æ³„éœ²é—®é¢˜æ˜¯æ€ä¹ˆå¯¼è‡´çš„><h1 id=threadlocal-å†…å­˜æ³„éœ²é—®é¢˜æ˜¯æ€ä¹ˆå¯¼è‡´çš„><span class=hanchor arialabel=Anchor># </span>ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜æ˜¯æ€ä¹ˆå¯¼è‡´çš„ï¼Ÿ</h1></a><ul><li><p><code>ThreadLocalMap</code> ä¸­ä½¿ç”¨çš„ key ä¸º <code>ThreadLocal</code> çš„<strong>å¼±å¼•ç”¨</strong>ï¼Œè€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚</p></li><li><p>å¦‚æœ <code>ThreadLocal</code> æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚</p></li><li><p><code>ThreadLocalMap</code> ä¸­å°±ä¼šå‡ºç° key ä¸º null çš„ Entryã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œvalue æ°¸è¿œæ— æ³•è¢« GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚<strong><code>ThreadLocalMap</code></strong> <strong>å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µ</strong>ï¼Œåœ¨è°ƒç”¨ <code>set()</code>ã€<code>get()</code>ã€<code>remove()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•ã€‚</p></li><li><p>ä½¿ç”¨å®Œ <code>ThreadLocal</code>æ–¹æ³•å æœ€å¥½æ‰‹åŠ¨è°ƒç”¨<code>remove()</code>æ–¹æ³•</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>static</span> <span class=kd>class</span> <span class=nc>Entry</span> <span class=kd>extends</span> <span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;&gt;</span> <span class=o>{</span><span class=cm>/** The value associated with this ThreadLocal. */</span><span class=n>Object</span> <span class=n>value</span><span class=o>;</span><span class=n>Entry</span><span class=o>(</span><span class=n>ThreadLocal</span><span class=o>&lt;?&gt;</span> <span class=n>k</span><span class=o>,</span> <span class=n>Object</span> <span class=n>v</span><span class=o>)</span> <span class=o>{</span><span class=kd>super</span><span class=o>(</span><span class=n>k</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=n>v</span><span class=o>;}}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><a href=#java-çš„å››ç§åº”ç”¨ç±»å‹><h2 id=java-çš„å››ç§åº”ç”¨ç±»å‹><span class=hanchor arialabel=Anchor># </span>Java çš„å››ç§åº”ç”¨ç±»å‹</h2></a></blockquote><blockquote><ol><li><p><strong>å¼ºå¼•ç”¨</strong>ï¼šæˆ‘ä»¬å¸¸å¸¸ new å‡ºæ¥çš„å¯¹è±¡å°±æ˜¯å¼ºå¼•ç”¨ç±»å‹ï¼Œåªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œ<strong>åƒåœ¾å›æ”¶å™¨å°†æ°¸è¿œä¸ä¼šå›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œå“ªæ€•å†…å­˜ä¸è¶³çš„æ—¶å€™</strong></p></li><li><p><strong>è½¯å¼•ç”¨</strong>ï¼šä½¿ç”¨ SoftReference ä¿®é¥°çš„å¯¹è±¡è¢«ç§°ä¸ºè½¯å¼•ç”¨ï¼Œ<strong>è½¯å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡åœ¨å†…å­˜è¦æº¢å‡ºçš„æ—¶å€™è¢«å›æ”¶</strong></p></li><li><p><strong>å¼±å¼•ç”¨</strong>ï¼šä½¿ç”¨ WeakReference ä¿®é¥°çš„å¯¹è±¡è¢«ç§°ä¸ºå¼±å¼•ç”¨ï¼Œ<strong>åªè¦å‘ç”Ÿåƒåœ¾å›æ”¶ï¼Œè‹¥è¿™ä¸ªå¯¹è±¡åªè¢«å¼±å¼•ç”¨æŒ‡å‘ï¼Œé‚£ä¹ˆå°±ä¼šè¢«å›æ”¶</strong></p></li><li><p><strong>è™šå¼•ç”¨</strong>ï¼šè™šå¼•ç”¨æ˜¯æœ€å¼±çš„å¼•ç”¨ï¼Œåœ¨ Java ä¸­ä½¿ç”¨ PhantomReference è¿›è¡Œå®šä¹‰ã€‚<strong>è™šå¼•ç”¨ä¸­å”¯ä¸€çš„ä½œç”¨å°±æ˜¯ç”¨é˜Ÿåˆ—æ¥æ”¶å¯¹è±¡å³å°†æ­»äº¡çš„é€šçŸ¥</strong></p></li></ol></blockquote><a href=#key-ä¸ºå•¥è®¾è®¡é™ˆå¼±åº”ç”¨><h2 id=key-ä¸ºå•¥è®¾è®¡é™ˆå¼±åº”ç”¨><span class=hanchor arialabel=Anchor># </span>Key ä¸ºå•¥è®¾è®¡é™ˆå¼±åº”ç”¨</h2></a><p>keyè¢«è®¾è®¡æˆå¼ºå¼•ç”¨ï¼Œå¦‚æœThreadLocal Referenceè¢«é”€æ¯ï¼Œæ­¤æ—¶<strong>å®ƒæŒ‡å‘ThreadLocalçš„å¼ºå¼•ç”¨å°±æ²¡æœ‰äº†</strong>ï¼Œä½†æ˜¯æ­¤æ—¶<strong>keyè¿˜å¼ºå¼•ç”¨æŒ‡å‘ThreadLocal</strong>ï¼Œå°±ä¼šå¯¼è‡´ThreadLocalä¸èƒ½è¢«å›æ”¶ï¼Œè¿™æ—¶å€™å°±å‘ç”Ÿäº†å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚</p><a href=#çˆ¶å­çº¿ç¨‹æ€ä¹ˆå…±äº«æ•°æ®><h1 id=çˆ¶å­çº¿ç¨‹æ€ä¹ˆå…±äº«æ•°æ®><span class=hanchor arialabel=Anchor># </span>çˆ¶å­çº¿ç¨‹æ€ä¹ˆå…±äº«æ•°æ®</h1></a><p>InheritableThreadLocalï¼šåœ¨ä¸»çº¿ç¨‹çš„InheritableThreadLocalå®ä¾‹è®¾ç½®å€¼ï¼Œåœ¨å­çº¿ç¨‹ä¸­å°±å¯ä»¥ æ‹¿åˆ°äº†</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-113.png width=auto alt></p><a href=#åŸç†æ˜¯å•¥><h2 id=åŸç†æ˜¯å•¥><span class=hanchor arialabel=Anchor># </span>åŸç†æ˜¯å•¥ï¼Ÿ</h2></a><p>åœ¨Threadç±»é‡Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªå˜é‡ï¼š</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-111.png width=auto alt></p><p>åœ¨Thread.initçš„æ—¶å€™ï¼Œ<strong>å¦‚æœçˆ¶çº¿ç¨‹çš„ inheritableThreadLocals ä¸ä¸ºç©ºï¼Œå°±æŠŠå®ƒèµ‹ç»™å½“å‰çº¿ç¨‹ï¼ˆå­çº¿ç¨‹ï¼‰çš„ inheritableThreadLocals ã€‚</strong></p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-122.png width=auto alt></p><a href=#threadlocalmap><h1 id=threadlocalmap><span class=hanchor arialabel=Anchor># </span>ThreadLocalMap</h1></a><p>ThreadLocalMapè™½ç„¶è¢«å«åšMapï¼Œå…¶å®å®ƒæ˜¯<strong>æ²¡æœ‰å®ç°Mapæ¥å£çš„ï¼Œä½†æ˜¯ç»“æ„è¿˜æ˜¯å’Œ HashMapæ¯”è¾ƒç±»ä¼¼çš„</strong>ï¼Œä¸»è¦å…³æ³¨çš„æ˜¯ä¸¤ä¸ªè¦ç´ ï¼š å…ƒç´ æ•°ç»„ å’Œ æ•£åˆ—æ–¹æ³• ã€‚</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-116.png width=auto alt></p><ul><li><p>å…ƒç´ æ•°ç»„:ä¸€ä¸ªtableæ•°ç»„ï¼Œå­˜å‚¨Entryç±»å‹çš„å…ƒç´ ï¼ŒEntryæ˜¯ThreaLocalå¼±å¼•ç”¨ä½œä¸ºkeyï¼ŒObjectä½œä¸ºvalueçš„ç»“æ„</p></li><li><p>æ•£åˆ—æ–¹æ³•ï¼šæ•£åˆ—æ–¹æ³•å°±æ˜¯æ€ä¹ˆæŠŠå¯¹åº”çš„keyæ˜ å°„åˆ°tableæ•°ç»„çš„ç›¸åº”ä¸‹æ ‡ï¼ŒThreadLocalMapç”¨ çš„æ˜¯å“ˆå¸Œå–ä½™æ³•ï¼Œå–å‡ºkeyçš„threadLocalHashCodeï¼Œç„¶åå’Œtableæ•°ç»„é•¿åº¦å‡ä¸€& è¿ç®—ï¼ˆ<strong>ç›¸å½“äºå–ä½™</strong>ï¼‰ã€‚</p></li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-112.png width=auto alt></p><p>threadLocalHashCodeè®¡ç®—æœ‰ç‚¹ä¸œè¥¿ï¼Œæ¯åˆ›å»ºä¸€ä¸ªThreadLocalå¯¹è±¡ï¼Œå®ƒå°±ä¼šæ–° å¢ <strong>0x61c88647</strong> ï¼Œè¿™ä¸ªå€¼å¾ˆç‰¹æ®Šï¼Œå®ƒæ˜¯æ–æ³¢é‚£å¥‘æ•° ä¹Ÿå« é»„é‡‘åˆ†å‰²æ•°ã€‚ hash å¢é‡ä¸º è¿™ä¸ªæ•°å­—ï¼Œå¸¦æ¥çš„å¥½å¤„å°±æ˜¯ hash åˆ†å¸ƒéå¸¸å‡åŒ€ã€‚</p><a href=#threadlocalmapçš„hashç®—æ³•><h2 id=threadlocalmapçš„hashç®—æ³•><span class=hanchor arialabel=Anchor># </span>ThreadLocalMapçš„Hashç®—æ³•ï¼Ÿ</h2></a><p>ThreadLocalMapæ²¡æœ‰ä½¿ç”¨é“¾è¡¨ï¼Œè‡ªç„¶ä¹Ÿä¸æ˜¯ç”¨é“¾åœ°å€æ³•æ¥è§£å†³å†²çªäº†ï¼Œå®ƒç”¨çš„æ˜¯å¦å¤–ä¸€ç§æ–¹å¼â€”â€”<strong>å¼€æ”¾å®šå€æ³•</strong>ã€‚</p><ul><li><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯è¿™ä¸ªå‘è¢« äººå äº†ï¼Œé‚£å°±æ¥ç€å»æ‰¾ç©ºç€çš„å‘ã€‚</p></li><li><p><code>ThreadLocalMap</code>ä¸­<code>hash</code>ç®—æ³•å¾ˆç®€å•ï¼Œè¿™é‡Œ<code>i</code>å°±æ˜¯å½“å‰ key åœ¨æ•£åˆ—è¡¨ä¸­å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ä½ç½®ã€‚</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-113.png width=auto alt></p><ul><li><p>è¿™é‡Œæœ€å…³é”®çš„å°±æ˜¯<code>threadLocalHashCode</code>å€¼çš„è®¡ç®—ï¼Œ<code>ThreadLocal</code>ä¸­æœ‰ä¸€ä¸ªå±æ€§ä¸º<code>HASH_INCREMENT = 0x61c88647</code></p></li><li><p>åˆ›å»ºä¸€ä¸ª<code>ThreadLocal</code>å¯¹è±¡ï¼Œè¿™ä¸ª<code>ThreadLocal.nextHashCode</code> è¿™ä¸ªå€¼å°±ä¼šå¢é•¿ <code>0x61c88647</code> è¿™ä¸ªå€¼å¾ˆç‰¹æ®Šï¼Œå®ƒæ˜¯<strong>æ–æ³¢é‚£å¥‘æ•°</strong> ä¹Ÿå« <strong>é»„é‡‘åˆ†å‰²æ•°</strong>ã€‚<code>hash</code>å¢é‡ä¸º è¿™ä¸ªæ•°å­—ï¼Œå¸¦æ¥çš„å¥½å¤„å°±æ˜¯ <code>hash</code> <strong>åˆ†å¸ƒéå¸¸å‡åŒ€</strong>ã€‚</p></li></ul></li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-113.png width=auto alt></p><a href=#threadlocalmapçš„hashå†²çª><h2 id=threadlocalmapçš„hashå†²çª><span class=hanchor arialabel=Anchor># </span>ThreadLocalMapçš„Hashå†²çª</h2></a><blockquote><p><strong>æ³¨æ˜ï¼š</strong> ä¸‹é¢æ‰€æœ‰ç¤ºä¾‹å›¾ä¸­ï¼Œ<strong>ç»¿è‰²å—</strong><code>Entry</code>ä»£è¡¨<strong>æ­£å¸¸æ•°æ®</strong>ï¼Œ<strong>ç°è‰²å—</strong>ä»£è¡¨<code>Entry</code>çš„<code>key</code>å€¼ä¸º<code>null</code>ï¼Œ<strong>å·²è¢«åƒåœ¾å›æ”¶</strong>ã€‚<strong>ç™½è‰²å—</strong>è¡¨ç¤º<code>Entry</code>ä¸º<code>null</code>ã€‚</p></blockquote><p>è™½ç„¶<code>ThreadLocalMap</code>ä¸­ä½¿ç”¨äº†<strong>é»„é‡‘åˆ†å‰²æ•°</strong>æ¥ä½œä¸º<code>hash</code>è®¡ç®—å› å­ï¼Œå¤§å¤§å‡å°‘äº†<code>Hash</code>å†²çªçš„æ¦‚ç‡ï¼Œä½†æ˜¯ä»ç„¶ä¼šå­˜åœ¨å†²çªã€‚</p><p><code>HashMap</code>ä¸­è§£å†³å†²çªçš„æ–¹æ³•æ˜¯åœ¨æ•°ç»„ä¸Šæ„é€ ä¸€ä¸ª<strong>é“¾è¡¨</strong>ç»“æ„ï¼Œå†²çªçš„æ•°æ®æŒ‚è½½åˆ°é“¾è¡¨ä¸Šï¼Œå¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡ä¸€å®šæ•°é‡åˆ™ä¼šè½¬åŒ–æˆ<strong>çº¢é»‘æ ‘</strong>ã€‚</p><p><code>ThreadLocalMap</code> ä¸­å¹¶æ²¡æœ‰é“¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ä½¿ç”¨ <code>HashMap</code> è§£å†³å†²çªçš„æ–¹å¼äº†ã€‚</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-116.png width=auto alt></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœæˆ‘ä»¬æ’å…¥ä¸€ä¸ª<code>value=27</code>çš„æ•°æ®ï¼Œé€šè¿‡ <code>hash</code> è®¡ç®—ååº”è¯¥è½å…¥æ§½ä½ 4 ä¸­ï¼Œè€Œæ§½ä½ 4 å·²ç»æœ‰äº† <code>Entry</code> æ•°æ®ã€‚</p><p>æ­¤æ—¶å°±ä¼šçº¿æ€§å‘åæŸ¥æ‰¾ï¼Œä¸€ç›´æ‰¾åˆ° <code>Entry</code> ä¸º <code>null</code> çš„æ§½ä½æ‰ä¼šåœæ­¢æŸ¥æ‰¾ï¼Œå°†å½“å‰å…ƒç´ æ”¾å…¥æ­¤æ§½ä½ä¸­ã€‚å½“ç„¶è¿­ä»£è¿‡ç¨‹ä¸­è¿˜æœ‰å…¶ä»–çš„æƒ…å†µï¼Œ<strong>æ¯”å¦‚é‡åˆ°äº†</strong> <strong><code>Entry</code></strong> <strong>ä¸ä¸º</strong> <strong><code>null</code></strong> <strong>ä¸”</strong> <strong><code>key</code></strong> <strong>å€¼ç›¸ç­‰çš„æƒ…å†µï¼Œè¿˜æœ‰</strong> <strong><code>Entry</code></strong> <strong>ä¸­çš„</strong> <strong><code>key</code></strong> <strong>å€¼ä¸º</strong> <strong><code>null</code></strong> <strong>çš„æƒ…å†µç­‰ç­‰éƒ½ä¼šæœ‰ä¸åŒçš„å¤„ç†</strong></p><p>è¿™é‡Œè¿˜ç”»äº†ä¸€ä¸ª<code>Entry</code>ä¸­çš„<code>key</code>ä¸º<code>null</code>çš„æ•°æ®ï¼ˆ<strong>Entry=2 çš„ç°è‰²å—æ•°æ®</strong>ï¼‰ï¼Œå› ä¸º<code>key</code>å€¼æ˜¯<strong>å¼±å¼•ç”¨</strong>ç±»å‹ï¼Œæ‰€ä»¥ä¼šæœ‰è¿™ç§æ•°æ®å­˜åœ¨ã€‚åœ¨<code>set</code>è¿‡ç¨‹ä¸­ï¼Œ<strong>å¦‚æœé‡åˆ°äº†</strong>**<code>key</code><strong><strong>è¿‡æœŸçš„</strong></strong><code>Entry</code>****æ•°æ®ï¼Œ<strong>å®é™…ä¸Šæ˜¯ä¼šè¿›è¡Œä¸€è½®</strong>æ¢æµ‹å¼æ¸…ç†**æ“ä½œçš„ï¼Œå…·ä½“æ“ä½œæ–¹å¼åé¢ä¼šè®²åˆ°ã€‚</p><a href=#threadlocalmapsetè¯¦è§£><h2 id=threadlocalmapsetè¯¦è§£><span class=hanchor arialabel=Anchor># </span>ThreadLocalMap.setè¯¦è§£</h2></a><p>çœ‹å®Œäº†<code>ThreadLocal</code> hash ç®—æ³•åï¼Œæˆ‘ä»¬å†æ¥çœ‹<code>set</code>æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæœ‰å¥½å‡ ç§æƒ…å†µ</p><ul><li>ç¬¬ä¸€ç§æƒ…å†µï¼š é€šè¿‡<code>hash</code>è®¡ç®—åçš„æ§½ä½å¯¹åº”çš„<code>Entry</code>æ•°æ®ä¸ºç©ºï¼Œè¿™é‡Œç›´æ¥å°†æ•°æ®æ”¾åˆ°è¯¥æ§½ä½å³å¯ã€‚</li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-115.png width=auto alt></p><ul><li>ç¬¬äºŒç§æƒ…å†µï¼š æ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œ<code>key</code>å€¼ä¸å½“å‰<code>ThreadLocal</code>é€šè¿‡<code>hash</code>è®¡ç®—è·å–çš„<code>key</code>å€¼ä¸€è‡´ï¼šè¿™é‡Œç›´æ¥æ›´æ–°è¯¥æ§½ä½çš„æ•°æ®ã€‚</li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-114.png width=auto alt></p><ul><li>ç¬¬ä¸‰ç§æƒ…å†µï¼š æ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œåœ¨æ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>çš„æ§½ä½ä¹‹å‰ï¼Œæ²¡æœ‰é‡åˆ°<code>key</code>è¿‡æœŸçš„<code>Entry</code>ï¼Œéå†æ•£åˆ—æ•°ç»„ï¼Œçº¿æ€§å¾€åæŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>çš„æ§½ä½ï¼Œåˆ™å°†æ•°æ®æ”¾å…¥è¯¥æ§½ä½ä¸­ï¼Œæˆ–è€…å¾€åéå†è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†key å€¼ç›¸ç­‰çš„æ•°æ®ï¼Œç›´æ¥æ›´æ–°å³å¯ã€‚</li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-119.png width=auto alt></p><ul><li><p>ç¬¬å››ç§æƒ…å†µï¼š æ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œåœ¨æ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>çš„æ§½ä½ä¹‹å‰ï¼Œ<strong>é‡åˆ°</strong>**<code>key</code><strong><strong>è¿‡æœŸçš„</strong></strong><code>Entry</code><strong>ï¼Œå¦‚ä¸‹å›¾ï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†<code>index=7</code>çš„æ§½ä½æ•°æ®<code>Entry</code>çš„<code>key=null</code>ï¼šæ•£åˆ—æ•°ç»„ä¸‹æ ‡ä¸º 7 ä½ç½®å¯¹åº”çš„<code>Entry</code>æ•°æ®<code>key</code>ä¸º<code>null</code>ï¼Œè¡¨æ˜æ­¤æ•°æ®<code>key</code>å€¼å·²ç»è¢«åƒåœ¾å›æ”¶æ‰äº†ï¼Œæ­¤æ—¶å°±ä¼šæ‰§è¡Œ<code>replaceStaleEntry()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯</strong>æ›¿æ¢è¿‡æœŸæ•°æ®çš„é€»è¾‘**ï¼Œä»¥<strong>index=7</strong>ä½èµ·ç‚¹å¼€å§‹éå†ï¼Œ<strong>è¿›è¡Œæ¢æµ‹å¼æ•°æ®æ¸…ç†å·¥ä½œ</strong>ã€‚</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-117.png width=auto alt></p><ul><li><p>åˆå§‹åŒ–æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®æ‰«æçš„å¼€å§‹ä½ç½®ï¼š<code>slotToExpunge = staleSlot = 7</code>ï¼Œ</p></li><li><p>ä»¥å½“å‰<code>staleSlot</code>å¼€å§‹ å‘å‰è¿­ä»£æŸ¥æ‰¾ï¼Œæ‰¾å…¶ä»–è¿‡æœŸçš„æ•°æ®ï¼Œç„¶åæ›´æ–°è¿‡æœŸæ•°æ®èµ·å§‹æ‰«æä¸‹æ ‡<code>slotToExpunge</code>ã€‚<code>for</code>å¾ªç¯è¿­ä»£ï¼Œç›´åˆ°ç¢°åˆ°<code>Entry</code>ä¸º<code>null</code>ç»“æŸã€‚</p></li><li><p>å¦‚æœæ‰¾åˆ°äº†è¿‡æœŸçš„æ•°æ®ï¼Œç»§ç»­å‘å‰è¿­ä»£ï¼Œç›´åˆ°é‡åˆ°<code>Entry=null</code>çš„æ§½ä½æ‰åœæ­¢è¿­ä»£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ<strong>slotToExpunge è¢«æ›´æ–°ä¸º 0</strong>ï¼š</p></li><li><p>ä¸Šé¢å‘å‰è¿­ä»£çš„æ“ä½œæ˜¯ä¸ºäº†æ›´æ–°æ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®çš„èµ·å§‹ä¸‹æ ‡<code>slotToExpunge</code>çš„å€¼ï¼Œè¿™ä¸ªå€¼åœ¨åé¢ä¼šè®²è§£ï¼Œå®ƒæ˜¯**ç”¨æ¥åˆ¤æ–­å½“å‰è¿‡æœŸæ§½ä½****<code>staleSlot</code>**<strong>ä¹‹å‰æ˜¯å¦è¿˜æœ‰è¿‡æœŸå…ƒç´ </strong>ã€‚</p></li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-123.png width=auto alt></p><ul><li>æ¥ç€å¼€å§‹ä»¥<code>staleSlot</code>ä½ç½®(<code>index=7</code>)å‘åè¿­ä»£ï¼Œå¦‚æœæ‰¾åˆ°äº†ç›¸åŒ key å€¼çš„ Entry æ•°æ®</li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-120.png width=auto alt></p></li></ul><p>ä»å½“å‰èŠ‚ç‚¹<code>staleSlot</code>å‘åæŸ¥æ‰¾<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>å…ƒç´ ï¼Œæ‰¾åˆ°åæ›´æ–°<code>Entry</code>çš„å€¼å¹¶äº¤æ¢<code>staleSlot</code>å…ƒç´ çš„ä½ç½®(<code>staleSlot</code>ä½ç½®ä¸ºè¿‡æœŸå…ƒç´ )ï¼Œæ›´æ–°<code>Entry</code>æ•°æ®ï¼Œç„¶åå¼€å§‹è¿›è¡Œè¿‡æœŸ<code>Entry</code>çš„æ¸…ç†å·¥ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-119.png width=auto alt></p><p>å‘åéå†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸åŒ key å€¼çš„ Entry æ•°æ®ï¼š</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-119.png width=auto alt></p><p>ä»å½“å‰èŠ‚ç‚¹<code>staleSlot</code>å‘åæŸ¥æ‰¾<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>å…ƒç´ ï¼Œç›´åˆ°<code>Entry</code>ä¸º<code>null</code>åˆ™åœæ­¢å¯»æ‰¾ã€‚é€šè¿‡ä¸Šå›¾å¯çŸ¥ï¼Œæ­¤æ—¶<code>table</code>ä¸­æ²¡æœ‰<code>key</code>å€¼ç›¸åŒçš„<code>Entry</code>ã€‚</p><p>åˆ›å»ºæ–°çš„<code>Entry</code>ï¼Œæ›¿æ¢<code>table[stableSlot]</code>ä½ç½®ï¼š</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-120.png width=auto alt></p><p>æ›¿æ¢å®Œæˆåä¹Ÿæ˜¯è¿›è¡Œè¿‡æœŸå…ƒç´ æ¸…ç†å·¥ä½œï¼Œæ¸…ç†å·¥ä½œä¸»è¦æ˜¯æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š<code>expungeStaleEntry()</code>å’Œ<code>cleanSomeSlots()</code>ï¼Œå…·ä½“ç»†èŠ‚åé¢ä¼šè®²åˆ°ï¼Œè¯·ç»§ç»­å¾€åçœ‹</p><a href=#threadlocalmapæ‰©å®¹æœºåˆ¶><h2 id=threadlocalmapæ‰©å®¹æœºåˆ¶><span class=hanchor arialabel=Anchor># </span>ThreadLocalMapæ‰©å®¹æœºåˆ¶</h2></a><p>åœ¨ThreadLocalMap.set()æ–¹æ³•çš„æœ€åï¼Œ</p><ul><li><p>å¦‚æœ<strong>æ‰§è¡Œå®Œå¯å‘å¼æ¸…ç†å·¥ä½œå</strong>ï¼Œæœªæ¸…ç†åˆ°ä»»ä½•æ•°æ®ï¼Œ</p></li><li><p>ä¸”å½“å‰æ•£åˆ—æ•°ç»„ä¸­ Entry çš„æ•°é‡å·²ç»è¾¾åˆ°äº†åˆ—è¡¨çš„<strong>æ‰©å®¹é˜ˆå€¼ (len*2/3)</strong> ï¼Œ</p></li></ul><p>å°±å¼€å§‹æ‰§è¡Œ rehash() é€»è¾‘ï¼š</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-116.png width=auto alt></p><p>çœ‹rehash()å…·ä½“å®ç°ï¼š</p><ul><li><p><strong>è¿™é‡Œä¼šå…ˆè¿›è¡Œæ¢æµ‹å¼æ¸…ç†å·¥ä½œï¼Œ</strong></p></li><li><p><em><em>ç„¶åè¿˜è¦æ ¹æ®æ¡ä»¶åˆ¤æ–­ä¹Ÿå°±æ˜¯ size >= threshold</em> 3/4 æ¥å†³å®šæ˜¯å¦éœ€è¦æ‰©å®¹</em>*</p></li><li><p>æ‰©å®¹åçš„ <strong>newTab çš„å¤§å°ä¸ºè€æ•°ç»„çš„ä¸¤å€</strong>ï¼Œç„¶åéå†è€çš„tableæ•°ç»„ï¼Œæ•£åˆ—æ–¹æ³•é‡æ–°è®¡ç®—ä½ç½®ï¼Œå¼€æ”¾åœ°å€è§£å†³å†²çªï¼Œç„¶åæ”¾åˆ°æ–°çš„newTab ï¼Œéå†å®Œæˆä¹‹åï¼Œ oldTab ä¸­æ‰€æœ‰çš„ entry æ•°æ®éƒ½å·²ç»æ”¾å…¥åˆ° newTab ä¸­äº†ï¼Œç„¶åtableå¼•ç”¨æŒ‡å‘ newTab</p></li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-120.png width=auto alt></p><a href=#threadlocalmapgetè¯¦è§£><h2 id=threadlocalmapgetè¯¦è§£><span class=hanchor arialabel=Anchor># </span>ThreadLocalMap.getè¯¦è§£</h2></a><ul><li>ç¬¬ä¸€ç§æƒ…å†µï¼š é€šè¿‡æŸ¥æ‰¾<code>key</code>å€¼è®¡ç®—å‡ºæ•£åˆ—è¡¨ä¸­<code>slot</code>ä½ç½®ï¼Œç„¶åè¯¥<code>slot</code>ä½ç½®ä¸­çš„<code>Entry.key</code>å’ŒæŸ¥æ‰¾çš„<code>key</code>ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›ï¼š</li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-118.png width=auto alt></p><ul><li><p>ç¬¬äºŒç§æƒ…å†µï¼š <code>slot</code>ä½ç½®ä¸­çš„<code>Entry.key</code>å’Œè¦æŸ¥æ‰¾çš„<code>key</code>ä¸ä¸€è‡´ï¼š</p><ul><li><p>ç»§ç»­å¾€åè¿­ä»£æŸ¥æ‰¾</p></li><li><p>è¿­ä»£åˆ°<code>index=5</code>çš„æ•°æ®æ—¶ï¼Œæ­¤æ—¶<code>Entry.key=null</code>ï¼Œè§¦å‘ä¸€æ¬¡æ¢æµ‹å¼æ•°æ®å›æ”¶æ“ä½œ</p></li></ul></li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-121.png width=auto alt></p><ul><li>æ‰§è¡Œ<code>expungeStaleEntry()</code>æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåï¼Œ<code>index 5,8</code>çš„æ•°æ®éƒ½ä¼šè¢«å›æ”¶ï¼Œè€Œ<code>index 6,7</code>çš„æ•°æ®éƒ½ä¼šå‰ç§»ã€‚<code>index 6,7</code>å‰ç§»ä¹‹åï¼Œç»§ç»­ä» <code>index=5</code> å¾€åè¿­ä»£ï¼Œäºæ˜¯å°±åœ¨ <code>index=5</code> æ‰¾åˆ°äº†<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</li></ul><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-121.png width=auto alt></p><a href=#threadlocalmap-è¿‡æœŸkeyçš„å¯å‘å¼æ¸…ç†è¿‡ç¨‹><h2 id=threadlocalmap-è¿‡æœŸkeyçš„å¯å‘å¼æ¸…ç†è¿‡ç¨‹><span class=hanchor arialabel=Anchor># </span>ThreadLocalMap è¿‡æœŸKeyçš„å¯å‘å¼æ¸…ç†è¿‡ç¨‹</h2></a><p>å¤šæ¬¡æåŠåˆ°<code>ThreadLocalMap</code>è¿‡æœŸkeyçš„ä¸¤ç§æ¸…ç†æ–¹å¼ï¼š<strong>æ¢æµ‹å¼æ¸…ç†(expungeStaleEntry())</strong>ã€<strong>å¯å‘å¼æ¸…ç†(cleanSomeSlots())</strong></p><p>æ¢æµ‹å¼æ¸…ç†æ˜¯ä»¥å½“å‰<code>Entry</code> å¾€åæ¸…ç†ï¼Œé‡åˆ°å€¼ä¸º<code>null</code>åˆ™ç»“æŸæ¸…ç†ï¼Œå±äº<strong>çº¿æ€§æ¢æµ‹æ¸…ç†</strong>ã€‚</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-124.png width=auto alt></p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://quartz.jzhao.xyz/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Jacky Zhao using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://quartz.jzhao.xyz/>Home</a></li><li><a href=https://twitter.com/_jzhao>Twitter</a></li><li><a href=https://github.com/jackyzha0>GitHub</a></li></ul></footer></div></div></body></html>