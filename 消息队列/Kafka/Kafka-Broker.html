<!DOCTYPE html>
<html lang="zh"><head><title>Kafka Broker</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM Plex Mono&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:title" content="Kafka Broker"/><meta property="og:description" content="第 4 章 Kafka Broker Broker设计 ​ 我们都知道kafka能堆积非常大的数据，一台服务器，肯定是放不下的。由此出现的集群的概念，集群不仅可以让消息负载均衡，还能提高消息存取的吞吐量。kafka集群中，会有多台broker，每台broker分别在不同的机器上。 ​ 为了提高吞吐量，每个topic也会都多个分区，同时为了保持可靠性，每个分区还会有多个副本。这些分区副本被均匀的散落在每个broker上，其中每个分区副本中有一个副本为leader，其他的为follower。 ..."/><meta property="og:image" content="https://googoo-s.github.io/static/og-image.png"/><meta property="og:width" content="1200"/><meta property="og:height" content="675"/><link rel="icon" href="../../static/icon.png"/><meta name="description" content="第 4 章 Kafka Broker Broker设计 ​ 我们都知道kafka能堆积非常大的数据，一台服务器，肯定是放不下的。由此出现的集群的概念，集群不仅可以让消息负载均衡，还能提高消息存取的吞吐量。kafka集群中，会有多台broker，每台broker分别在不同的机器上。 ​ 为了提高吞吐量，每个topic也会都多个分区，同时为了保持可靠性，每个分区还会有多个副本。这些分区副本被均匀的散落在每个broker上，其中每个分区副本中有一个副本为leader，其他的为follower。 ..."/><meta name="generator" content="Quartz"/><link href="../../index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="../../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../../static/contentIndex.json").then(data => data.json())</script></head><body data-slug="消息队列/Kafka/Kafka-Broker"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h1 class="page-title"><a href="../..">googoo-s</a></h1><div class="darkmode"><input class="toggle" id="darkmode-toggle" type="checkbox" tabindex="-1"/><label id="toggle-label-light" for="darkmode-toggle" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve"><title>暗色模式</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg></label><label id="toggle-label-dark" for="darkmode-toggle" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve"><title>亮色模式</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></label></div><div class="spacer mobile-only"></div><div class="search"><div id="search-icon"><p>搜索</p><div></div><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search</title><desc id="desc">Search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></div><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="搜索些什么" placeholder="搜索些什么"/><div id="search-layout" data-preview="true"></div></div></div></div><div class="explorer desktop-only"><button type="button" id="explorer" data-behavior="collapse" data-collapsed="collapsed" data-savestate="true" data-tree="[{&quot;path&quot;:&quot;docker&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;ElasticSearch&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;GO&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;GO/八股文&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Java&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Kubernetes&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;linux&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;lua&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;MySQL&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Obsidian&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Python&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;Redis&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;shell&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;工具&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;工具/emacs&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;工具/git&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;工具/maven&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;工具/msys2&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;微服务&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;消息队列&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;消息队列/Kafka&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;编译原理&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;资源&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;高可用&quot;,&quot;collapsed&quot;:true}]"><h1>探索</h1><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="explorer-content"><ul class="overflow" id="explorer-ul"><li><div class="folder-outer open"><ul style="padding-left:0;" class="content" data-folderul><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="docker"><button class="folder-button"><span class="folder-title">docker</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="docker"><li><a href="../../docker/docker" data-for="docker/docker">docker</a></li><li><a href="../../docker/Docker-基础" data-for="docker/Docker-基础">Docker 初学者命令</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="ElasticSearch"><button class="folder-button"><span class="folder-title">ElasticSearch</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="ElasticSearch"><li><a href="../../ElasticSearch/KQL" data-for="ElasticSearch/KQL">KQL</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="GO"><button class="folder-button"><span class="folder-title">GO</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="GO"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="GO/八股文"><button class="folder-button"><span class="folder-title">八股文</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="GO/八股文"><li><a href="../../GO/八股文/Context" data-for="GO/八股文/Context">Context</a></li><li><a href="../../GO/八股文/Golang基础" data-for="GO/八股文/Golang基础">Golang基础</a></li><li><a href="../../GO/八股文/Map-和Sync.map" data-for="GO/八股文/Map-和Sync.map">Map</a></li><li><a href="../../GO/八股文/Slice" data-for="GO/八股文/Slice">Slice</a></li><li><a href="../../GO/八股文/内存管理和GC" data-for="GO/八股文/内存管理和GC">内存管理</a></li><li><a href="../../GO/八股文/并发" data-for="GO/八股文/并发">并发</a></li></ul></div></li><li><a href="../../GO/GO" data-for="GO/GO">GO</a></li></ul></div></li><li><div class="folder-outer "><ul style="padding-left:0;" class="content" data-folderul></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Java"><button class="folder-button"><span class="folder-title">Java</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Java"><li><a href="../../Java/Java" data-for="Java/Java">☆Java</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Kubernetes"><button class="folder-button"><span class="folder-title">Kubernetes</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Kubernetes"><li><a href="../../Kubernetes/Kubernetes" data-for="Kubernetes/Kubernetes">Kubernetes</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="linux"><button class="folder-button"><span class="folder-title">linux</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="linux"><li><a href="../../linux/Linux-基础知识总结" data-for="linux/Linux-基础知识总结">Linux 基础知识总结</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="lua"><button class="folder-button"><span class="folder-title">lua</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="lua"><li><a href="../../lua/lua" data-for="lua/lua">lua基础</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="MySQL"><button class="folder-button"><span class="folder-title">MySQL</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="MySQL"><li><a href="../../MySQL/MySQL" data-for="MySQL/MySQL">MySQL</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Obsidian"><button class="folder-button"><span class="folder-title">Obsidian</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Obsidian"><li><a href="../../Obsidian/dataview" data-for="Obsidian/dataview">dataview</a></li><li><a href="../../Obsidian/excalidraw" data-for="Obsidian/excalidraw">excalidraw</a></li><li><a href="../../Obsidian/Front-Matter" data-for="Obsidian/Front-Matter">Front Matter</a></li><li><a href="../../Obsidian/obsidian-overview" data-for="Obsidian/obsidian-overview">obsidian overview</a></li><li><a href="../../Obsidian/Obsidian-plugin" data-for="Obsidian/Obsidian-plugin">Obsidian-plugin</a></li><li><a href="../../Obsidian/publish" data-for="Obsidian/publish">publish</a></li><li><a href="../../Obsidian/template" data-for="Obsidian/template">template</a></li><li><a href="../../Obsidian/使用quartz发布obsidian--vault" data-for="Obsidian/使用quartz发布obsidian--vault">使用quartz发布obsidian  vault</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Python"><button class="folder-button"><span class="folder-title">Python</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Python"><li><a href="../../Python/python" data-for="Python/python">python</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="Redis"><button class="folder-button"><span class="folder-title">Redis</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="Redis"><li><a href="../../Redis/Redis" data-for="Redis/Redis">★Redis</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="shell"><button class="folder-button"><span class="folder-title">shell</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="shell"><li><a href="../../shell/shell" data-for="shell/shell">shell overview</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="工具"><button class="folder-button"><span class="folder-title">工具</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="工具"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="工具/emacs"><button class="folder-button"><span class="folder-title">emacs</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="工具/emacs"><li><a href="../../工具/emacs/安装" data-for="工具/emacs/安装">安装</a></li><li><a href="../../工具/emacs/快捷键" data-for="工具/emacs/快捷键">快捷键</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="工具/git"><button class="folder-button"><span class="folder-title">git</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="工具/git"><li><a href="../../工具/git/git" data-for="工具/git/git">git</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="工具/maven"><button class="folder-button"><span class="folder-title">maven</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="工具/maven"><li><a href="../../工具/maven/maven基础" data-for="工具/maven/maven基础">maven基础</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="工具/msys2"><button class="folder-button"><span class="folder-title">msys2</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="工具/msys2"><li><a href="../../工具/msys2/pacman" data-for="工具/msys2/pacman">pacman</a></li><li><a href="../../工具/msys2/再-msys-中使用fish" data-for="工具/msys2/再-msys-中使用fish">再 msys 中使用fish</a></li></ul></div></li><li><a href="../../工具/工具" data-for="工具/工具">工具</a></li><li><a href="../../工具/环境搭建" data-for="工具/环境搭建">环境搭建</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="微服务"><button class="folder-button"><span class="folder-title">微服务</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="微服务"><li><a href="../../微服务/微服务" data-for="微服务/微服务">微服务</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="消息队列"><button class="folder-button"><span class="folder-title">消息队列</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="消息队列"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="消息队列/Kafka"><button class="folder-button"><span class="folder-title">Kafka</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="消息队列/Kafka"><li><a href="../../消息队列/Kafka/Kafka-Broker" data-for="消息队列/Kafka/Kafka-Broker">Kafka Broker</a></li><li><a href="../../消息队列/Kafka/Kafka-快速入门" data-for="消息队列/Kafka/Kafka-快速入门">Kafka 快速入门</a></li><li><a href="../../消息队列/Kafka/Kafka-消费者" data-for="消息队列/Kafka/Kafka-消费者">Kafka 消费者</a></li><li><a href="../../消息队列/Kafka/Kafka-生产者" data-for="消息队列/Kafka/Kafka-生产者">Kafka 生产者</a></li><li><a href="../../消息队列/Kafka/Spring-整合-Kafka" data-for="消息队列/Kafka/Spring-整合-Kafka">Spring 整合 Kafka</a></li></ul></div></li><li><a href="../../消息队列/消息队列" data-for="消息队列/消息队列">消息队列</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="编译原理"><button class="folder-button"><span class="folder-title">编译原理</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="编译原理"><li><a href="../../编译原理/编译原理" data-for="编译原理/编译原理">编译原理</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="资源"><button class="folder-button"><span class="folder-title">资源</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="资源"><li><a href="../../资源/资源汇总" data-for="资源/资源汇总">资源汇总</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="高可用"><button class="folder-button"><span class="folder-title">高可用</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="高可用"><li><a href="../../高可用/高可用" data-for="高可用/高可用">高可用</a></li></ul></div></li></ul></div></li><li id="explorer-end"></li></ul></div></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../../">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../../消息队列/">消息队列</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../../消息队列/Kafka/">Kafka</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>Kafka Broker</a></div></nav><h1 class="article-title">Kafka Broker</h1><p show-comma="true" class="content-meta"><span>2024年3月22日</span><span>25分钟阅读</span></p></div></div><article class="popover-hint"><h2 id="第-4-章-kafka-broker">第 4 章 Kafka Broker<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#第-4-章-kafka-broker" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<h1 id="broker设计">Broker设计<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#broker设计" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<p>​ 我们都知道kafka能堆积非常大的数据，一台服务器，肯定是放不下的。由此出现的集群的概念，集群不仅可以让消息负载均衡，还能提高消息存取的吞吐量。kafka集群中，会有多台broker，每台broker分别在不同的机器上。
​ 为了提高吞吐量，每个topic也会都多个分区，同时为了保持可靠性，每个分区还会有多个副本。这些分区副本被均匀的散落在每个broker上，其中每个分区副本中有一个副本为leader，其他的为follower。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902195939625.png" alt="image-20220902195939625"/></p>
<h1 id="zookeeper">Zookeeper<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#zookeeper" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="zookeeper作用">Zookeeper作用<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#zookeeper作用" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Zookeeper在Kafka中扮演了重要的角色，kafka使用zookeeper进行元数据管理，保存broker注册信息，包括主题（Topic）、分区（Partition）信息等，选择分区leader。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902200249692.png" alt="image-20220902200249692"/></p>
<h2 id="broker选举leader">Broker选举Leader<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#broker选举leader" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>​ 这里需要先明确一个概念leader选举，因为kafka中涉及多处选举机制，容易搞混，Kafka由三个方面会涉及到选举：</p>
<ul>
<li>broker（控制器）选leader</li>
<li>分区多副本选leader</li>
<li>消费者选Leader</li>
</ul>
<p>​ 在kafka集群中由很多的broker（也叫做控制器），但是他们之间需要选举出一个leader，其他的都是follower。broker的leader有很重要的作用，诸如：创建、删除主题、增加分区并分配leader分区；集群broker管理，包括新增、关闭和故障处理；分区重分配（auto.leader.rebalance.enable=true，后面会介绍），分区leader选举。</p>
<p>​ 每个broker都有唯一的brokerId，他们在启动后会去竞争注册zookeeper上的Controller结点，谁先抢到，谁就是broker leader。而其他broker会监听该结点事件，以便后续leader下线后触发重新选举。</p>
<p>简图：</p>
<ul>
<li>broker（控制器）选leader</li>
</ul>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902200901222.png" alt="image-20220902200901222"/></p>
<p>详细图：</p>
<ul>
<li>broker（控制器）选leader</li>
<li>分区多副本选leader</li>
</ul>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902201352868.png" alt="image-20220902201352868"/></p>
<p><strong>模拟 Kafka 上下线，Zookeeper 中数据变化</strong></p>
<p>（1）查看/kafka/brokers/ids 路径上的节点。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[zk: localhost:2181(CONNECTED) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] ls /kafka/brokers/ids</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></figure>
<p>（2）查看/kafka/controller 路径上的数据。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[zk: localhost:2181(CONNECTED) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] get /kafka/controller</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;version&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;brokerid&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:0,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;timestamp&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;1637292471777&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">}</span></span></code></pre></figure>
<p>（3）查看/kafka/brokers/topics/first/partitions/0/state 路径上的数据。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[zk: localhost:2181(CONNECTED) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] get  /kafka/brokers/topics/first/partitions/0/state</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;controller_epoch&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:24,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;leader&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:0,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;version&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;leader_epoch&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:18,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot; isr&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[0,1,2]}</span></span></code></pre></figure>
<p>（4）停止 hadoop104 上的 kafka。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-server-stop.sh</span></span></code></pre></figure>
<p>（5）再次查看/kafka/brokers/ids 路径上的节点。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[zk: localhost:2181(CONNECTED) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] ls /kafka/brokers/ids</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></figure>
<p>（6）再次查看/kafka/controller 路径上的数据。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[zk: localhost:2181(CONNECTED) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] get /kafka/controller</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;version&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;brokerid&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:0,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;timestamp&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;1637292471777&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">}</span></span></code></pre></figure>
<p>（7）再次查看/kafka/brokers/topics/first/partitions/0/state 路径上的数据。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[zk: localhost:2181(CONNECTED) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] get  /kafka/brokers/topics/first/partitions/0/state</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;controller_epoch&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:24,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;leader&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:0,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;version&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;leader_epoch&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:18,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot; isr&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[0,1]}</span></span></code></pre></figure>
<p>（8）启动 hadoop104 上的 kafka。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-server-start.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -daemon</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./config/server.properties</span></span></code></pre></figure>
<p>（9）再次观察（1）、（2）、（3）步骤中的内容。</p>
<h2 id="broker重要参数">Broker重要参数<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#broker重要参数" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902203152370.png" alt="image-20220902203152370"/></p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902203207882.png" alt="image-20220902203207882"/></p>
<h1 id="节点服役和退役">节点服役和退役<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#节点服役和退役" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="服役新节点">服役新节点<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#服役新节点" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>(1) 启动一台新的KafKa服务端（加入原有的Zookeeper集群）</p>
<p>(2) 查看原有的 分区信息 describe</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --describe</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	TopicId:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DtkHPe4R1KyXNF7QyVqBA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	PartitionCount:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	ReplicationFactor:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Configs:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> segment.bytes=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1073741824</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0</span></span></code></pre></figure>
<p>(3) 指定需要均衡的主题</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> topics-to-move.json</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="json" data-theme="github-light github-dark"><code data-language="json" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> &quot;topics&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;topic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;first&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ],</span></span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span data-line> </span></code></pre></figure>
<p>(4) 生成负载均衡计划(只是生成计划)</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bin/kafka-reassign-partitions.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topics-to-move-json-file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> topics-to-move.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --broker-list</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0,1,2,3&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --generate</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Current</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> partition</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replica</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> assignment</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;version&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;partitions&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">topic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">partition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:0,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replic</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[0,2,1],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]},{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">topic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">par</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:1,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicas</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[2,1,0],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]},{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">partition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:2,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicas</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[1,0,2],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]}]}</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Proposed partition reassignment configuration</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">version</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:1,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">partitions</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">topic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">partition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:0,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replic</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[2,3,0],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]},{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">topic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">par</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:1,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicas</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[3,0,1],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]},{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">partition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:2,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicas</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[0,1,2],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]}]}</span></span></code></pre></figure>
<p>（3）创建副本存储计划（所有副本存储在 broker0、broker1、broker2、broker3 中）。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> increase-replication-factor.json</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;version&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;partitions&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">topic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">partition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:0,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replic</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[2,3,0],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]},{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">topic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">par</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:1,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicas</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[3,0,1],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]},{&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">to</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pic</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">first</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">partition</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:2,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">replicas</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[0,1,2],&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_dirs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;:[&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;,&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;]}]}</span></span></code></pre></figure>
<p>(5) 执行副本计划</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-reassign-partitions.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --reassignment-json-file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> increase-replication-factor.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --execute</span></span></code></pre></figure>
<p>(6) 验证计划</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-reassign-partitions.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --reassignment-json-file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> increase-replication-factor.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --verify</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Status</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> partition</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> reassignment:</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Reassignment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> partition</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first-0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> complete.</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Reassignment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> partition</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first-1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> complete.</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Reassignment</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> partition</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first-2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> complete.</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Clearing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> broker-level</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> throttles</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> brokers</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2,3</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Clearing</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> topic-level</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> throttles</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> first</span></span></code></pre></figure>
<h2 id="退役旧节点">退役旧节点<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#退役旧节点" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><strong>1）执行负载均衡操作</strong><br/>
先按照退役一台节点，生成执行计划，然后按照服役时操作流程执行负载均衡。</p>
<p>不同于服役计划的 <code>--broker-list &quot;0,1,2&quot;</code> 退役了 Broker3 ；</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-reassign-partitions.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topics-to-move-json-file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> topics-to-move.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --broker-list</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;0,1,2&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --generate</span></span></code></pre></figure>
<h1 id="副本机制">副本机制<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#副本机制" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="副本基本信息">副本基本信息<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#副本基本信息" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ul>
<li><strong>Replica</strong> ：副本，同一分区的不同副本保存的是相同的消息，为保证集群中的某个节点发生故障时，该节点上的 partition <strong>数据不丢失 ，提高副本可靠性</strong>，且 kafka 仍然能够继续工作，kafka 提供了副本机制，一个 topic 的每个分区都有若干个副本，一个 leader 和若干个 follower。</li>
<li><strong>Leader</strong> ：每个分区的多个副本中的”主副本”，生产者以及消费者<strong>只与 Leader 交互</strong>。</li>
<li><strong>Follower</strong> ：每个分区的多个副本中的”从副本”，负责实时从 Leader 中同步数据，保持和 Leader 数据的同步。Leader 发生故障时，从 Follower 副本中重新选举新的 Leader 副本对外提供服务。</li>
</ul>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902201925254.png" alt="image-20220902201925254"/></p>
<ul>
<li><strong>AR</strong>:分区中的所有 Replica 统称为 AR = ISR +OSR</li>
<li><strong>ISR</strong>:所有与 Leader 副本保持一定程度同步的Replica(包括 Leader 副本在内)组成 ISR</li>
<li><strong>OSR</strong>:与 Leader 副本同步滞后过多的 Replica 组成了 OSR</li>
<li><strong>LEO</strong>:每个副本都有内部的LEO，代表当前队列消息的最后一条偏移量offset + 1。</li>
<li><strong>HW</strong>:高水位，代表所有ISR中的LEO最低的那个offset，也是消费者可见的最大消息offset。</li>
</ul>
<h2 id="副本选举leader">副本选举Leader<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#副本选举leader" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>​ Kafka 集群中有一个 broker 的 Controller 会被选举为 Controller Leader (4.2.2) ，负责管理集群Broker 的上下线，所有 topic 的分区副本分配和 Leader 选举等工作。</p>
<p>​ Broker中Controller 的信息同步工作是依赖于 Zookeeper 的 ./broker/topic 目录下的信息。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902205616764.png" alt="image-20220902205616764"/></p>
<p><strong>结论先行： 如果leader副本下线， 会在ISR队列中存活为前提，按照Replicas队列中前面优先的原则。</strong></p>
<p>↓↓↓</p>
<p>（1）创建一个新的 topic，4 个分区，4 个副本</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --partitions</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --replication-factor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span></code></pre></figure>
<p>（2）查看 Leader 分布情况</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --describe</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TopicId:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> awpgX_7WR-OX3Vl6HE8sVg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PartitionCount:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ReplicationFactor:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Configs:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> segment.bytes=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1073741824</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,2,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,2,1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3,0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,1,2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,1,2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,0,3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,0,3</span></span></code></pre></figure>
<p>（3）停止掉 hadoop105 的 kafka 进程，并查看 Leader 分区情况</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-server-stop.sh</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --describe</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TopicId:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> awpgX_7WR-OX3Vl6HE8sVg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PartitionCount:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ReplicationFactor:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Configs:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> segment.bytes=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1073741824</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,2,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,1,2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,0,3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,0</span></span></code></pre></figure>
<p>（4）停止掉 hadoop104 的 kafka 进程，并查看 Leader 分区情况</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-server-stop.sh</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --describe</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TopicId:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> awpgX_7WR-OX3Vl6HE8sVg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PartitionCount:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ReplicationFactor:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Configs:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> segment.bytes=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1073741824</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,2,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,1,2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> atguigu1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,0,3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0</span></span></code></pre></figure>
<h2 id="副本故障处理">副本故障处理<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#副本故障处理" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<h3 id="follower故障流程"><strong>follower故障流程</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#follower故障流程" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>如果follower落后leader过多，体现在<strong>落后时间</strong> repca.lag.time.max.ms ，或者<strong>落后偏移量</strong>repca.lag.max.messages(由于kafka生成速度不好界定，后面取消了该参数)，follower就会被移除ISR队列，等待该队列LEO追上HW，才会重新加入ISR中。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902210759125.png" alt="image-20220902210759125"/></p>
<h3 id="leader故障流程">leader故障流程<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#leader故障流程" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>旧Leader先被从ISR队列中踢出，然后从ISR中选出一个新的Leader来；此时为了保证多个副本之间的数据一致性，其他的follower会先将各自的log文件中<strong>高于HW的部分截取掉</strong>，然后从新的leader同步数据（由此可知这只能保证副本之间数据一致性，并不能保证数据不丢失或者不重复）。体现了设置ACK-all的重要性。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902210830344.png" alt="image-20220902210830344"/></p>
<h2 id="分区副本分配">分区副本分配<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#分区副本分配" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>如果 kafka 服务器只有 4 个节点，那么设置 kafka 的分区数大于服务器台数，在 kafka底层如何分配存储副本呢？<br/>
1）创建 16 分区，3 个副本<br/>
（1）创建一个新的 topic，名称为 second。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --partitions</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 16</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --replication-factor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second</span></span></code></pre></figure>
<p>（2）查看分区和副本情况。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --describe</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,1</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,3</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 12</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,1,2</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,2,3</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,3,0</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Topic:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> second4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Partition:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 15</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Leader:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Isr:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,0,1</span></span>
<span data-line> </span></code></pre></figure>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902211334365.png" alt="image-20220902211334365"/></p>
<h2 id="手动调整分区副本">手动调整分区副本<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#手动调整分区副本" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902211501656.png" alt="image-20220902211501656"/></p>
<p>手动调整分区副本存储的步骤如下：<br/>
（1）创建一个新的 topic，名称为 three。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --partitions</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --replication-factor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> three</span></span></code></pre></figure>
<p>（3）创建副本存储计划（所有副本都指定存储在 broker0、broker1 中）。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> increase-replication-factor.json</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">输入如下内容：</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;version&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:1,</span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;partitions&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;topic&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;three&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;partition&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:0,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;replicas&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[0,1]}</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;topic&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;three&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;partition&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;replicas&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[0,1]}</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;topic&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;three&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;partition&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:2,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;replicas&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[1,0]}</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;topic&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;three&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;partition&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:3,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;replicas&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[1,0]}</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p>（4）执行副本存储计划。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-reassign-partitions.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --reassignment-json-file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> increase-replication-factor.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --execute</span></span></code></pre></figure>
<p>（5）验证副本存储计划。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-reassign-partitions.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --reassignment-json-file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> increase-replication-factor.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --verify</span></span></code></pre></figure>
<h2 id="分区自动调整"><strong>分区自动调整</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#分区自动调整" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>​ 一般情况下，我们的分区都是平衡散落在broker的，随着一些broker故障，会慢慢出现leader集中在某台broker上的情况，造成集群负载不均衡，这时候就需要分区平衡。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902212238315.png" alt="image-20220902212238315"/></p>
<p>为了解决上述问题kafka出现了自动平衡的机制。kafka提供了下面几个参数进行控制：</p>
<ul>
<li><code>auto.leader.rebalance.enable</code>：自动leader parition平衡，默认是true;</li>
<li><code>leader.imbalance.per.broker.percentage</code>：每个broker允许的不平衡的leader的比率，默认是10%，如果超过这个值，控制器将会触发leader的平衡</li>
<li><code>leader.imbalance.check.interval.seconds</code>：检查leader负载是否平衡的时间间隔，默认是300秒</li>
<li>但是在生产环境中是不开启这个自动平衡，因为触发leader partition的自动平衡会损耗性能，或者可以将触发自动平和的参数<code>leader.imbalance.per.broker.percentage</code>的值调大点。</li>
</ul>
<p>我们也可以通过修改配置，然后手动触发分区的再平衡。</p>
<h2 id="增加副本因子">增加副本因子<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#增加副本因子" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>在生产环境当中，由于某个主题的重要等级需要提升，我们考虑增加副本。副本数的增加需要先制定计划，然后根据计划执行。<br/>
不能通过命令行的方法添加副本。<br/>
1）创建 topic</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bin/kafka-topics.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --partitions</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --replication-factor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> four</span></span></code></pre></figure>
<p>2）手动增加副本存储<br/>
（1）创建副本存储计划（所有副本都指定存储在 broker0、broker1、broker2 中）。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> increase-replication-factor.json</span></span></code></pre></figure>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="json" data-theme="github-light github-dark"><code data-language="json" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;partitions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;topic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;four&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;partition&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;replicas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]},</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;topic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;four&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;partition&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;replicas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]},</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;topic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;four&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;partition&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;replicas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]}]}</span></span></code></pre></figure>
<p>（2）执行副本存储计划。</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-reassign-partitions.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bootstrap-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 47.106</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.86.64:9092</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --reassignment-json-file</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> increase-replication-factor.json</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --execute</span></span></code></pre></figure>
<h1 id="文件存储">文件存储<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#文件存储" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<h2 id="存储结构"><strong>存储结构</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#存储结构" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>在Kafka中主题（Topic）是一个逻辑上的概念，分区（partition）是物理上的存在的。每个partition对应一个log文件，该log文件中存储的就是Producer生产的数据。Producer生产的数据会被不断追加到该log文件末端。为防止log文件过大导致数据定位效率低下，Kafka采用了分片和索引机制，将每个partition分为多个segment，每个segment默认1G（ <code>log.segment.bytes</code> ）， 每个segment包括.<strong>index</strong>文件、<strong>.log</strong>文件和**.timeindex**等文件。这些文件位于文件夹下，该文件命名规则为：topic名称+分区号。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902213237928.png" alt="image-20220902213237928"/></p>
<p>Segment的三个文件需要通过特定工具打开才能看到信息</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="shell" data-theme="github-light github-dark"><code data-language="shell" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-run-class.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kafka.tools.DumpLogSegments</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --files</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./00000000000000000000.index</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kafka-run-class.sh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kafka.tools.DumpLogSegments</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --files</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./00000000000000000000.log</span></span></code></pre></figure>
<p>​ 当log文件写入4k（这里可以通过<code>log.index.interval.bytes</code>设置）数据，就会写入一条索引信息到index文件中，这样的index索引文件就是一个<strong>稀疏索引</strong>，它并不会每条日志都建立索引信息。</p>
<p>​ 当Kafka查询一条offset对应实际消息时，可以通过index进行二分查找，获取最近的低位offset，然后从低位offset对应的position开始，从实际的log文件中开始往后查找对应的消息。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902213631039.png" alt="image-20220902213631039"/></p>
<p><code>时间戳索引文件</code>，它的作用是可以查询某一个时间段内的消息，它的数据结构是：时间戳（8byte）+ 相对offset（4byte），如果要使用这个索引文件，先要通过时间范围找到对应的offset，然后再去找对应的index文件找到position信息，最后在遍历log文件，这个过程也是需要用到index索引文件的。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902213600127.png" alt="image-20220902213600127"/></p>
<h2 id="文件清理策略">文件清理策略<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#文件清理策略" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>​ Kafka将消息存储在磁盘中，为了控制磁盘占用空间的不断增加就需要对消息做一定的清理操作。Kafka 中每一个分区副本都对应一个Log，而Log又可以分为多个日志分段，这样也便于日志的清理操作。Kafka提供了两种日志清理策略。</p>
<ol>
<li>日志删除(delete) :按照一定的保留策略直接删除不符合条件的日志分段。</li>
<li>日志压缩(compact) :针对每个消息的key进行整合，对于有相同key的不同value值，只保留最后一个版本。</li>
</ol>
<p>我们可以通过修改broker端参数 <code>log.cleanup.policy</code> 来进行配置</p>
<h3 id="日志删除">日志删除<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#日志删除" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>kafka中默认的日志保存时间为7天，可以通过调整如下参数修改保存时间。</p>
<ul>
<li><code>log.retention.hours</code>：最低优先级小时，默认7天</li>
<li><code>log.retention.minutes</code>：分钟</li>
<li><code>log.retention.ms</code>：最高优先级毫秒</li>
<li><code>log.retention.check.interval.ms</code>：负责设置检查周期，默认5分钟</li>
<li><code>file.delete.delay.ms</code>：延迟执行删除时间</li>
<li><code>log.retention.bytes</code>：当设置为-1时表示运行保留日志最大值（相当于关闭）；当设置为1G时，表示日志文件最大值</li>
</ul>
<p>具体的保留日志策略有三种：</p>
<p><strong>基于时间策略</strong></p>
<p>​ 日志删除任务会周期检查当前日志文件中是否有保留时间超过设定的阈值来寻找可删除的日志段文件集合；这里需要注意log.retention参数的优先级：<code>log.retention.ms > log.retention.minutes > log.retention.hours</code>，默认只会配置log.retention.hours参数，值为168即为<strong>7</strong>天。</p>
<p>​ 删除过期的日志段文件，并不是简单的根据日志段文件的修改时间计算，而是要根据该日志段中最大的时间戳来计算的，首先要查询该日志分段所对应的时间戳索引文件，查找该时间戳索引文件的最后一条索引数据，如果时间戳大于0就取值，否则才会使用最近修改时间。</p>
<p>​ 在删除的时候先从Log对象所维护的日志段的跳跃表中移除要删除的日志段，用来确保已经没有线程来读取这些日志段；接着将日志段所对应的所有文件，包括索引文件都添加上**.deleted<strong>的后缀；最后交给一个以</strong>delete-file<strong>命名的延迟任务来删除这些以</strong>.deleted<strong>为后缀的文件，默认是1分钟执行一次，可以通过</strong>file.delete.delay.ms**来配置。</p>
<p><strong>基于日志大小策略</strong></p>
<p>日志删除任务会周期性检查当前日志大小是否超过设定的阈值（log.retention.bytes，默认是-1，表示无穷大），就从第一个日志分段中寻找可删除的日志段文件集合。如果超过阈值，</p>
<p><strong>基于日志起始偏移量</strong></p>
<p>该策略判断依据是日志段的下一个日志段的起始偏移量 baseOffset是否小于等于 logStartOffset，如果是，则可以删除此日志分段。这里说一下logStartOffset，一般情况下，日志文件的起始偏移量 logStartOffset等于第一个日志分段的 baseOffset，但这并不是绝对的，logStartOffset的值可以通过 <strong>DeleteRecordsRequest</strong>请求、使用 <strong>kafka-delete-records.sh 脚本、日志的清理和截断</strong>等操作进行修改。</p>
<h3 id="日志压缩">日志压缩<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#日志压缩" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>​ 日志压缩对于有相同key的不同value值，只保留最后一个版本。如果应用只关心 key对应的最新 value值，则可以开启 Kafka相应的日志清理功能，Kafka会定期将相同 key的消息进行合并，只保留最新的 value值。</p>
<ul>
<li>log.cleanup.policy = compact 所有数据启用压缩策略</li>
</ul>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902214504699.png" alt="image-20220902214504699"/></p>
<p>​ 这种策略只适合特殊场景，比如消息的key是用户ID，value是用户的资料，通过这种压缩策略，整个消息集里就保存了所有用户最新的资料。</p>
<h1 id="kafka高效读数据"><strong>Kafka高效读数据</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#kafka高效读数据" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<p>kafka之所以可以快速读写的原因如下：</p>
<ol>
<li>kafka是分布式集群，采用分区方式，并行操作</li>
<li>读取数据采用稀疏索引，可以快速定位消费数据</li>
<li>顺序写磁盘</li>
<li>页缓冲和零拷贝</li>
</ol>
<h2 id="顺序写磁盘">顺序写磁盘<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#顺序写磁盘" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Kafka 的 producer 生产数据，要写入到 log 文件中，写的过程是一直追加到文件末端，为顺序写。<strong>官网有数据表明</strong>，同样的磁盘，顺序写能到 600M/s，而随机写只有 100K/s。这与磁盘的机械机构有关，顺序写之所以快，是因为其省去了大量磁头寻址的时间。</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902214803709.png" alt="image-20220902214803709"/></p>
<h2 id="页缓存与零拷贝">页缓存与零拷贝<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#页缓存与零拷贝" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>kafka高效读写的原因很大一部分取决于<strong>页缓存</strong>和<strong>零拷贝</strong></p>
<h3 id="页缓存"><strong>页缓存</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#页缓存" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>在 Kafka 中，大量使用了 <code>PageCache</code>， 这也是 Kafka 能实现高吞吐的重要因素之一。</p>
<p>​ 首先看一下读操作，当一个进程要去读取磁盘上的文件内容时，操作系统会先查看要读取的数据页是否缓冲在<code>PageCache</code> 中，如果存在则直接返回要读取的数据，这就减少了对于磁盘 I/O的 操作；但是如果没有查到，操作系统会向磁盘发起读取请求并将读取的数据页存入 <code>PageCache</code> 中，之后再将数据返回给进程，就和使用redis缓冲是一个道理。</p>
<p>​ 接着写操作和读操作是一样的，如果一个进程需要将数据写入磁盘，操作系统会检查数据页是否在PageCache 中已经存在，如果不存在就在 PageCache中添加相应的数据页，接着将数据写入对应的数据页。另外被修改过后的数据页也就变成了脏页，操作系统会在适当时间将脏页中的数据写入磁盘，以保持数据的一致性。</p>
<p>​ 具体的刷盘机制可以通过 <code>log.flush.interval messages</code>，<code>log.flush .interval .ms</code> 等参数来控制。同步刷盘可以提高消息的可靠性，防止由于机器 掉电等异常造成处于页缓存而没有及时写入磁盘的消息丢失。一般并不建议这么做，刷盘任务就应<strong>交由操作系统去调配</strong>，消息的可靠性应该由多副本机制来保障，而不是由同步刷盘这 种严重影响性能的行为来保障 。</p>
<h3 id="零拷贝"><strong>零拷贝</strong><a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#零拷贝" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>零拷贝并不是不需要拷贝，而是减少不必要的拷贝次数，通常使用在IO读写过程中。常规应用程序IO过程如下图，会经过四次拷贝：</p>
<ol>
<li>数据从磁盘经过DMA(直接存储器访问)到内核的Read Buffer；</li>
<li>内核态的Read Buffer到用户态应用层的Buffer</li>
<li>用户态的Buffer到内核态的Socket Buffer</li>
<li>Socket Buffer到网卡的NIC Buffer</li>
</ol>
<p>​ 从上面的流程可以知道内核态和用户态之间的拷贝相当于执行两次无用的操作，之间切换也会花费很多资源；当数据从磁盘经过DMA 拷贝到内核缓存（页缓存）后，为了减少CPU拷贝的性能损耗，操作系统会将该内核缓存与用户层进行共享，减少一次CPU copy过程，同时用户层的读写也会直接访问该共享存储，本身由用户层到Socket缓存的数据拷贝过程也变成了从内核到内核的CPU拷贝过程，更加的快速，这就是零拷贝，IO流程如下图。</p>
<p>甚至如果我们的消息存在页缓存<code>PageCache</code>中，还避免了硬盘到内核的拷贝过程，更加一步提升了消息的吞吐量。 (大概就理解成传输的数据只保存在内核空间，不需要再拷贝到用户态的应用层)</p>
<p><img src="https://googoo-s.oss-cn-chengdu.aliyuncs.com/statisticimage-20220902214906599.png" alt="image-20220902214906599"/></p>
<hr/>
<p>Java的JDK NIO中方法transferTo()方法就能够实现零拷贝操作，这个实现依赖于操作系统底层的sendFile()实现的</p></article></div><div class="right sidebar"><div class="toc desktop-only"><button type="button" id="toc" class><h3>目录</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content"><ul class="overflow"><li class="depth-1"><a href="#第-4-章-kafka-broker" data-for="第-4-章-kafka-broker">第 4 章 Kafka Broker</a></li><li class="depth-0"><a href="#broker设计" data-for="broker设计">Broker设计</a></li><li class="depth-0"><a href="#zookeeper" data-for="zookeeper">Zookeeper</a></li><li class="depth-1"><a href="#zookeeper作用" data-for="zookeeper作用">Zookeeper作用</a></li><li class="depth-1"><a href="#broker选举leader" data-for="broker选举leader">Broker选举Leader</a></li><li class="depth-1"><a href="#broker重要参数" data-for="broker重要参数">Broker重要参数</a></li><li class="depth-0"><a href="#节点服役和退役" data-for="节点服役和退役">节点服役和退役</a></li><li class="depth-1"><a href="#服役新节点" data-for="服役新节点">服役新节点</a></li><li class="depth-1"><a href="#退役旧节点" data-for="退役旧节点">退役旧节点</a></li><li class="depth-0"><a href="#副本机制" data-for="副本机制">副本机制</a></li><li class="depth-1"><a href="#副本基本信息" data-for="副本基本信息">副本基本信息</a></li><li class="depth-1"><a href="#副本选举leader" data-for="副本选举leader">副本选举Leader</a></li><li class="depth-1"><a href="#副本故障处理" data-for="副本故障处理">副本故障处理</a></li><li class="depth-2"><a href="#follower故障流程" data-for="follower故障流程">follower故障流程</a></li><li class="depth-2"><a href="#leader故障流程" data-for="leader故障流程">leader故障流程</a></li><li class="depth-1"><a href="#分区副本分配" data-for="分区副本分配">分区副本分配</a></li><li class="depth-1"><a href="#手动调整分区副本" data-for="手动调整分区副本">手动调整分区副本</a></li><li class="depth-1"><a href="#分区自动调整" data-for="分区自动调整">分区自动调整</a></li><li class="depth-1"><a href="#增加副本因子" data-for="增加副本因子">增加副本因子</a></li><li class="depth-0"><a href="#文件存储" data-for="文件存储">文件存储</a></li><li class="depth-1"><a href="#存储结构" data-for="存储结构">存储结构</a></li><li class="depth-1"><a href="#文件清理策略" data-for="文件清理策略">文件清理策略</a></li><li class="depth-2"><a href="#日志删除" data-for="日志删除">日志删除</a></li><li class="depth-2"><a href="#日志压缩" data-for="日志压缩">日志压缩</a></li><li class="depth-0"><a href="#kafka高效读数据" data-for="kafka高效读数据">Kafka高效读数据</a></li><li class="depth-1"><a href="#顺序写磁盘" data-for="顺序写磁盘">顺序写磁盘</a></li><li class="depth-1"><a href="#页缓存与零拷贝" data-for="页缓存与零拷贝">页缓存与零拷贝</a></li><li class="depth-2"><a href="#页缓存" data-for="页缓存">页缓存</a></li><li class="depth-2"><a href="#零拷贝" data-for="零拷贝">零拷贝</a></li></ul></div></div><div class="backlinks"><h3>反向链接</h3><ul class="overflow"><li><a href="../../消息队列/消息队列" class="internal">消息队列</a></li></ul></div><div class="graph"><h3>关系图谱</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><svg version="1.1" id="global-graph-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
	s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
	c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
	C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
	c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
	v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
	s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
	C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
	S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
	s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
	s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div></div></div><footer class><hr/><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.2.3</a> © 2024</p><ul><li><a href="https://github.com/googoo-s">GitHub</a></li></ul></footer></div></body><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js" type="application/javascript"></script><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script type="module">
          let mermaidImport = undefined
          document.addEventListener('nav', async () => {
            if (document.querySelector("code.mermaid")) {
              mermaidImport ||= await import('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs')
              const mermaid = mermaidImport.default
              const darkMode = document.documentElement.getAttribute('saved-theme') === 'dark'
              mermaid.initialize({
                startOnLoad: false,
                securityLevel: 'loose',
                theme: darkMode ? 'dark' : 'default'
              })

              await mermaid.run({
                querySelector: '.mermaid'
              })
            }
          });
          </script><script src="../../postscript.js" type="module"></script></html>