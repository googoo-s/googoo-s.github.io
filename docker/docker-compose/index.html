<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="docker compose æ–‡æ¡£
Compose æ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚é€šè¿‡ Composeï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ YML æ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºéœ€è¦çš„æ‰€æœ‰æœåŠ¡ã€‚ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥ä» YML æ–‡ä»¶é…ç½®ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚
Compose ä½¿ç”¨çš„ä¸‰ä¸ªæ­¥éª¤ï¼š
  ä½¿ç”¨ Dockerfile å®šä¹‰åº”ç”¨ç¨‹åºçš„ç¯å¢ƒã€‚"><meta property="og:title" content><meta property="og:description" content="docker compose æ–‡æ¡£
Compose æ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚é€šè¿‡ Composeï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ YML æ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºéœ€è¦çš„æ‰€æœ‰æœåŠ¡ã€‚ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥ä» YML æ–‡ä»¶é…ç½®ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚
Compose ä½¿ç”¨çš„ä¸‰ä¸ªæ­¥éª¤ï¼š
  ä½¿ç”¨ Dockerfile å®šä¹‰åº”ç”¨ç¨‹åºçš„ç¯å¢ƒã€‚"><meta property="og:type" content="website"><meta property="og:image" content="https://quartz.jzhao.xyz/icon.png"><meta property="og:url" content="https://quartz.jzhao.xyz/docker/docker-compose/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="docker compose æ–‡æ¡£
Compose æ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚é€šè¿‡ Composeï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ YML æ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºéœ€è¦çš„æ‰€æœ‰æœåŠ¡ã€‚ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥ä» YML æ–‡ä»¶é…ç½®ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚
Compose ä½¿ç”¨çš„ä¸‰ä¸ªæ­¥éª¤ï¼š
  ä½¿ç”¨ Dockerfile å®šä¹‰åº”ç”¨ç¨‹åºçš„ç¯å¢ƒã€‚"><meta name=twitter:image content="https://quartz.jzhao.xyz/icon.png"><meta name=twitter:site content="_jzhao"><title>ğŸª´ Quartz 3.3</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://quartz.jzhao.xyz//icon.png><link href=https://quartz.jzhao.xyz/styles.19109a40042e9f0e72e952fda4442a34.min.css rel=stylesheet><link href=https://quartz.jzhao.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://quartz.jzhao.xyz/js/darkmode.63d6a3e095d0bd2b935b62adec9dc11b.min.js></script>
<script src=https://quartz.jzhao.xyz/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script defer src=https://quartz.jzhao.xyz/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://quartz.jzhao.xyz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://quartz.jzhao.xyz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://quartz.jzhao.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://quartz.jzhao.xyz/",fetchData=Promise.all([fetch("https://quartz.jzhao.xyz/indices/linkIndex.26897e4d1acf67c094aa607e8f2e6316.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://quartz.jzhao.xyz/indices/contentIndex.fd0b08e0fcf0fc58c8d873581bcb40dd.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://quartz.jzhao.xyz",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://quartz.jzhao.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/quartz.jzhao.xyz\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=quartz.jzhao.xyz src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://quartz.jzhao.xyz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://quartz.jzhao.xyz/>ğŸª´ Quartz 3.3</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/docker/docker%20compose.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#å‡†å¤‡>å‡†å¤‡</a></li><li><a href=#dockerfile>Dockerfile</a></li><li><a href=#docker-composeyml>docker-compose.yml</a></li></ol><ol><li><a href=#docker-composeymlçš„é…ç½®>docker-compose.ymlçš„é…ç½®</a></li><li><a href=#version>version</a></li><li><a href=#build>build</a></li><li><a href=#network>network</a><ol><li><a href=#ä¸€çº§networksè¿˜æœ‰å¦‚ä¸‹è¿™äº›é…ç½®>ä¸€çº§networksè¿˜æœ‰å¦‚ä¸‹è¿™äº›é…ç½®ï¼š</a></li></ol></li><li><a href=#cap_add-cap_drop>cap_add, cap_drop</a></li><li><a href=#cgroup_parent>cgroup_parent</a></li><li><a href=#command>command</a></li><li><a href=#configs>configs</a></li><li><a href=#container_name>container_name</a></li><li><a href=#credential_spec>credential_spec</a></li><li><a href=#depends_on>depends_on</a></li><li><a href=#deploy>deploy</a></li><li><a href=#devices>devices</a></li><li><a href=#dns>dns</a></li><li><a href=#dns_search>dns_search</a></li><li><a href=#entrypoint>entrypoint</a></li><li><a href=#env_file>env_file</a></li><li><a href=#environment>environment</a></li><li><a href=#expose>expose</a></li><li><a href=#external_links>external_links</a></li><li><a href=#extra_hosts>extra_hosts</a></li><li><a href=#healthcheck>healthcheck</a></li><li><a href=#image>image</a></li><li><a href=#init>init</a></li><li><a href=#isolation>isolation</a></li><li><a href=#labels>labels</a></li><li><a href=#links>links</a></li><li><a href=#logging>logging</a></li><li><a href=#network_mode>network_mode</a></li><li><a href=#pid>pid</a></li><li><a href=#ports>ports</a></li><li><a href=#profiles>profiles</a></li><li><a href=#restart>restart</a></li><li><a href=#secrets>secrets</a></li><li><a href=#security_opt>security_opt</a></li><li><a href=#stop_grace_period>stop_grace_period</a></li><li><a href=#stop_signal>stop_signal</a></li><li><a href=#sysctls>sysctls</a></li><li><a href=#tmpfs>tmpfs</a></li><li><a href=#ulimits>ulimits</a></li><li><a href=#userns_mode>userns_mode</a></li><li><a href=#volumes>volumes</a><ol><li></li></ol></li><li><a href=#å˜é‡ç½®æ¢>å˜é‡ç½®æ¢</a></li></ol></nav></details></aside><p><a href=https://docs.docker.com/compose/ rel=noopener>docker compose æ–‡æ¡£</a></p><p>Compose æ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚é€šè¿‡ Composeï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ YML æ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºéœ€è¦çš„æ‰€æœ‰æœåŠ¡ã€‚ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥ä» YML æ–‡ä»¶é…ç½®ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚</p><p>Compose ä½¿ç”¨çš„ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ul><li><p>ä½¿ç”¨ Dockerfile å®šä¹‰åº”ç”¨ç¨‹åºçš„ç¯å¢ƒã€‚</p></li><li><p>ä½¿ç”¨ docker-compose.yml å®šä¹‰æ„æˆåº”ç”¨ç¨‹åºçš„æœåŠ¡ï¼Œè¿™æ ·å®ƒä»¬å¯ä»¥åœ¨éš”ç¦»ç¯å¢ƒä¸­ä¸€èµ·è¿è¡Œã€‚</p></li><li><p>æœ€åï¼Œæ‰§è¡Œ docker-compose up å‘½ä»¤æ¥å¯åŠ¨å¹¶è¿è¡Œæ•´ä¸ªåº”ç”¨ç¨‹åºã€‚</p></li></ul><a href=#ä½¿ç”¨><h1 id=ä½¿ç”¨><span class=hanchor arialabel=Anchor># </span>ä½¿ç”¨</h1></a><a href=#å‡†å¤‡><h2 id=å‡†å¤‡><span class=hanchor arialabel=Anchor># </span>å‡†å¤‡</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=err>$</span><span class=w> </span><span class=n>mkdir</span><span class=w> </span><span class=n>composetest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>$</span><span class=w> </span><span class=n>cd</span><span class=w> </span><span class=n>composetest</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨æµ‹è¯•ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º app.py çš„æ–‡ä»¶ï¼Œå¹¶å¤åˆ¶ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>import</span><span class=w> </span><span class=n>time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>import</span><span class=w> </span><span class=n>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>flask</span><span class=w> </span><span class=n>import</span><span class=w> </span><span class=n>Flask</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Flask</span><span class=p>(</span><span class=n>__name__</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redis</span><span class=p>.</span><span class=n>Redis</span><span class=p>(</span><span class=k>host</span><span class=o>=</span><span class=s1>&#39;redis&#39;</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>def</span><span class=w> </span><span class=n>get_hit_count</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>retries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>while</span><span class=w> </span><span class=k>True</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>try</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>cache</span><span class=p>.</span><span class=n>incr</span><span class=p>(</span><span class=s1>&#39;hits&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>except</span><span class=w> </span><span class=n>redis</span><span class=p>.</span><span class=n>exceptions</span><span class=p>.</span><span class=n>ConnectionError</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>exc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>retries</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>raise</span><span class=w> </span><span class=n>exc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>retries</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>time</span><span class=p>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>@</span><span class=n>app</span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>def</span><span class=w> </span><span class=n>hello</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_hit_count</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s1>&#39;Hello World! I have been seen {} times.\n&#39;</span><span class=p>.</span><span class=n>format</span><span class=p>(</span><span class=k>count</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œredis æ˜¯åº”ç”¨ç¨‹åºç½‘ç»œä¸Šçš„ redis å®¹å™¨çš„ä¸»æœºåï¼Œè¯¥ä¸»æœºä½¿ç”¨çš„ç«¯å£ä¸º 6379ã€‚</p><p>åœ¨ composetest ç›®å½•ä¸­åˆ›å»ºå¦ä¸€ä¸ªåä¸º <strong>requirements.txt</strong> çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><a href=#dockerfile><h2 id=dockerfile><span class=hanchor arialabel=Anchor># </span>Dockerfile</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=n>python</span><span class=p>:</span><span class=mi>3</span><span class=p>.</span><span class=mi>7</span><span class=o>-</span><span class=n>alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>WORKDIR</span><span class=w> </span><span class=o>/</span><span class=n>code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ENV</span><span class=w> </span><span class=n>FLASK_APP</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=n>py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ENV</span><span class=w> </span><span class=n>FLASK_RUN_HOST</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RUN</span><span class=w> </span><span class=n>apk</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=c1>--no-cache gcc musl-dev linux-headers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>COPY</span><span class=w> </span><span class=n>requirements</span><span class=p>.</span><span class=n>txt</span><span class=w> </span><span class=n>requirements</span><span class=p>.</span><span class=n>txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RUN</span><span class=w> </span><span class=n>pip</span><span class=w> </span><span class=n>install</span><span class=w> </span><span class=o>-</span><span class=n>r</span><span class=w> </span><span class=n>requirements</span><span class=p>.</span><span class=n>txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COPY</span><span class=w> </span><span class=p>.</span><span class=w> </span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CMD</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;flask&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;run&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>FROM python:3.7-alpine</strong>: ä» Python 3.7 æ˜ åƒå¼€å§‹æ„å»ºé•œåƒã€‚</p></li><li><p><strong>WORKDIR /code</strong>: å°†å·¥ä½œç›®å½•è®¾ç½®ä¸º /codeã€‚</p></li><li><p>è®¾ç½® flask å‘½ä»¤ä½¿ç”¨çš„ç¯å¢ƒå˜é‡ã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>ENV</span><span class=w> </span><span class=n>FLASK_APP</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=n>py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ENV</span><span class=w> </span><span class=n>FLASK_RUN_HOST</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>RUN apk add &ndash;no-cache gcc musl-dev linux-headers</strong>: å®‰è£… gccï¼Œä»¥ä¾¿è¯¸å¦‚ MarkupSafe å’Œ SQLAlchemy ä¹‹ç±»çš„ Python åŒ…å¯ä»¥ç¼–è¯‘åŠ é€Ÿã€‚</p></li><li><p>å¤åˆ¶ requirements.txt å¹¶å®‰è£… Python ä¾èµ–é¡¹ã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>COPY</span><span class=w> </span><span class=n>requirements</span><span class=p>.</span><span class=n>txt</span><span class=w> </span><span class=n>requirements</span><span class=p>.</span><span class=n>txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RUN</span><span class=w> </span><span class=n>pip</span><span class=w> </span><span class=n>install</span><span class=w> </span><span class=o>-</span><span class=n>r</span><span class=w> </span><span class=n>requirements</span><span class=p>.</span><span class=n>txt</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>COPY . .</strong>: å°† . é¡¹ç›®ä¸­çš„å½“å‰ç›®å½•å¤åˆ¶åˆ° . é•œåƒä¸­çš„å·¥ä½œç›®å½•ã€‚</p></li><li><p><strong>CMD [&ldquo;flask&rdquo;, &ldquo;run&rdquo;]</strong>: å®¹å™¨æä¾›é»˜è®¤çš„æ‰§è¡Œå‘½ä»¤ä¸ºï¼šflask run</p></li></ul><a href=#docker-composeyml><h2 id=docker-composeyml><span class=hanchor arialabel=Anchor># </span>docker-compose.yml</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=n>yaml</span><span class=w> </span><span class=err>é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>build</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>-</span><span class=w> </span><span class=s2>&#34;5000:5000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;redis:alpine&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>web</strong>ï¼šè¯¥ web æœåŠ¡ä½¿ç”¨ä» Dockerfile å½“å‰ç›®å½•ä¸­æ„å»ºçš„é•œåƒã€‚ç„¶åï¼Œå®ƒå°†å®¹å™¨å’Œä¸»æœºç»‘å®šåˆ°æš´éœ²çš„ç«¯å£ 5000ã€‚æ­¤ç¤ºä¾‹æœåŠ¡ä½¿ç”¨ Flask Web æœåŠ¡å™¨çš„é»˜è®¤ç«¯å£ 5000 ã€‚</p></li><li><p><strong>redis</strong>ï¼šè¯¥ redis æœåŠ¡ä½¿ç”¨ Docker Hub çš„å…¬å…± Redis æ˜ åƒã€‚</p></li></ul><a href=#å¤šä¸ªé…ç½®æ–‡ä»¶><h1 id=å¤šä¸ªé…ç½®æ–‡ä»¶><span class=hanchor arialabel=Anchor># </span>å¤šä¸ªé…ç½®æ–‡ä»¶</h1></a><p>æˆ‘ä»¬å¯ä»¥ä¸ºåŒä¸€ä¸ªé¡¹ç›®é…ç½®å¤šä¸ªcomposeæ–‡ä»¶ï¼Œä½¿ç”¨å¤šä¸ª Compose æ–‡ä»¶ä½¿æ‚¨èƒ½å¤Ÿé’ˆå¯¹ä¸åŒçš„ç¯å¢ƒæˆ–ä¸åŒçš„å·¥ä½œæµç¨‹è‡ªå®šä¹‰ Compose åº”ç”¨ç¨‹åºã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompose è¯»å–ä¸¤ä¸ªæ–‡ä»¶ï¼Œ<code>docker-compose.yml</code>å’Œä¸€ä¸ªå¯é€‰çš„<code>docker-compose.override.yml</code>æ–‡ä»¶ã€‚</p><ul><li><p><code>docker-compose.yml</code>åŒ…å«æ‚¨çš„åŸºæœ¬é…ç½®ã€‚</p></li><li><p><code>docker-compose.override.yml</code> æ–‡ä»¶ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åŒ…å«ç°æœ‰æœåŠ¡æˆ–å…¨æ–°æœåŠ¡çš„é…ç½®è¦†ç›–ã€‚</p></li></ul><p>å¦‚æœåœ¨ä¸¤ä¸ªæ–‡ä»¶ä¸­éƒ½å®šä¹‰äº†æœåŠ¡ï¼ŒCompose ä¼šä½¿ç”¨ override è¿›è¡Œåˆå¹¶é…ç½®ã€‚</p><p>è¦ä½¿ç”¨å¤šä¸ªè¦†ç›–æ–‡ä»¶æˆ–å…·æœ‰ä¸åŒåç§°çš„è¦†ç›–æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥<code>-f</code>é€‰é¡¹æ¥æŒ‡å®šæ–‡ä»¶åˆ—è¡¨ã€‚Compose æŒ‰ç…§åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šçš„é¡ºåºåˆå¹¶æ–‡ä»¶ã€‚</p><p>å½“æ‚¨ä½¿ç”¨å¤šä¸ªé…ç½®æ–‡ä»¶æ—¶ï¼Œæ‚¨å¿…é¡»ç¡®ä¿æ–‡ä»¶ä¸­çš„æ‰€æœ‰è·¯å¾„éƒ½ç›¸å¯¹äºåŸºæœ¬ Compose æ–‡ä»¶ï¼ˆ æŒ‡å®šçš„ç¬¬ä¸€ä¸ª Compose æ–‡ä»¶<code>-f</code>ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
</span></span></code></pre></td></tr></table></div></div><a href=#docker-composeymlçš„é…ç½®><h2 id=docker-composeymlçš„é…ç½®><span class=hanchor arialabel=Anchor># </span>docker-compose.ymlçš„é…ç½®</h2></a><a href=#version><h2 id=version><span class=hanchor arialabel=Anchor># </span>version</h2></a><p>ç‰ˆæœ¬ä¿¡æ¯ï¼Œå®šä¹‰å…³ä¹äºdockerçš„å…¼å®¹æ€§ï¼ŒCompose æ–‡ä»¶æ ¼å¼æœ‰3ä¸ªç‰ˆæœ¬,åˆ†åˆ«ä¸º1, 2.x å’Œ 3.x</p><a href=#build><h2 id=build><span class=hanchor arialabel=Anchor># </span>build</h2></a><p>æŒ‡å®šæ„å»ºé•œåƒçš„ dockerfile çš„ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  webapp:
</span></span><span class=line><span class=cl>    build: ./dir #æŒ‡å®šè·¯å¾„
</span></span></code></pre></td></tr></table></div></div><p>æˆ–è€…è¯¦ç»†é…ç½®å¯¹è±¡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.9&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>webapp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>context</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=o>/</span><span class=n>dir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>dockerfile</span><span class=p>:</span><span class=w> </span><span class=n>Dockerfile</span><span class=o>-</span><span class=n>alternate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>buildno</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>context ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ°é“¾æ¥åˆ° git ä»“åº“çš„ urlã€‚å½“æ˜¯ç›¸å¯¹è·¯å¾„æ—¶ï¼Œå®ƒè¢«è§£é‡Šä¸ºç›¸å¯¹äº Compose æ–‡ä»¶çš„ä½ç½®ã€‚</p></li><li><p>dockerfile æŒ‡å®šæ„å»ºé•œåƒçš„ Dockerfile æ–‡ä»¶å</p></li><li><p>args æ„å»ºå‚æ•°ï¼Œåªèƒ½åœ¨æ„å»ºè¿‡ç¨‹ä¸­è®¿é—®çš„ç¯å¢ƒå˜é‡</p></li><li><p>cache_from ç¼“å­˜è§£æé•œåƒåˆ—è¡¨</p></li><li><p>labels è®¾ç½®æ„å»ºé•œåƒçš„å…ƒæ•°æ®</p></li><li><p>network è®¾ç½®ç½‘ç»œå®¹å™¨è¿æ¥ï¼Œ<code>none</code> è¡¨ç¤ºåœ¨æ„å»ºæœŸé—´ç¦ç”¨ç½‘ç»œ</p></li><li><p>shm_size è®¾ç½®<code>/dev/shm</code>æ­¤æ„å»ºå®¹å™¨çš„åˆ†åŒºå¤§å°</p></li><li><p>target å¤šé˜¶æ®µæ„å»ºï¼Œå¯ä»¥æŒ‡å®šæ„å»ºå“ªä¸€å±‚</p></li></ul><a href=#network><h2 id=network><span class=hanchor arialabel=Anchor># </span>network</h2></a><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<strong>Composeä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºè®¾ç½®å•ä¸ªç½‘ç»œã€‚services æœåŠ¡çš„æ¯ä¸ªå®¹å™¨éƒ½åŠ å…¥é»˜è®¤ç½‘ç»œï¼Œå¹¶ä¸”å¯ä»¥è¢«è¯¥ç½‘ç»œä¸Šçš„å…¶ä»–å®¹å™¨è®¿é—®ã€‚</strong></p><p>æ‚¨çš„åº”ç”¨ç¨‹åºç½‘ç»œçš„åç§°åŸºäºâ€œé¡¹ç›®åç§°â€ï¼Œä¹Ÿå°±æ˜¯å…¶æ‰€åœ¨ç›®å½•çš„åç§°ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ &ndash;project-name å‘½ä»¤è¡Œé€‰é¡¹ æˆ– COMPOSE_PROJECT_NAME ç¯å¢ƒå˜é‡è¦†ç›–é¡¹ç›®åç§°ã€‚</p><p>å‡è®¾æ‚¨çš„åº”ç”¨ç¨‹åºæ˜¯åœ¨ä¸€ä¸ªåä¸º<code>myapp</code>ç›®å½•ä¸‹ï¼Œ<code>docker-compose.yml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.9&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>build</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=s2>&#34;8000:8000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>db</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=s2>&#34;8001:5432&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿è¡Œ<code>docker-compose up</code>ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µ</p><ol><li><p>åˆ›å»ºäº†ä¸€ä¸ªåä¸º myapp_default çš„ç½‘ç»œã€‚</p></li><li><p>æŠŠ<code>web</code>åŠ å…¥ç½‘ç»œã€‚</p></li><li><p>æŠŠ<code>db</code>åŠ å…¥ç½‘ç»œã€‚</p></li></ol><p>ä¸Šé¢ä¾‹å­è¿˜æœ‰ä¸€ä¸ªæ³¨æ„ç‚¹å°±æ˜¯ç«¯å£å·ï¼Œæ³¨æ„åŒºåˆ†<code>HOST_PORT</code>å’Œ<code>CONTAINER_PORT</code>ï¼Œä»¥ä¸Šé¢çš„dbä¸ºä¾‹ï¼š</p><ul><li><p><code>8001</code> æ˜¯å®¿ä¸»æœºçš„ç«¯å£</p></li><li><p><code>5432</code>ï¼ˆpostgresçš„é»˜è®¤ç«¯å£ï¼‰ æ˜¯å®¹å™¨çš„ç«¯å£</p></li></ul><p>å½“å®¹å™¨ä¹‹é—´é€šè®¯æ—¶ ï¼Œ æ˜¯é€šè¿‡ <code>CONTAINER_PORT</code> æ¥è¿æ¥çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ä¸€çº§é…ç½®networkè‡ªå®šä¹‰ç½‘ç»œï¼Œåˆ›å»ºæ›´å¤æ‚çš„ç½‘ç»œé€‰é¡¹ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥è¿æ¥å·²ç»å­˜åœ¨çš„ç½‘ç»œï¼ˆä¸æ˜¯é€šè¿‡composeåˆ›å»ºçš„ï¼‰</p><p>æ¯ä¸ª<code>service</code> é…ç½®ä¸‹ä¹Ÿå¯ä»¥æŒ‡å®š<code>networks</code>é…ç½®ï¼Œæ¥æŒ‡å®šä¸€çº§é…ç½®çš„ç½‘ç»œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>build</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=o>/</span><span class=n>proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>app</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>build</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=o>/</span><span class=n>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>db</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>#</span><span class=w> </span><span class=err>ä¸€çº§é…ç½®</span><span class=n>networks</span><span class=w> </span><span class=err>åˆ›å»ºäº†è‡ªå®šä¹‰çš„ç½‘ç»œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>frontend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>#</span><span class=w> </span><span class=n>Use</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>custom</span><span class=w> </span><span class=n>driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=n>custom</span><span class=o>-</span><span class=n>driver</span><span class=o>-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>#</span><span class=w> </span><span class=n>Use</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>custom</span><span class=w> </span><span class=n>driver</span><span class=w> </span><span class=n>which</span><span class=w> </span><span class=n>takes</span><span class=w> </span><span class=n>special</span><span class=w> </span><span class=k>options</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=n>custom</span><span class=o>-</span><span class=n>driver</span><span class=o>-</span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>driver_opts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>foo</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>bar</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸€çº§é…ç½®<code>networks</code> åˆ›å»ºäº†è‡ªå®šä¹‰çš„ç½‘ç»œ ã€‚è¿™é‡Œé…ç½®äº†ä¸¤ä¸ª<code>frontend</code>å’Œ<code>backend</code> ï¼Œä¸”è‡ªå®šä¹‰äº†ç½‘ç»œç±»å‹ã€‚</p><p>æ¯ä¸€ä¸ªservicesä¸‹ï¼Œ<code>proxy</code> , <code>app</code> , <code>db</code>éƒ½å®šä¹‰äº†<code>networks</code>é…ç½®ã€‚</p><ol><li><p><code>proxy</code> åªåŠ å…¥åˆ° <code>frontend</code>ç½‘ç»œã€‚</p></li><li><p><code>db</code> åªåŠ å…¥åˆ°<code>backend</code>ç½‘ç»œã€‚</p></li><li><p><code>app</code>åŒæ—¶åŠ å…¥åˆ° <code>frontend</code>å’Œ<code>backend</code> ã€‚</p></li><li><p><code>db</code>å’Œ<code>proxy</code>ä¸èƒ½é€šè®¯ï¼Œå› ä¸ºä¸åœ¨ä¸€ä¸ªç½‘ç»œä¸­ã€‚</p></li><li><p><code>app</code>å’Œä¸¤ä¸ªéƒ½èƒ½é€šè®¯ï¼Œå› ä¸º<code>app</code>åœ¨ä¸¤ä¸ªç½‘ç»œä¸­éƒ½æœ‰é…ç½®ã€‚</p></li><li><p><code>db</code>å’Œ<code>proxy</code>è¦é€šè®¯ï¼Œåªèƒ½é€šè¿‡<code>app</code>è¿™ä¸ªåº”ç”¨æ¥è¿æ¥ã€‚</p></li></ol><p>åŒä¸€ç½‘ç»œä¸Šçš„å…¶ä»–å®¹å™¨å¯ä»¥ä½¿ç”¨æœåŠ¡åç§°æˆ–åˆ«åæ¥è¿æ¥åˆ°å…¶ä»–æœåŠ¡çš„å®¹å™¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>some</span><span class=o>-</span><span class=n>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>some</span><span class=o>-</span><span class=n>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>aliases</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>-</span><span class=w> </span><span class=n>alias1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>-</span><span class=w> </span><span class=n>alias3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>other</span><span class=o>-</span><span class=n>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>aliases</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>-</span><span class=w> </span><span class=n>alias2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åŠ å…¥ç½‘ç»œæ—¶ï¼Œè¿˜å¯ä»¥æŒ‡å®šå®¹å™¨çš„é™æ€ IP åœ°å€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  app:
</span></span><span class=line><span class=cl>    image: nginx:alpine
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      app_net:
</span></span><span class=line><span class=cl>        ipv4_address: 172.16.238.10
</span></span><span class=line><span class=cl>        ipv6_address: 2001:3984:3989::10
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>networks:
</span></span><span class=line><span class=cl>  app_net:
</span></span><span class=line><span class=cl>    ipam:
</span></span><span class=line><span class=cl>      driver: default
</span></span><span class=line><span class=cl>      config:
</span></span><span class=line><span class=cl>        - subnet: &#34;172.16.238.0/24&#34;
</span></span><span class=line><span class=cl>        - subnet: &#34;2001:3984:3989::/64&#34;
</span></span></code></pre></td></tr></table></div></div><a href=#ä¸€çº§networksè¿˜æœ‰å¦‚ä¸‹è¿™äº›é…ç½®><h3 id=ä¸€çº§networksè¿˜æœ‰å¦‚ä¸‹è¿™äº›é…ç½®><span class=hanchor arialabel=Anchor># </span>ä¸€çº§networksè¿˜æœ‰å¦‚ä¸‹è¿™äº›é…ç½®ï¼š</h3></a><ul><li>driver æŒ‡å®šè¯¥ç½‘ç»œåº”ä½¿ç”¨å“ªä¸ªé©±åŠ¨ç¨‹åºã€‚é»˜è®¤ä½¿ç”¨<code>bridge</code>å•ä¸ªä¸»æœºä¸Šçš„ç½‘ç»œï¼Œoverlayä»£è¡¨è·¨å¤šä¸ªèŠ‚ç‚¹çš„ç½‘ç»œç¾¤</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=k>overlay</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>host or none ä½¿ç”¨ä¸»æœºçš„ç½‘ç»œå †æ ˆï¼Œæˆ–è€…ä¸ä½¿ç”¨ç½‘ç»œã€‚ç›¸å½“äº<code>docker run --net=host</code>æˆ–<code>docker run --net=none</code>ã€‚ä»…åœ¨ä½¿ç”¨<code>docker stack</code>å‘½ä»¤æ—¶ä½¿ç”¨ã€‚å¦‚æœæ‚¨ä½¿ç”¨è¯¥<code>docker-compose</code>å‘½ä»¤ï¼Œè¯·æ”¹ç”¨ network_modeã€‚</p></li><li><p>driver_opts å°†é€‰é¡¹åˆ—è¡¨æŒ‡å®šä¸ºé”®å€¼å¯¹ä»¥ä¼ é€’ç»™æ­¤ç½‘ç»œçš„é©±åŠ¨ç¨‹åº</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>driver_opts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>foo</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;bar&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>baz</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>attachable ä»…åœ¨<code>driver</code>è®¾ç½®ä¸º <code>overlay</code>æ—¶å¯ç”¨ã€‚å¦‚æœè®¾ç½®ä¸º<code>true</code>ï¼Œé‚£ä¹ˆé™¤äº†æœåŠ¡ä¹‹å¤–ï¼Œç‹¬ç«‹å®¹å™¨ä¹Ÿå¯ä»¥è¿æ¥åˆ°æ­¤ç½‘ç»œã€‚</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>mynet1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=k>overlay</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>attachable</span><span class=p>:</span><span class=w> </span><span class=k>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>enable_ipv6 åœ¨æ­¤ç½‘ç»œä¸Šå¯ç”¨ IPv6 ç½‘ç»œã€‚</p></li><li><p>ipam è‡ªå®šä¹‰ IPAM ï¼ˆIPåœ°å€ç®¡ç†ï¼‰é…ç½®ã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>ipam</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=k>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>subnet</span><span class=p>:</span><span class=w> </span><span class=mi>172</span><span class=p>.</span><span class=mi>28</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=o>/</span><span class=mi>16</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>internal é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker ä¼šå°†æ¡¥æ¥ç½‘ç»œè¿æ¥åˆ°å®ƒæä¾›å¤–éƒ¨è¿æ¥ã€‚å¦‚æœè¦åˆ›å»ºå¤–éƒ¨éš”ç¦»çš„è¦†ç›–ç½‘ç»œï¼Œå¯ä»¥å°†æ­¤é€‰é¡¹è®¾ç½®ä¸ºtrueã€‚</p></li><li><p>labels æ·»åŠ å…ƒæ•°æ®</p></li><li><p>externalå¦‚æœè®¾ç½®ä¸º<code>true</code>ï¼Œåˆ™æŒ‡å®šæ­¤ç½‘ç»œæ˜¯åœ¨ Compose ä¹‹å¤–åˆ›å»ºçš„ã€‚<code>docker-compose up</code>ä¸ä¼šå°è¯•åˆ›å»ºå®ƒï¼Œå¦‚æœå®ƒä¸å­˜åœ¨ï¼Œåˆ™ä¼šå¼•å‘é”™è¯¯ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ<code>proxy</code>æ˜¯é€šå¾€å¤–ç•Œçš„é—¨æˆ·ã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.9&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>build</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=o>/</span><span class=n>proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>outside</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=k>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>app</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>build</span><span class=p>:</span><span class=w> </span><span class=p>.</span><span class=o>/</span><span class=n>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=k>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>outside</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>external</span><span class=p>:</span><span class=w> </span><span class=k>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>nameä¸ºæ­¤ç½‘ç»œè®¾ç½®è‡ªå®šä¹‰åç§°ã€‚</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.9&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>network1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>my</span><span class=o>-</span><span class=n>app</span><span class=o>-</span><span class=n>net</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#cap_add-cap_drop><h2 id=cap_add-cap_drop><span class=hanchor arialabel=Anchor># </span>cap_add, cap_drop</h2></a><p>æ·»åŠ æˆ–åˆ é™¤å®¹å™¨æ‹¥æœ‰çš„å®¿ä¸»æœºçš„å†…æ ¸åŠŸèƒ½ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>cap_add:
</span></span><span class=line><span class=cl>  - ALL # å¼€å¯å…¨éƒ¨æƒé™
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cap_drop:
</span></span><span class=line><span class=cl>  - SYS_PTRACE # å…³é—­ ptraceæƒé™
</span></span></code></pre></td></tr></table></div></div><a href=#cgroup_parent><h2 id=cgroup_parent><span class=hanchor arialabel=Anchor># </span>cgroup_parent</h2></a><p>ä¸ºå®¹å™¨æŒ‡å®šçˆ¶ cgroup ç»„ï¼Œæ„å‘³ç€å°†ç»§æ‰¿è¯¥ç»„çš„èµ„æºé™åˆ¶ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>cgroup_parent: m-executor-abcd
</span></span></code></pre></td></tr></table></div></div><a href=#command><h2 id=command><span class=hanchor arialabel=Anchor># </span>command</h2></a><p>è¦†ç›–å®¹å™¨å¯åŠ¨åé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>command: bundle exec thin -p 3000
</span></span><span class=line><span class=cl>command: [&#34;bundle&#34;, &#34;exec&#34;, &#34;thin&#34;, &#34;-p&#34;, &#34;3000&#34;]
</span></span></code></pre></td></tr></table></div></div><a href=#configs><h2 id=configs><span class=hanchor arialabel=Anchor># </span>configs</h2></a><p>ä¸ºæ¯ä¸ªæœåŠ¡èµ‹äºˆç›¸åº”çš„configsè®¿é—®æƒé™</p><ul><li>ç®€çŸ­è¯­æ³•ï¼ŒæŒ‡å®šé…ç½®åç§°å³å¯ã€‚ä»¥ä¸‹ç¤ºä¾‹æˆäºˆ<code>redis</code>æœåŠ¡è®¿é—®<code>my_config</code>å’Œ<code>my_other_config</code>configs çš„æƒé™ã€‚</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  redis:
</span></span><span class=line><span class=cl>    image: redis:latest
</span></span><span class=line><span class=cl>    deploy:
</span></span><span class=line><span class=cl>      replicas: 1
</span></span><span class=line><span class=cl>    configs:
</span></span><span class=line><span class=cl>      - my_config
</span></span><span class=line><span class=cl>      - my_other_config
</span></span><span class=line><span class=cl>configs:
</span></span><span class=line><span class=cl>  my_config:
</span></span><span class=line><span class=cl>    file: ./my_config.txt
</span></span><span class=line><span class=cl>  my_other_config:
</span></span><span class=line><span class=cl>    external: true
</span></span></code></pre></td></tr></table></div></div><ul><li><p>é•¿è¯­æ³•</p><ul><li><p><code>source</code>ï¼šé…ç½®åç§°</p></li><li><p><code>target</code>ï¼šè¦æŒ‚è½½æ–‡ä»¶çš„è·¯å¾„å’Œåç§°</p></li><li><p><code>uid</code>å’Œ<code>gid</code>ï¼šå®¹å™¨çš„æ•°å­— UID æˆ– GID</p></li><li><p><code>mode</code>ï¼šæŒ‚è½½åœ¨æœåŠ¡çš„ä»»åŠ¡å®¹å™¨ä¸­çš„æ–‡ä»¶çš„æƒé™ï¼Œä»¥å…«è¿›åˆ¶è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œ<code>0444</code> ä»£è¡¨å¯è¯»ã€‚</p></li><li><p>ä»¥ä¸‹ç¤ºä¾‹åœ¨å®¹å™¨å†…è®¾ç½®configsåç§°ä¸º<code>my_config ï¼Œè·¯å¾„ä¸ºredis_config</code>ï¼Œå°†æ¨¡å¼è®¾ç½®ä¸º<code>0440</code>ï¼ˆç»„å¯è¯»ï¼‰å¹¶å°†ç”¨æˆ·å’Œç»„è®¾ç½®ä¸º<code>103</code>ã€‚è¯¥<code>redis</code>æœåŠ¡æ— æƒè®¿é—®<code>my_other_config</code>é…ç½®ã€‚</p></li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>version: <span class=s2>&#34;3.9&#34;</span>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  redis:
</span></span><span class=line><span class=cl>    image: redis:latest
</span></span><span class=line><span class=cl>    deploy:
</span></span><span class=line><span class=cl>      replicas: <span class=m>1</span>
</span></span><span class=line><span class=cl>    configs:
</span></span><span class=line><span class=cl>      - source: my_config
</span></span><span class=line><span class=cl>        target: /redis_config
</span></span><span class=line><span class=cl>        uid: <span class=s1>&#39;103&#39;</span>
</span></span><span class=line><span class=cl>        gid: <span class=s1>&#39;103&#39;</span>
</span></span><span class=line><span class=cl>        mode: <span class=m>0440</span>
</span></span><span class=line><span class=cl>configs:
</span></span><span class=line><span class=cl>  my_config:
</span></span><span class=line><span class=cl>    file: ./my_config.txt
</span></span><span class=line><span class=cl>  my_other_config:
</span></span><span class=line><span class=cl>    external: <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸€çº§<code>configs</code>è¯¦ç»†é…ç½®ï¼š</p><ul><li><p><code>file</code>: ä½¿ç”¨æŒ‡å®šè·¯å¾„ä¸­çš„æ–‡ä»¶å†…å®¹åˆ›å»ºé…ç½®ã€‚</p></li><li><p><code>external</code>: å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™æŒ‡å®šæ­¤é…ç½®å·²ç»åˆ›å»ºã€‚Docker ä¸ä¼šå°è¯•åˆ›å»ºå®ƒï¼Œå¦‚æœå®ƒä¸å­˜åœ¨ï¼Œ ä¼šæŠ¥é”™<code>config not found</code>ã€‚</p></li><li><p><code>name</code>: Docker ä¸­é…ç½®å¯¹è±¡çš„åç§°ã€‚æ­¤å­—æ®µå¯ç”¨äºå¼•ç”¨åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„é…ç½®ã€‚</p></li><li><p><code>driver</code>å’Œ<code>driver_opts</code>ï¼šè‡ªå®šä¹‰é©±åŠ¨ç¨‹åºçš„åç§°ï¼Œä»¥åŠä½œä¸ºé”®/å€¼å¯¹ä¼ é€’çš„ç‰¹å®šäºé©±åŠ¨ç¨‹åºçš„é€‰é¡¹ã€‚</p></li><li><p><code>template_driver</code>ï¼šè¦ä½¿ç”¨çš„æ¨¡æ¿é©±åŠ¨ç¨‹åºçš„åç§°ï¼Œå®ƒæ§åˆ¶æ˜¯å¦ä»¥åŠå¦‚ä½•å°†é…ç½®è´Ÿè½½ä½œä¸ºæ¨¡æ¿ã€‚å¦‚æœæœªè®¾ç½®é©±åŠ¨ç¨‹åºï¼Œåˆ™ä¸ä½¿ç”¨æ¨¡æ¿ã€‚å½“å‰æ”¯æŒçš„å”¯ä¸€é©±åŠ¨ç¨‹åºæ˜¯<code>golang</code>ï¼Œå®ƒä½¿ç”¨<code>golang</code>ã€‚</p></li></ul><p>åœ¨ä¸‹é¢ä¾‹å­ä¸­ï¼Œ<code>my_first_config</code>æ˜¯é€šè¿‡confif_dataæ–‡ä»¶å†…å®¹åˆ›å»ºçš„ï¼ˆå°±åƒ <code>&lt;stack_name>_my_first_config)</code>éƒ¨ç½²å †æ ˆæ—¶ä¸€æ ·ï¼Œå¹¶ä¸”<code>my_second_config</code>å·²ç»åˆ›å»ºè¿‡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>configs:
</span></span><span class=line><span class=cl>  my_first_config:
</span></span><span class=line><span class=cl>    file: ./config_data
</span></span><span class=line><span class=cl>  my_second_config:
</span></span><span class=line><span class=cl>    external: true 
</span></span></code></pre></td></tr></table></div></div><p>å½“ Docker ä¸­çš„é…ç½®åç§°ä¸æœåŠ¡ä¸­å­˜åœ¨çš„åç§°ä¸åŒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨nameè¿›è¡Œé…ç½®ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>configs:
</span></span><span class=line><span class=cl>  my_first_config:
</span></span><span class=line><span class=cl>    file: ./config_data
</span></span><span class=line><span class=cl>  my_second_config:
</span></span><span class=line><span class=cl>    external:
</span></span><span class=line><span class=cl>      name: redis_config
</span></span></code></pre></td></tr></table></div></div><a href=#container_name><h2 id=container_name><span class=hanchor arialabel=Anchor># </span>container_name</h2></a><p>æŒ‡å®šè‡ªå®šä¹‰å®¹å™¨åç§°ï¼Œè€Œä¸æ˜¯ç”Ÿæˆçš„é»˜è®¤åç§°ã€‚ç”±äº Docker å®¹å™¨åç§°å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œå› æ­¤å¦‚æœæ‚¨æŒ‡å®šäº†è‡ªå®šä¹‰åç§°ï¼Œåˆ™ä¸èƒ½å°†æœåŠ¡æ‰©å±•åˆ° 1 ä¸ªä»¥ä¸Šçš„å®¹å™¨ã€‚</p><a href=#credential_spec><h2 id=credential_spec><span class=hanchor arialabel=Anchor># </span>credential_spec</h2></a><p>ä¸ºæ‰˜ç®¡æœåŠ¡å¸æˆ·é…ç½®å‡­æ®è§„èŒƒã€‚æ­¤é€‰é¡¹ä»…ç”¨äºä½¿ç”¨ Windows å®¹å™¨çš„æœåŠ¡ã€‚åœ¨<code>credential_spec</code>ä¸Šçš„é…ç½®åˆ—è¡¨æ ¼å¼ä¸º<code>file://&lt;filename></code>æˆ–<code>registry://&lt;value-name></code></p><a href=#depends_on><h2 id=depends_on><span class=hanchor arialabel=Anchor># </span>depends_on</h2></a><p>è¡¨ç¤ºæœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚æœåŠ¡ä¾èµ–ä¼šå¯¼è‡´ä»¥ä¸‹è¡Œä¸ºï¼š</p><ul><li><p><code>docker-compose up</code>æŒ‰ä¾èµ–é¡ºåºå¯åŠ¨æœåŠ¡ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œ<code>db</code>å’Œ<code>redis</code>åœ¨ <code>web</code>ä¹‹å‰å¯åŠ¨ã€‚</p></li><li><p><code>docker-compose up SERVICE</code>è‡ªåŠ¨åŒ…å«<code>SERVICE</code>çš„ä¾èµ–é¡¹ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œ<code>docker-compose up web</code>è¿˜åˆ›å»ºå¹¶å¯åŠ¨<code>db</code>å’Œ<code>redis</code>ã€‚</p></li><li><p><code>docker-compose stop</code>æŒ‰ä¾èµ–é¡ºåºåœæ­¢æœåŠ¡ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œ<code>web</code>åœ¨<code>db</code>å’Œ<code>redis</code>ä¹‹å‰åœæ­¢ã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>version: <span class=s2>&#34;3.9&#34;</span>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  web:
</span></span><span class=line><span class=cl>    build: .
</span></span><span class=line><span class=cl>    depends_on:
</span></span><span class=line><span class=cl>      - db
</span></span><span class=line><span class=cl>      - redis
</span></span><span class=line><span class=cl>  redis:
</span></span><span class=line><span class=cl>    image: redis
</span></span><span class=line><span class=cl>  db:
</span></span><span class=line><span class=cl>    image: postgres
</span></span></code></pre></td></tr></table></div></div><a href=#deploy><h2 id=deploy><span class=hanchor arialabel=Anchor># </span>deploy</h2></a><p>æŒ‡å®šä¸æœåŠ¡çš„éƒ¨ç½²å’Œè¿è¡Œæœ‰å…³çš„é…ç½®ã€‚åªåœ¨ swarm æ¨¡å¼ä¸‹æ‰ä¼šæœ‰ç”¨ã€‚</p><ul><li><p>endpoint_mode è®¿é—®é›†ç¾¤æœåŠ¡çš„æ–¹å¼ã€‚</p><ul><li><p>vip ï¼šDocker é›†ç¾¤æœåŠ¡ä¸€ä¸ªå¯¹å¤–çš„è™šæ‹Ÿ ipã€‚æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šé€šè¿‡è¿™ä¸ªè™šæ‹Ÿ ip åˆ°è¾¾é›†ç¾¤æœåŠ¡å†…éƒ¨çš„æœºå™¨ã€‚</p></li><li><p>dnsrr ï¼šDNS è½®è¯¢ï¼ˆDNSRRï¼‰ã€‚æ‰€æœ‰çš„è¯·æ±‚ä¼šè‡ªåŠ¨è½®è¯¢è·å–åˆ°é›†ç¾¤ ip åˆ—è¡¨ä¸­çš„ä¸€ä¸ª ip åœ°å€ã€‚</p></li></ul></li><li><p>labels åœ¨æœåŠ¡ä¸Šè®¾ç½®æ ‡ç­¾ã€‚å¯ä»¥ç”¨å®¹å™¨ä¸Šçš„ labelsï¼ˆè·Ÿ deploy åŒçº§çš„é…ç½®ï¼‰ è¦†ç›– deploy ä¸‹çš„ labelsã€‚</p></li><li><p>mode æŒ‡å®šæœåŠ¡æä¾›çš„æ¨¡å¼</p><ul><li><p>globalï¼šå…¨å±€æœåŠ¡ï¼ŒæœåŠ¡å°†éƒ¨ç½²è‡³é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ã€‚</p></li><li><p>replicatedï¼šå¤åˆ¶æœåŠ¡ï¼Œå¤åˆ¶æŒ‡å®šæœåŠ¡åˆ°é›†ç¾¤çš„æœºå™¨ä¸Šã€‚</p></li></ul></li></ul><p>ä¸‹å›¾ä¸­é»„è‰²çš„æ–¹å—æ˜¯ replicated æ¨¡å¼çš„è¿è¡Œæƒ…å†µï¼Œç°è‰²æ–¹å—æ˜¯ global æ¨¡å¼çš„è¿è¡Œæƒ…å†µã€‚</p><p><img src=https://quartz.jzhao.xyz//statistic/asynccode-214.png width=auto alt></p><ul><li><p>placement æŒ‡å®šçº¦æŸå’Œé¦–é€‰é¡¹çš„ä½ç½®</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>version: <span class=s2>&#34;3.9&#34;</span>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  db:
</span></span><span class=line><span class=cl>    image: postgres
</span></span><span class=line><span class=cl>    deploy:
</span></span><span class=line><span class=cl>      placement:
</span></span><span class=line><span class=cl>        constraints:
</span></span><span class=line><span class=cl>          - <span class=s2>&#34;node.role==manager&#34;</span>
</span></span><span class=line><span class=cl>          - <span class=s2>&#34;engine.labels.operatingsystem==ubuntu 18.04&#34;</span>
</span></span><span class=line><span class=cl>        preferences:
</span></span><span class=line><span class=cl>          - spread: node.labels.zone
</span></span></code></pre></td></tr></table></div></div><ul><li>æ‚¨å¯ä»¥é€šè¿‡å®šä¹‰çº¦æŸè¡¨è¾¾å¼æ¥é™åˆ¶å¯ä»¥å®‰æ’ä»»åŠ¡çš„èŠ‚ç‚¹é›†ã€‚çº¦æŸè¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨åŒ¹é…(<code>==</code>) æˆ–æ’é™¤(<code>!=</code>) è§„åˆ™ã€‚å¤šä¸ªçº¦æŸæŸ¥æ‰¾å¯ä»¥ä½¿ç”¨ AND åŒ¹é…ã€‚çº¦æŸå¯ä»¥åŒ¹é…èŠ‚ç‚¹æˆ– Docker å¼•æ“æ ‡ç­¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</li></ul></li></ul><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>èŠ‚ç‚¹å±æ€§</td><td>åŒ¹é…</td><td>ä¾‹å­</td></tr><tr><td>node.id</td><td>èŠ‚ç‚¹ ID</td><td>node.id==2ivku8v2gvtg4</td></tr><tr><td>node.hostname</td><td>èŠ‚ç‚¹ä¸»æœºå</td><td>node.hostname!=node-2</td></tr><tr><td>node.role</td><td>èŠ‚ç‚¹è§’è‰² ( manager/ worker)</td><td>node.role==manager</td></tr><tr><td>node.platform.os</td><td>èŠ‚ç‚¹æ“ä½œç³»ç»Ÿ</td><td>node.platform.os==windows</td></tr><tr><td>node.platform.arch</td><td>èŠ‚ç‚¹æ¶æ„</td><td>node.platform.arch==x86_64</td></tr><tr><td>node.labels</td><td>ç”¨æˆ·å®šä¹‰çš„èŠ‚ç‚¹æ ‡ç­¾</td><td>node.labels.security==high</td></tr><tr><td>engine.labels</td><td>Docker å¼•æ“çš„æ ‡ç­¾</td><td>engine.labels.operatingsystem==ubuntu-14.04</td></tr></tbody></table><ul><li><p>max_replicas_per_node å¦‚æœæœåŠ¡æ˜¯<code>replicated</code>ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™é™åˆ¶ä»»ä½•æ—¶é—´åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„å‰¯æœ¬æ•°</p></li><li><p>replicas å¦‚æœæœåŠ¡æ˜¯<code>replicated</code>ï¼ˆé»˜è®¤å€¼ï¼‰ï¼ŒæŒ‡å®šåœ¨ä»»ä½•ç»™å®šæ—¶é—´åº”è¿è¡Œçš„å®¹å™¨æ•°é‡ã€‚</p></li><li><p>resources é…ç½®èµ„æºçº¦æŸã€‚åœ¨ä¸‹é¢ç¤ºä¾‹ä¸­ï¼Œ<code>redis</code>æœåŠ¡è¢«é™åˆ¶ä¸ºä½¿ç”¨ä¸è¶…è¿‡ 50M çš„å†…å­˜å’Œ<code>0.50</code>ï¼ˆå•æ ¸çš„ 50%ï¼‰å¯ç”¨å¤„ç†æ—¶é—´ (CPU)ï¼Œå¹¶ä¿ç•™<code>20M</code>å†…å­˜å’Œ<code>0.25</code>CPU æ—¶é—´ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰ã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  redis:
</span></span><span class=line><span class=cl>    image: redis:alpine
</span></span><span class=line><span class=cl>    deploy:
</span></span><span class=line><span class=cl>      resources:
</span></span><span class=line><span class=cl>        limits:
</span></span><span class=line><span class=cl>          cpus: &#39;0.50&#39;
</span></span><span class=line><span class=cl>          memory: 50M
</span></span><span class=line><span class=cl>        reservations:
</span></span><span class=line><span class=cl>          cpus: &#39;0.25&#39;
</span></span><span class=line><span class=cl>          memory: 20M
</span></span></code></pre></td></tr></table></div></div><ul><li><p>restart_policy é…ç½®æ˜¯å¦ä»¥åŠå¦‚ä½•åœ¨é€€å‡ºæ—¶é‡æ–°å¯åŠ¨å®¹å™¨ã€‚æ›¿æ¢<code>[restart](https://link.zhihu.com/?target=https%3A//docs.docker.com/compose/compose-file/compose-file-v2/%23orig-resources)</code></p><ul><li><p>condition: none, on-failure æˆ– any (é»˜è®¤: any) ä¹‹ä¸€ã€‚</p></li><li><p>delayï¼šé‡æ–°å¯åŠ¨å°è¯•ä¹‹é—´ç­‰å¾…çš„æ—¶é—´ï¼ˆé»˜è®¤å€¼ï¼š5sï¼‰ã€‚</p></li><li><p>max_attemptsï¼šåœ¨æ”¾å¼ƒä¹‹å‰å°è¯•é‡æ–°å¯åŠ¨å®¹å™¨çš„æ¬¡æ•°ï¼ˆé»˜è®¤å€¼ï¼šæ°¸ä¸æ”¾å¼ƒï¼‰ã€‚å¦‚æœåœ¨é…ç½®çš„çª—å£ï¼ˆwindowï¼‰å†…é‡æ–°å¯åŠ¨æœªæˆåŠŸï¼Œåˆ™æ­¤å°è¯•ä¸è®¡å…¥é…ç½®max_attemptså€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ max_attempts è®¾ç½®ä¸ºâ€œ2â€ï¼Œå¹¶ä¸”ç¬¬ä¸€æ¬¡å°è¯•é‡å¯å¤±è´¥ï¼Œåˆ™å¯èƒ½ä¼šå°è¯•ä¸¤æ¬¡ä»¥ä¸Šçš„é‡å¯ã€‚</p></li><li><p>windowï¼šåœ¨å†³å®šé‡å¯æ˜¯å¦æˆåŠŸä¹‹å‰ç­‰å¾…å¤šé•¿æ—¶é—´ï¼ˆé»˜è®¤å€¼ï¼šç«‹å³é‡å¯ï¼‰ã€‚</p></li></ul></li><li><p>rollback_config åœ¨æ›´æ–°å¤±è´¥çš„æƒ…å†µä¸‹åº”å¦‚ä½•å›æ»šæœåŠ¡ã€‚</p><ul><li><p><code>parallelism</code>ï¼šä¸€æ¬¡å›æ»šçš„å®¹å™¨æ•°é‡ã€‚å¦‚æœè®¾ç½®ä¸º 0ï¼Œåˆ™æ‰€æœ‰å®¹å™¨åŒæ—¶å›æ»šã€‚</p></li><li><p><code>delay</code>ï¼šæ¯ä¸ªå®¹å™¨ç»„å›æ»šä¹‹é—´ç­‰å¾…çš„æ—¶é—´ï¼ˆé»˜è®¤ä¸º 0 ç§’ï¼‰ã€‚</p></li><li><p><code>failure_action</code>: å¦‚æœå›æ»šå¤±è´¥æ€ä¹ˆåŠã€‚<code>continue</code>æˆ–è€…<code>pause</code>ï¼ˆé»˜è®¤<code>pause</code>ï¼‰</p></li><li><p><code>monitor</code>ï¼šæ¯æ¬¡ä»»åŠ¡æ›´æ–°åç›‘æ§å¤±è´¥çš„æŒç»­æ—¶é—´<code>(ns|us|ms|s|m|h)</code>ï¼ˆé»˜è®¤ 5sï¼‰æ³¨æ„ï¼šè®¾ç½®ä¸º 0 å°†ä½¿ç”¨é»˜è®¤ 5sã€‚</p></li><li><p><code>max_failure_ratio</code>ï¼šå›æ»šæœŸé—´å…è®¸çš„æ•…éšœç‡ï¼ˆé»˜è®¤ä¸º 0ï¼‰ã€‚</p></li><li><p><code>order</code>ï¼šå›æ»šæœŸé—´çš„æ“ä½œé¡ºåºã€‚<code>stop-first</code>ï¼ˆæ—§ä»»åŠ¡åœ¨å¼€å§‹æ–°ä»»åŠ¡ä¹‹å‰åœæ­¢ï¼‰ï¼Œæˆ–<code>start-first</code>ï¼ˆé¦–å…ˆå¯åŠ¨æ–°ä»»åŠ¡ï¼Œå¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡çŸ­æš‚é‡å ï¼‰ï¼ˆé»˜è®¤<code>stop-first</code>ï¼‰ã€‚</p></li></ul></li></ul><p>update_config é…ç½®åº”å¦‚ä½•æ›´æ–°æœåŠ¡ã€‚ç”¨äºé…ç½®æ»šåŠ¨æ›´æ–°ã€‚</p><ol><li><p><code>parallelism</code>ï¼šä¸€æ¬¡æ›´æ–°çš„å®¹å™¨æ•°é‡ã€‚</p></li><li><p><code>delay</code>ï¼šæ›´æ–°ä¸€ç»„å®¹å™¨ä¹‹é—´çš„ç­‰å¾…æ—¶é—´ã€‚</p></li><li><p><code>failure_action</code>: å¦‚æœæ›´æ–°å¤±è´¥æ€ä¹ˆåŠã€‚<code>continue</code>ï¼Œ<code>rollback</code>æˆ–è€…<code>pause</code> ï¼ˆé»˜è®¤ï¼š<code>pause</code>ï¼‰ã€‚</p></li><li><p><code>monitor</code>ï¼šæ¯æ¬¡ä»»åŠ¡æ›´æ–°åç›‘æ§å¤±è´¥çš„æŒç»­æ—¶é—´<code>(ns|us|ms|s|m|h)</code>ï¼ˆé»˜è®¤ 5sï¼‰æ³¨æ„ï¼šè®¾ç½®ä¸º 0 å°†ä½¿ç”¨é»˜è®¤ 5sã€‚</p></li><li><p><code>max_failure_ratio</code>ï¼šæ›´æ–°æœŸé—´å¯å®¹å¿çš„æ•…éšœç‡ã€‚</p></li><li><p><code>order</code>ï¼šæ›´æ–°æœŸé—´çš„æ“ä½œé¡ºåºã€‚<code>stop-first</code>ï¼ˆæ—§ä»»åŠ¡åœ¨å¼€å§‹æ–°ä»»åŠ¡ä¹‹å‰åœæ­¢ï¼‰ï¼Œæˆ–<code>start-first</code>ï¼ˆæ–°ä»»åŠ¡é¦–å…ˆå¯åŠ¨ï¼Œå¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡çŸ­æš‚é‡å ï¼‰ï¼ˆé»˜è®¤<code>stop-first</code>ï¼‰</p></li></ol><a href=#devices><h2 id=devices><span class=hanchor arialabel=Anchor># </span>devices</h2></a><p>è®¾å¤‡æ˜ å°„åˆ—è¡¨ã€‚ä½¿ç”¨ä¸<code>--device</code>docker å®¢æˆ·ç«¯åˆ›å»ºé€‰é¡¹æ ¼å¼ç›¸åŒã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>devices:
</span></span><span class=line><span class=cl>  - &#34;/dev/ttyUSB0:/dev/ttyUSB0&#34;
</span></span></code></pre></td></tr></table></div></div><a href=#dns><h2 id=dns><span class=hanchor arialabel=Anchor># </span>dns</h2></a><p>è‡ªå®šä¹‰ DNS æœåŠ¡å™¨ã€‚å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–åˆ—è¡¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>dns: 8.8.8.8
</span></span><span class=line><span class=cl>dns:
</span></span><span class=line><span class=cl>  - 8.8.8.8
</span></span><span class=line><span class=cl>  - 9.9.9.9
</span></span></code></pre></td></tr></table></div></div><a href=#dns_search><h2 id=dns_search><span class=hanchor arialabel=Anchor># </span>dns_search</h2></a><p>è‡ªå®šä¹‰ DNS æœç´¢åŸŸã€‚å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–åˆ—è¡¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>dns_search: example.com
</span></span><span class=line><span class=cl>dns_search:
</span></span><span class=line><span class=cl>  - dc1.example.com
</span></span><span class=line><span class=cl>  - dc2.example.com
</span></span></code></pre></td></tr></table></div></div><a href=#entrypoint><h2 id=entrypoint><span class=hanchor arialabel=Anchor># </span>entrypoint</h2></a><p>åœ¨ Dockerfile ä¸­æœ‰ä¸€ä¸ªæŒ‡ä»¤å«åš<code>ENTRYPOINT</code>æŒ‡ä»¤ï¼Œç”¨äºè¿è¡Œç¨‹åºã€‚åœ¨<code>docker-compose.yml</code>ä¸­å¯ä»¥å®šä¹‰è¦†ç›– Dockerfile ä¸­å®šä¹‰çš„ entrypointï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>entrypoint: /code/entrypoint.sh
</span></span><span class=line><span class=cl>entrypoint: [&#34;php&#34;, &#34;-d&#34;, &#34;memory_limit=-1&#34;, &#34;vendor/bin/phpunit&#34;]
</span></span></code></pre></td></tr></table></div></div><p>ä¹Ÿå¯ä»¥æ˜¯ä»¥ä¸‹æ ¼å¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>entrypoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>php</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=o>-</span><span class=n>d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>zend_extension</span><span class=o>=/</span><span class=n>usr</span><span class=o>/</span><span class=k>local</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>php</span><span class=o>/</span><span class=n>extensions</span><span class=o>/</span><span class=k>no</span><span class=o>-</span><span class=n>debug</span><span class=o>-</span><span class=n>non</span><span class=o>-</span><span class=n>zts</span><span class=o>-</span><span class=mi>20100525</span><span class=o>/</span><span class=n>xdebug</span><span class=p>.</span><span class=n>so</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=o>-</span><span class=n>d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>memory_limit</span><span class=o>=-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>vendor</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>phpunit</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#env_file><h2 id=env_file><span class=hanchor arialabel=Anchor># </span>env_file</h2></a><p>ä»æ–‡ä»¶æ·»åŠ ç¯å¢ƒå˜é‡ã€‚å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–åˆ—è¡¨ã€‚</p><p>å¦‚æœæ‚¨ä½¿ç”¨æŒ‡å®šäº† Compose æ–‡ä»¶<code>docker-compose -f FILE</code>ï¼Œåˆ™å…¶ä¸­çš„è·¯å¾„ <code>env_file</code>ç›¸å¯¹äºè¯¥æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ã€‚</p><p>environment å£°æ˜çš„ç¯å¢ƒå˜é‡ä¼šè¦†ç›–è¿™äº›å€¼â€”â€”å³ä½¿è¿™äº›å€¼æ˜¯ç©ºçš„æˆ–æœªå®šä¹‰çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>env_file: .env
</span></span><span class=line><span class=cl>env_file:
</span></span><span class=line><span class=cl>  - ./common.env
</span></span><span class=line><span class=cl>  - ./apps/web.env
</span></span><span class=line><span class=cl>  - /opt/runtime_opts.env
</span></span></code></pre></td></tr></table></div></div><a href=#environment><h2 id=environment><span class=hanchor arialabel=Anchor># </span>environment</h2></a><p>æ·»åŠ ç¯å¢ƒå˜é‡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ•°ç»„æˆ–å­—å…¸ã€‚ä»»ä½•å¸ƒå°”å€¼ï¼ˆtrueã€falseã€yesã€noï¼‰éƒ½éœ€è¦ç”¨å¼•å·æ‹¬èµ·æ¥ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä¸ä¼šè¢« YML è§£æå™¨è½¬æ¢ä¸º True æˆ– Falseã€‚</p><p>ä¸€èˆ¬ arg æ ‡ç­¾çš„å˜é‡ä»…ç”¨åœ¨æ„å»ºè¿‡ç¨‹ä¸­ã€‚è€Œ<code>environment</code>å’Œ Dockerfile ä¸­çš„<code>ENV</code>æŒ‡ä»¤ä¸€æ ·ä¼šæŠŠå˜é‡ä¸€ç›´ä¿å­˜åœ¨é•œåƒã€å®¹å™¨ä¸­ï¼Œç±»ä¼¼<code>docker run -e</code>çš„æ•ˆæœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>environment:
</span></span><span class=line><span class=cl>  RACK_ENV: development
</span></span><span class=line><span class=cl>  SHOW: &#39;true&#39;
</span></span><span class=line><span class=cl>  SESSION_SECRET:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>environment:
</span></span><span class=line><span class=cl>  - RACK_ENV=development
</span></span><span class=line><span class=cl>  - SHOW=true
</span></span><span class=line><span class=cl>  - SESSION_SECRET
</span></span></code></pre></td></tr></table></div></div><a href=#expose><h2 id=expose><span class=hanchor arialabel=Anchor># </span>expose</h2></a><p>æš´éœ²ç«¯å£ï¼Œä½†ä¸æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œåªè¢«è¿æ¥çš„æœåŠ¡è®¿é—®ã€‚è¿™ä¸ªæ ‡ç­¾ä¸ Dockerfile ä¸­çš„<code>EXPOSE</code>æŒ‡ä»¤ä¸€æ ·ï¼Œç”¨äºæŒ‡å®šæš´éœ²çš„ç«¯å£ï¼Œä½†æ˜¯åªæ˜¯ä½œä¸ºä¸€ç§å‚è€ƒï¼Œå®é™…ä¸Š<code>docker-compose.yml</code>çš„ç«¯å£æ˜ å°„è¿˜å¾—<code>ports</code>è¿™æ ·çš„æ ‡ç­¾ã€‚</p><a href=#external_links><h2 id=external_links><span class=hanchor arialabel=Anchor># </span>external_links</h2></a><p>é“¾æ¥åˆ° docker-compose.yml å¤–éƒ¨çš„å®¹å™¨ï¼Œç”šè‡³ å¹¶é Compose é¡¹ç›®æ–‡ä»¶ç®¡ç†çš„å®¹å™¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>external_links:
</span></span><span class=line><span class=cl>  - redis_1
</span></span><span class=line><span class=cl>  - project_db_1:mysql
</span></span><span class=line><span class=cl>  - project_db_1:postgresql
</span></span></code></pre></td></tr></table></div></div><a href=#extra_hosts><h2 id=extra_hosts><span class=hanchor arialabel=Anchor># </span>extra_hosts</h2></a><p>æ·»åŠ ä¸»æœºåæ˜ å°„ã€‚ç±»ä¼¼ docker client &ndash;add-hostã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>extra_hosts:
</span></span><span class=line><span class=cl>  - &#34;somehost:162.242.195.82&#34;
</span></span><span class=line><span class=cl>  - &#34;otherhost:50.31.209.229&#34;
</span></span></code></pre></td></tr></table></div></div><p>ä¼šå¾€<code>/etc/hosts</code>æ–‡ä»¶ä¸­æ·»åŠ ä¸€äº›è®°å½•ï¼Œå¯åŠ¨ä¹‹åæŸ¥çœ‹å®¹å™¨å†…éƒ¨ hostså¯ä»¥çœ‹åˆ°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>162.242.195.82  somehost
</span></span><span class=line><span class=cl>50.31.209.229   otherhost
</span></span></code></pre></td></tr></table></div></div><a href=#healthcheck><h2 id=healthcheck><span class=hanchor arialabel=Anchor># </span>healthcheck</h2></a><p>é…ç½®è¿è¡Œçš„æ£€æŸ¥ä»¥ç¡®å®šæ­¤æœåŠ¡çš„å®¹å™¨æ˜¯å¦â€œå¥åº·â€ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>healthcheck:
</span></span><span class=line><span class=cl>  test: [&#34;CMD&#34;, &#34;curl&#34;, &#34;-f&#34;, &#34;http://localhost&#34;]
</span></span><span class=line><span class=cl>  interval: 1m30s
</span></span><span class=line><span class=cl>  timeout: 10s
</span></span><span class=line><span class=cl>  retries: 3
</span></span><span class=line><span class=cl>  start_period: 40s
</span></span></code></pre></td></tr></table></div></div><p><code>interval</code>ï¼Œ<code>timeout å’Œ start_period</code>éƒ½æ˜¯æŒç»­æ—¶é—´ã€‚<code>test</code>å¿…é¡»æ˜¯å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ã€‚å¦‚æœæ˜¯åˆ—è¡¨ï¼Œåˆ™ç¬¬ä¸€é¡¹å¿…é¡»æ˜¯<code>NONE</code>,<code>CMD</code>æˆ–<code>CMD-SHELL</code>ã€‚å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ç›¸å½“äºæŒ‡å®š<code>CMD-SHELL</code>åè·Ÿè¯¥å­—ç¬¦ä¸²ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=n>Hit</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=k>local</span><span class=w> </span><span class=n>web</span><span class=w> </span><span class=n>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>test</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;CMD&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;curl&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-f&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;http://localhost&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>test</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;CMD-SHELL&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;curl -f http://localhost || exit 1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>test</span><span class=p>:</span><span class=w> </span><span class=n>curl</span><span class=w> </span><span class=o>-</span><span class=n>f</span><span class=w> </span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>exit</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚æœéœ€è¦ç¦ç”¨é•œåƒçš„æ‰€æœ‰æ£€æŸ¥é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨<code>disable:true</code>ï¼Œç›¸å½“äº<code>test:["NONE"]</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>healthcheck:
</span></span><span class=line><span class=cl>  disable: true 
</span></span></code></pre></td></tr></table></div></div><a href=#image><h2 id=image><span class=hanchor arialabel=Anchor># </span>image</h2></a><p>ä»æŒ‡å®šçš„é•œåƒä¸­å¯åŠ¨å®¹å™¨ï¼Œå¯ä»¥æ˜¯å­˜å‚¨ä»“åº“ã€æ ‡ç­¾ä»¥åŠé•œåƒ ID</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>ubuntu</span><span class=p>:</span><span class=mi>14</span><span class=p>.</span><span class=mi>04</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>tutum</span><span class=o>/</span><span class=n>influxdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>example</span><span class=o>-</span><span class=n>registry</span><span class=p>.</span><span class=n>com</span><span class=p>:</span><span class=mi>4000</span><span class=o>/</span><span class=n>postgresql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>a4bc65fd</span><span class=w> </span><span class=o>#</span><span class=w> </span><span class=err>é•œåƒ</span><span class=n>id</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#init><h2 id=init><span class=hanchor arialabel=Anchor># </span>init</h2></a><p>åœ¨å®¹å™¨å†…è¿è¡Œä¸€ä¸ª init æ¥è½¬å‘ä¿¡å·å’Œå–å¾—è¿›ç¨‹ã€‚å°†æ­¤é€‰é¡¹è®¾ç½®<code>true</code>ä¸ºæœåŠ¡å¯ç”¨æ­¤åŠŸèƒ½ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  web:
</span></span><span class=line><span class=cl>    image: alpine:latest
</span></span><span class=line><span class=cl>    init: true
</span></span></code></pre></td></tr></table></div></div><a href=#isolation><h2 id=isolation><span class=hanchor arialabel=Anchor># </span>isolation</h2></a><p>æŒ‡å®šå®¹å™¨çš„éš”ç¦»æŠ€æœ¯ã€‚åœ¨ Linux ä¸Šï¼Œå”¯ä¸€æ”¯æŒçš„å€¼æ˜¯<code>default</code>ã€‚åœ¨ Windows ä¸Šï¼Œå¯æ¥å—çš„å€¼ä¸º<code>default</code>ã€<code>process</code>å’Œ<code>hyperv</code>ã€‚</p><a href=#labels><h2 id=labels><span class=hanchor arialabel=Anchor># </span>labels</h2></a><p>ä½¿ç”¨ Docker æ ‡ç­¾å°†å…ƒæ•°æ®æ·»åŠ åˆ°å®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨æ•°ç»„æˆ–å­—å…¸ã€‚ä¸ Dockerfile ä¸­çš„<code>LABELS</code>ç±»ä¼¼ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>labels:
</span></span><span class=line><span class=cl>  - &#34;com.example.description=Accounting webapp&#34;
</span></span><span class=line><span class=cl>  - &#34;com.example.department=Finance&#34;
</span></span><span class=line><span class=cl>  - &#34;com.example.label-with-empty-value&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>labels:
</span></span><span class=line><span class=cl>  com.example.description: &#34;Accounting webapp&#34;
</span></span><span class=line><span class=cl>  com.example.department: &#34;Finance&#34;
</span></span><span class=line><span class=cl>  com.example.label-with-empty-value: &#34;&#34;
</span></span></code></pre></td></tr></table></div></div><a href=#links><h2 id=links><span class=hanchor arialabel=Anchor># </span>links</h2></a><p>é“¾æ¥åˆ°å¦ä¸€ä¸ªæœåŠ¡ä¸­çš„å®¹å™¨ã€‚æŒ‡å®šæœåŠ¡åç§°å’Œé“¾æ¥åˆ«å (<code>"SERVICE:ALIAS"</code>)ï¼Œæˆ–ä»…æŒ‡å®šæœåŠ¡åç§°ã€‚</p><p>å®ƒä»¬ä¸éœ€è¦å¯ç”¨æœåŠ¡è¿›è¡Œé€šä¿¡ - é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•æœåŠ¡éƒ½å¯ä»¥ä»¥è¯¥æœåŠ¡çš„åç§°è®¿é—®ä»»ä½•å…¶ä»–æœåŠ¡ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œ<code>web</code>å¯ä»¥è®¿é—®<code>dbï¼Œå¹¶ä¸”è®¾ç½®åˆ«åä¸ºdatabase</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  web:
</span></span><span class=line><span class=cl>    build: .
</span></span><span class=line><span class=cl>    links:
</span></span><span class=line><span class=cl>      - &#34;db:database&#34;
</span></span><span class=line><span class=cl>  db:
</span></span><span class=line><span class=cl>    image: postgres
</span></span></code></pre></td></tr></table></div></div><a href=#logging><h2 id=logging><span class=hanchor arialabel=Anchor># </span>logging</h2></a><p>æ—¥å¿—è®°å½•é…ç½®ã€‚</p><p>driverï¼šæŒ‡å®šæœåŠ¡å®¹å™¨çš„æ—¥å¿—è®°å½•é©±åŠ¨ç¨‹åºï¼Œé»˜è®¤å€¼ä¸ºjson-fileã€‚æœ‰ä»¥ä¸‹ä¸‰ä¸ªé€‰é¡¹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;json-file&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;syslog&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;none&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä»…åœ¨ json-file é©±åŠ¨ç¨‹åºä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼Œé™åˆ¶æ—¥å¿—å¾—æ•°é‡å’Œå¤§å°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  some-service:
</span></span><span class=line><span class=cl>    image: some-service
</span></span><span class=line><span class=cl>    logging:
</span></span><span class=line><span class=cl>      driver: &#34;json-file&#34;
</span></span><span class=line><span class=cl>      options:
</span></span><span class=line><span class=cl>        max-size: &#34;200k&#34;
</span></span><span class=line><span class=cl>        max-file: &#34;10&#34;
</span></span><span class=line><span class=cl>network_mode
</span></span></code></pre></td></tr></table></div></div><p>å½“è¾¾åˆ°æ–‡ä»¶é™åˆ¶ä¸Šé™ï¼Œä¼šè‡ªåŠ¨åˆ é™¤æ—§å¾—æ–‡ä»¶ã€‚</p><p>syslog é©±åŠ¨ç¨‹åºä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ syslog-address æŒ‡å®šæ—¥å¿—æ¥æ”¶åœ°å€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=n>logging</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=n>syslog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>options</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>syslog</span><span class=o>-</span><span class=n>address</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tcp://192.168.0.42:123&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#network_mode><h2 id=network_mode><span class=hanchor arialabel=Anchor># </span>network_mode</h2></a><p>ç½‘ç»œæ¨¡å¼ã€‚ä½¿ç”¨ä¸ docker å®¢æˆ·ç«¯<code>--network</code>ç›¸åŒï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ®Šå½¢å¼<code>service:[service name]</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>network_mode: <span class=s2>&#34;bridge&#34;</span>
</span></span><span class=line><span class=cl>network_mode: <span class=s2>&#34;host&#34;</span>
</span></span><span class=line><span class=cl>network_mode: <span class=s2>&#34;none&#34;</span>
</span></span><span class=line><span class=cl>network_mode: <span class=s2>&#34;service:[service name]&#34;</span>
</span></span><span class=line><span class=cl>network_mode: <span class=s2>&#34;container:[container name/id]&#34;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#pid><h2 id=pid><span class=hanchor arialabel=Anchor># </span>pid</h2></a><p>å°† PID æ¨¡å¼è®¾ç½®ä¸ºä¸»æœº PID æ¨¡å¼ã€‚è¿™ä¼šåœ¨å®¹å™¨å’Œä¸»æœºæ“ä½œç³»ç»Ÿä¹‹é—´å…±äº« PID åœ°å€ç©ºé—´ã€‚ä½¿ç”¨æ­¤æ ‡å¿—å¯åŠ¨çš„å®¹å™¨å¯ä»¥è®¿é—®å’Œæ“ä½œè£¸æœºå‘½åç©ºé—´ä¸­çš„å…¶ä»–å®¹å™¨ï¼Œåä¹‹äº¦ç„¶ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>pid: &#34;host&#34;
</span></span></code></pre></td></tr></table></div></div><a href=#ports><h2 id=ports><span class=hanchor arialabel=Anchor># </span>ports</h2></a><p>æš´éœ²ç«¯å£ã€‚</p><p>ç®€çŸ­è¯­æ³•</p><p>å…±æœ‰ä¸‰ç§å†™æ³•ï¼š</p><ul><li><p>æŒ‡å®šä¸¤ä¸ªç«¯å£ ( <code>HOST:CONTAINER</code>)</p></li><li><p>ä»…æŒ‡å®šå®¹å™¨ç«¯å£ï¼ˆä¸ºä¸»æœºç«¯å£é€‰æ‹©äº†ä¸€ä¸ªä¸´æ—¶ä¸»æœºç«¯å£ï¼‰ã€‚</p></li><li><p>æŒ‡å®šè¦ç»‘å®šåˆ°ä¸¤ä¸ªç«¯å£çš„ä¸»æœº IP åœ°å€ï¼ˆé»˜è®¤ä¸º 0.0.0.0ï¼Œè¡¨ç¤ºæ‰€æœ‰æ¥å£ï¼‰ï¼š( <code>IPADDR:HOSTPORT:CONTAINERPORT</code>)ã€‚å¦‚æœ HOSTPORT ä¸ºç©ºï¼ˆä¾‹å¦‚<code>127.0.0.1::80</code>ï¼‰ï¼Œåˆ™ä¼šé€‰æ‹©ä¸€ä¸ªä¸´æ—¶ç«¯å£æ¥ç»‘å®šåˆ°ä¸»æœºä¸Šã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>ports:
</span></span><span class=line><span class=cl>  - &#34;3000&#34;
</span></span><span class=line><span class=cl>  - &#34;3000-3005&#34;
</span></span><span class=line><span class=cl>  - &#34;8000:8000&#34;
</span></span><span class=line><span class=cl>  - &#34;9090-9091:8080-8081&#34;
</span></span><span class=line><span class=cl>  - &#34;49100:22&#34;
</span></span><span class=line><span class=cl>  - &#34;127.0.0.1:8001:8001&#34;
</span></span><span class=line><span class=cl>  - &#34;127.0.0.1:5000-5010:5000-5010&#34;
</span></span><span class=line><span class=cl>  - &#34;127.0.0.1::5000&#34;
</span></span><span class=line><span class=cl>  - &#34;6060:6060/udp&#34;
</span></span><span class=line><span class=cl>  - &#34;12400-12500:1240&#34;
</span></span></code></pre></td></tr></table></div></div><p>é•¿è¯­æ³•</p><ul><li><p><code>target</code>: å®¹å™¨å†…çš„ç«¯å£</p></li><li><p><code>published</code>: å…¬å¼€çš„ç«¯å£</p></li><li><p><code>protocol</code>ï¼šç«¯å£åè®®ï¼ˆ<code>tcp</code>æˆ–<code>udp</code>ï¼‰</p></li><li><p><code>mode</code>ï¼š<code>host</code>ç”¨äºåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå‘å¸ƒä¸»æœºç«¯å£ï¼Œæˆ–<code>ingress</code>ç”¨äºè´Ÿè½½å¹³è¡¡çš„ç¾¤æ¨¡å¼ç«¯å£ã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>ports:
</span></span><span class=line><span class=cl>  - target: 80
</span></span><span class=line><span class=cl>    published: 8080
</span></span><span class=line><span class=cl>    protocol: tcp
</span></span><span class=line><span class=cl>    mode: host
</span></span></code></pre></td></tr></table></div></div><a href=#profiles><h2 id=profiles><span class=hanchor arialabel=Anchor># </span>profiles</h2></a><p>å…è®¸é€šè¿‡æœ‰é€‰æ‹©åœ°å¯ç”¨æœåŠ¡æ¥é’ˆå¯¹å„ç§ç”¨é€”å’Œç¯å¢ƒè°ƒæ•´ Compose åº”ç”¨ç¨‹åºæ¨¡å‹ã€‚è¿™æ˜¯é€šè¿‡å°†æ¯ä¸ªæœåŠ¡åˆ†é…ç»™å•ä¸ªæˆ–å¤šä¸ªé…ç½®æ–‡ä»¶æ¥å®ç°çš„ã€‚å¦‚æœæœªåˆ†é…ï¼Œåˆ™å§‹ç»ˆå¯åŠ¨è¯¥æœåŠ¡ï¼Œä½†å¦‚æœå·²åˆ†é…ï¼Œåˆ™ä»…åœ¨æ¿€æ´»é…ç½®æ–‡ä»¶æ—¶æ‰å¯åŠ¨ã€‚</p><p>è¿™å…è®¸äººä»¬åœ¨å•ä¸ª<code>docker-compose.yml</code>æ–‡ä»¶ä¸­å®šä¹‰é¢å¤–çš„æœåŠ¡ï¼Œè¿™äº›æœåŠ¡åº”è¯¥åªåœ¨ç‰¹å®šåœºæ™¯ä¸­å¯åŠ¨ï¼Œä¾‹å¦‚ç”¨äºè°ƒè¯•æˆ–å¼€å‘ä»»åŠ¡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>profiles: [&#34;frontend&#34;, &#34;debug&#34;]
</span></span><span class=line><span class=cl>profiles:
</span></span><span class=line><span class=cl>  - frontend
</span></span><span class=line><span class=cl>  - debug
</span></span></code></pre></td></tr></table></div></div><a href=#restart><h2 id=restart><span class=hanchor arialabel=Anchor># </span>restart</h2></a><p><code>no</code>æ˜¯é»˜è®¤çš„é‡å¯ç­–ç•¥ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šé‡å¯å®¹å™¨ã€‚å½“<code>always</code>æŒ‡å®šæ—¶ï¼Œå®¹å™¨æ€»æ˜¯é‡æ–°å¯åŠ¨ã€‚<code>on-failure</code>å¦‚æœé€€å‡ºä»£ç æŒ‡ç¤ºå¤±è´¥é”™è¯¯ï¼Œåˆ™è¯¥ç­–ç•¥ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ã€‚<code>unless-stopped</code>æ€»æ˜¯é‡æ–°å¯åŠ¨å®¹å™¨ï¼Œé™¤éå®¹å™¨åœæ­¢ï¼ˆæ‰‹åŠ¨æˆ–å…¶ä»–æ–¹å¼ï¼‰ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>restart: &#34;no&#34;
</span></span><span class=line><span class=cl>restart: always
</span></span><span class=line><span class=cl>restart: on-failure
</span></span><span class=line><span class=cl>restart: unless-stopped
</span></span></code></pre></td></tr></table></div></div><a href=#secrets><h2 id=secrets><span class=hanchor arialabel=Anchor># </span>secrets</h2></a><p>ä¸ºæ¯ä¸ªæœåŠ¡æœºå¯†æˆäºˆç›¸åº”çš„è®¿é—®æƒé™</p><p>ç®€çŸ­è¯­æ³•</p><p>ç®€çŸ­çš„è¯­æ³•ä»…æŒ‡å®šæœºå¯†åç§°ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹æˆäºˆ<code>redis</code>æœåŠ¡å¯¹<code>my_secret</code>å’Œ<code>my_other_secret</code>æœºå¯†çš„è®¿é—®æƒé™ã€‚<code>./my_secret.txt</code>æ–‡ä»¶çš„å†…å®¹è¢«è®¾ç½®ä¸º my_secretï¼Œ<code>my_other_secret</code>è¢«å®šä¹‰ä¸ºå¤–éƒ¨æœºå¯†ï¼Œè¿™æ„å‘³ç€å®ƒå·²ç»åœ¨Dockerä¸­å®šä¹‰ï¼Œæ— è®ºæ˜¯é€šè¿‡è¿è¡Œ<code>docker secret create</code>å‘½ä»¤è¿˜æ˜¯é€šè¿‡å¦ä¸€ä¸ªå †æ ˆéƒ¨ç½²ï¼Œéƒ½ä¸ä¼šé‡æ–°åˆ›å»ºã€‚å¦‚æœå¤–éƒ¨æœºå¯†ä¸å­˜åœ¨ï¼Œå †æ ˆéƒ¨ç½²å°†å¤±è´¥å¹¶æ˜¾ç¤º<code>secret not found</code>é”™è¯¯ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  redis:
</span></span><span class=line><span class=cl>    image: redis:latest
</span></span><span class=line><span class=cl>    deploy:
</span></span><span class=line><span class=cl>      replicas: 1
</span></span><span class=line><span class=cl>    secrets:
</span></span><span class=line><span class=cl>      - my_secret
</span></span><span class=line><span class=cl>      - my_other_secret
</span></span><span class=line><span class=cl>secrets:
</span></span><span class=line><span class=cl>  my_secret:
</span></span><span class=line><span class=cl>    file: ./my_secret.txt
</span></span><span class=line><span class=cl>  my_other_secret:
</span></span><span class=line><span class=cl>    external: true
</span></span></code></pre></td></tr></table></div></div><p>é•¿è¯­æ³•</p><ul><li><p><code>source</code>ï¼šå®šä¹‰æœºå¯†æ ‡è¯†ç¬¦ã€‚</p></li><li><p><code>target</code>ï¼šè¦æŒ‚è½½åœ¨<code>/run/secrets/</code>æœåŠ¡çš„ä»»åŠ¡å®¹å™¨ä¸­çš„æ–‡ä»¶çš„åç§°ï¼Œé»˜è®¤æ˜¯ sourceã€‚</p></li><li><p><code>uid</code>å’Œ<code>gid</code>ï¼š<code>/run/secrets/</code>åœ¨æœåŠ¡çš„ä»»åŠ¡å®¹å™¨ä¸­æ‹¥æœ‰æ–‡ä»¶çš„æ•°å­— UID æˆ– GID ã€‚</p></li><li><p><code>mode</code>ï¼šè¦æŒ‚è½½åœ¨<code>/run/secrets/</code> æœåŠ¡çš„ä»»åŠ¡å®¹å™¨ä¸­çš„æ–‡ä»¶çš„æƒé™ï¼Œä»¥å…«è¿›åˆ¶è¡¨ç¤ºæ³•ã€‚ä¾‹å¦‚ï¼Œ<code>0444</code> ä»£è¡¨å¯è¯»ã€‚</p></li></ul><p>ä¸‹é¢çš„ç¤ºä¾‹è¡¨ç¤ºå°†my_secret å‘½åä¸º<code>redis_secret</code>ï¼Œæ¨¡å¼ä¸º<code>0440</code>ï¼ˆç»„å¯è¯»ï¼‰ï¼Œå’Œç”¨æˆ·ç»„ä¸º<code>103</code>ã€‚è¯¥<code>redis</code>æœåŠ¡æ— æƒè®¿é—®è¯¥<code>my_other_secret</code>æœºå¯†ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  redis:
</span></span><span class=line><span class=cl>    image: redis:latest
</span></span><span class=line><span class=cl>    deploy:
</span></span><span class=line><span class=cl>      replicas: 1
</span></span><span class=line><span class=cl>    secrets:
</span></span><span class=line><span class=cl>      - source: my_secret
</span></span><span class=line><span class=cl>        target: redis_secret
</span></span><span class=line><span class=cl>        uid: &#39;103&#39;
</span></span><span class=line><span class=cl>        gid: &#39;103&#39;
</span></span><span class=line><span class=cl>        mode: 0440
</span></span><span class=line><span class=cl>secrets:
</span></span><span class=line><span class=cl>  my_secret:
</span></span><span class=line><span class=cl>    file: ./my_secret.txt
</span></span><span class=line><span class=cl>  my_other_secret:
</span></span><span class=line><span class=cl>    external: true
</span></span></code></pre></td></tr></table></div></div><p>ä¸€çº§<code>secrets</code>è¯¦ç»†é…ç½®ï¼š</p><ul><li><p><code>file</code>ï¼šä½¿ç”¨æŒ‡å®šè·¯å¾„ä¸­çš„æ–‡ä»¶å†…å®¹åˆ›å»ºæœºå¯†ã€‚</p></li><li><p><code>external</code>ï¼šå¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™æŒ‡å®šæ­¤æœºå¯†å·²åˆ›å»ºã€‚Docker ä¸ä¼šå°è¯•åˆ›å»ºå®ƒï¼Œå¦‚æœå®ƒä¸å­˜åœ¨ï¼Œ ä¼šæŠ¥é”™<code>secret not found</code>ã€‚</p></li><li><p><code>name</code>ï¼šDocker ä¸­ç§˜å¯†å¯¹è±¡çš„åç§°ã€‚æ­¤å­—æ®µå¯ç”¨äºå¼•ç”¨åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æœºå¯†ã€‚</p></li><li><p><code>template_driver</code>ï¼šè¦ä½¿ç”¨çš„æ¨¡æ¿é©±åŠ¨ç¨‹åºçš„åç§°ï¼Œå®ƒæ§åˆ¶æ˜¯å¦ä»¥åŠå¦‚ä½•å°†æœºå¯†è´Ÿè½½è¯„ä¼°ä¸ºæ¨¡æ¿ã€‚å¦‚æœæœªè®¾ç½®é©±åŠ¨ç¨‹åºï¼Œåˆ™ä¸ä½¿ç”¨æ¨¡æ¿ã€‚å½“å‰æ”¯æŒçš„å”¯ä¸€é©±åŠ¨ç¨‹åºæ˜¯<code>golang</code>ï¼Œå®ƒä½¿ç”¨<code>golang</code>ã€‚</p></li></ul><p>åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œ<code>my_first_secret</code>åœ¨<code>&lt;stack_name>_my_first_secret</code> éƒ¨ç½²å †æ ˆæ—¶åˆ›å»º ï¼Œå¹¶ä¸”<code>my_second_secret</code>å·²å­˜åœ¨äº Docker ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>secrets:
</span></span><span class=line><span class=cl>  my_first_secret:
</span></span><span class=line><span class=cl>    file: ./secret_data
</span></span><span class=line><span class=cl>  my_second_secret:
</span></span><span class=line><span class=cl>    external: true 
</span></span></code></pre></td></tr></table></div></div><a href=#security_opt><h2 id=security_opt><span class=hanchor arialabel=Anchor># </span>security_opt</h2></a><p>ä¸ºæ¯ä¸ªå®¹å™¨è¦†ç›–é»˜è®¤çš„æ ‡ç­¾ã€‚ç®€å•è¯´æ¥å°±æ˜¯ç®¡ç†å…¨éƒ¨æœåŠ¡çš„æ ‡ç­¾ï¼Œæ¯”å¦‚è®¾ç½®å…¨éƒ¨æœåŠ¡çš„ user æ ‡ç­¾å€¼ä¸º<code>USER</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>security_opt:
</span></span><span class=line><span class=cl>  - label:user:USER
</span></span><span class=line><span class=cl>  - label:role:ROLE 
</span></span></code></pre></td></tr></table></div></div><a href=#stop_grace_period><h2 id=stop_grace_period><span class=hanchor arialabel=Anchor># </span>stop_grace_period</h2></a><p>æŒ‡å®šåœ¨å°è¯•åœæ­¢å®¹å™¨æ—¶ç­‰å¾…å¤šé•¿æ—¶é—´ã€‚</p><p>åœ¨docker stopå‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå…ˆå‘å®¹å™¨ä¸­çš„è¿›ç¨‹å‘é€ç³»ç»Ÿä¿¡å·SIGTERMï¼Œç„¶åç­‰å¾…å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºç»ˆæ­¢æ‰§è¡Œã€‚å¦‚æœç­‰å¾…æ—¶é—´è¾¾åˆ°è®¾å®šçš„è¶…æ—¶æ—¶é—´ï¼Œæˆ–è€…é»˜è®¤çš„10ç§’ï¼Œä¼šç»§ç»­å‘é€SIGKILLçš„ç³»ç»Ÿä¿¡å·å¼ºè¡Œkillæ‰è¿›ç¨‹ã€‚</p><p>åœ¨å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥é€‰æ‹©å¿½ç•¥å’Œä¸å¤„ç†SIGTERMä¿¡å·ï¼Œä¸è¿‡ä¸€æ—¦è¾¾åˆ°è¶…æ—¶æ—¶é—´ï¼Œç¨‹åºå°±ä¼šè¢«ç³»ç»Ÿå¼ºè¡Œkillæ‰ï¼Œå› ä¸ºSIGKILLä¿¡å·æ˜¯ç›´æ¥å‘å¾€ç³»ç»Ÿå†…æ ¸çš„ï¼Œåº”ç”¨ç¨‹åºæ²¡æœ‰æœºä¼šå»å¤„ç†å®ƒã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>stop_grace_period: 1s
</span></span></code></pre></td></tr></table></div></div><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>stop</code>åœ¨å‘é€ SIGKILL ä¹‹å‰ç­‰å¾…å®¹å™¨é€€å‡º 10 ç§’ã€‚</p><a href=#stop_signal><h2 id=stop_signal><span class=hanchor arialabel=Anchor># </span>stop_signal</h2></a><p>è®¾ç½®ä¸€ä¸ªæ›¿ä»£ä¿¡å·æ¥åœæ­¢å®¹å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹<code>stop</code>ä½¿ç”¨ SIGTERMã€‚ä½¿ç”¨<code>stop_signal</code>è®¾ç½®æ›¿ä»£ä¿¡å·æ¥<code>stop</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>stop_signal: SIGUSR1
</span></span></code></pre></td></tr></table></div></div><a href=#sysctls><h2 id=sysctls><span class=hanchor arialabel=Anchor># </span>sysctls</h2></a><p>åœ¨å®¹å™¨ä¸­è®¾ç½®çš„å†…æ ¸å‚æ•°ï¼Œå¯ä»¥ä¸ºæ•°ç»„æˆ–å­—å…¸</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>sysctls:
</span></span><span class=line><span class=cl>  net.core.somaxconn: 1024
</span></span><span class=line><span class=cl>  net.ipv4.tcp_syncookies: 0
</span></span></code></pre></td></tr></table></div></div><a href=#tmpfs><h2 id=tmpfs><span class=hanchor arialabel=Anchor># </span>tmpfs</h2></a><p>åœ¨å®¹å™¨å†…æŒ‚è½½ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿã€‚å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–åˆ—è¡¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>tmpfs: /run
</span></span><span class=line><span class=cl>tmpfs:
</span></span><span class=line><span class=cl>  - /run
</span></span><span class=line><span class=cl>  - /tmp
</span></span></code></pre></td></tr></table></div></div><a href=#ulimits><h2 id=ulimits><span class=hanchor arialabel=Anchor># </span>ulimits</h2></a><p>è®¾ç½®å½“å‰è¿›ç¨‹ä»¥åŠå…¶å­è¿›ç¨‹çš„èµ„æºä½¿ç”¨é‡ï¼Œè¦†ç›–å®¹å™¨çš„é»˜è®¤é™åˆ¶ï¼Œå¯ä»¥å•ä¸€åœ°å°†é™åˆ¶å€¼è®¾ä¸ºä¸€ä¸ªæ•´æ•°ï¼Œä¹Ÿå¯ä»¥å°†<code>soft/hard</code>é™åˆ¶æŒ‡å®šä¸ºæ˜ å°„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>ulimits:
</span></span><span class=line><span class=cl>  nproc: 65535
</span></span><span class=line><span class=cl>  nofile:
</span></span><span class=line><span class=cl>    soft: 20000
</span></span><span class=line><span class=cl>    hard: 40000
</span></span></code></pre></td></tr></table></div></div><a href=#userns_mode><h2 id=userns_mode><span class=hanchor arialabel=Anchor># </span>userns_mode</h2></a><p>å¦‚æœ Docker å®ˆæŠ¤ç¨‹åºé…ç½®äº†ç”¨æˆ·å‘½åç©ºé—´ï¼Œåˆ™ç¦ç”¨æ­¤æœåŠ¡çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>userns_mode: &#34;host&#34;
</span></span></code></pre></td></tr></table></div></div><a href=#volumes><h2 id=volumes><span class=hanchor arialabel=Anchor># </span>volumes</h2></a><p>æŒ‚è½½ä¸€ä¸ªç›®å½•æˆ–è€…ä¸€ä¸ªå·²å­˜åœ¨çš„æ•°æ®å·å®¹å™¨ï¼Œ</p><ul><li><p>å¯ä»¥ç›´æ¥ä½¿ç”¨<code>HOST:CONTAINER</code>è¿™æ ·çš„æ ¼å¼ï¼Œ</p></li><li><p>æˆ–è€…ä½¿ç”¨<code>HOST:CONTAINER:ro</code>è¿™æ ·çš„æ ¼å¼ï¼Œåè€…å¯¹äºå®¹å™¨æ¥è¯´ï¼Œæ•°æ®å·æ˜¯åªè¯»çš„ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆä¿æŠ¤å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿ</p></li></ul><p>æ‚¨å¯ä»¥å°†ä¸»æœºè·¯å¾„æŒ‚è½½ä¸ºå•ä¸ªæœåŠ¡å®šä¹‰çš„ä¸€éƒ¨åˆ†ï¼Œæ— éœ€åœ¨ä¸€çº§<code>volumes</code>é”®ä¸­å®šä¹‰å®ƒã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æƒ³åœ¨å¤šä¸ªæœåŠ¡ä¸­é‡ç”¨ä¸€ä¸ªå·ï¼Œåˆ™éœ€è¦åœ¨ä¸€çº§volumes ä¸­å®šä¹‰ä¸€ä¸ªå‘½åå·ã€‚</p><p>å¦‚ä¸‹å®ä¾‹ï¼Œweb æœåŠ¡ä½¿ç”¨å‘½åå· (<code>mydata</code>)ï¼Œä»¥åŠä¸ºå•ä¸ªæœåŠ¡å®šä¹‰çš„ç»‘å®šå®‰è£…ï¼ˆ<code>db</code>serviceä¸‹çš„ç¬¬ä¸€ä¸ªè·¯å¾„<code>volumes</code>ï¼‰ã€‚<code>db</code>æœåŠ¡è¿˜ä½¿ç”¨åä¸º<code>dbdata</code>ï¼ˆ<code>db</code>serviceä¸‹çš„ç¬¬äºŒä¸ªè·¯å¾„<code>volumes</code>ï¼‰çš„å‘½åå·ï¼Œä½¿ç”¨äº†æ—§å­—ç¬¦ä¸²æ ¼å¼å®šä¹‰å®ƒä»¥å®‰è£…å‘½åå·ã€‚å‘½åå·å¿…é¡»åˆ—åœ¨é¡¶çº§<code>volumes</code>é”®ä¸‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  web:
</span></span><span class=line><span class=cl>    image: nginx:alpine
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - type: volume
</span></span><span class=line><span class=cl>        source: mydata
</span></span><span class=line><span class=cl>        target: /data
</span></span><span class=line><span class=cl>        volume:
</span></span><span class=line><span class=cl>          nocopy: true
</span></span><span class=line><span class=cl>      - type: bind
</span></span><span class=line><span class=cl>        source: ./static
</span></span><span class=line><span class=cl>        target: /opt/app/static
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  db:
</span></span><span class=line><span class=cl>    image: postgres:latest
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - &#34;/var/run/postgres/postgres.sock:/var/run/postgres/postgres.sock&#34;
</span></span><span class=line><span class=cl>      - &#34;dbdata:/var/lib/postgresql/data&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>  mydata:
</span></span><span class=line><span class=cl>  dbdata:
</span></span></code></pre></td></tr></table></div></div><a href=#ç®€çŸ­è¯­æ³•><h4 id=ç®€çŸ­è¯­æ³•><span class=hanchor arialabel=Anchor># </span>ç®€çŸ­è¯­æ³•</h4></a><p>ç®€çŸ­è¯­æ³•ä½¿ç”¨é€šç”¨<code>[SOURCE:]TARGET[:MODE]</code>æ ¼å¼ï¼Œå…¶ä¸­ <code>SOURCE</code>å¯ä»¥æ˜¯ä¸»æœºè·¯å¾„æˆ–å·åã€‚<code>TARGET</code>æ˜¯å®‰è£…å·çš„å®¹å™¨è·¯å¾„ã€‚æ ‡å‡†æ¨¡å¼<code>ro</code>ç”¨äºåªè¯»å’Œ<code>rw</code>è¯»å†™ï¼ˆé»˜è®¤ï¼‰ã€‚</p><p>æ‚¨å¯ä»¥åœ¨ä¸»æœºä¸ŠæŒ‚è½½ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œè¯¥è·¯å¾„ç›¸å¯¹äºæ­£åœ¨ä½¿ç”¨çš„ Compose é…ç½®æ–‡ä»¶çš„ç›®å½•å±•å¼€ã€‚ç›¸å¯¹è·¯å¾„åº”å§‹ç»ˆä»¥<code>.</code>æˆ–å¼€å¤´<code>..</code>ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>  # Just specify a path and let the Engine create a volume
</span></span><span class=line><span class=cl>  - /var/lib/mysql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  # Specify an absolute path mapping
</span></span><span class=line><span class=cl>  - /opt/data:/var/lib/mysql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  # Path on the host, relative to the Compose file
</span></span><span class=line><span class=cl>  - ./cache:/tmp/cache
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  # User-relative path
</span></span><span class=line><span class=cl>  - ~/configs:/etc/configs/:ro
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  # å‘½åå·
</span></span><span class=line><span class=cl>  - datavolume:/var/lib/mysql
</span></span></code></pre></td></tr></table></div></div><a href=#é•¿è¯­æ³•><h4 id=é•¿è¯­æ³•><span class=hanchor arialabel=Anchor># </span>é•¿è¯­æ³•</h4></a><ul><li><p><code>type</code>: å®‰è£…ç±»å‹ï¼Œ <code>bind</code>,<code>tmpfs</code>æˆ–<code>npipe</code></p></li><li><p><code>source</code>: å®‰è£…æºã€ä¸»æœºä¸Šç”¨äºç»‘å®šå®‰è£…çš„è·¯å¾„æˆ–åœ¨é¡¶çº§volumes ä¸­å®šä¹‰çš„å·çš„åç§° ã€‚ä¸é€‚ç”¨äº tmpfs æŒ‚è½½ã€‚</p></li><li><p><code>target</code>ï¼šå®‰è£…å·çš„å®¹å™¨ä¸­çš„è·¯å¾„</p></li><li><p><code>read_only</code>: å°†å·è®¾ç½®ä¸ºåªè¯»çš„æ ‡å¿—</p></li><li><p><code>bind</code>: é…ç½®é¢å¤–çš„ç»‘å®šé€‰é¡¹</p></li></ul><ol><li><code>propagation</code>ï¼šç”¨äºç»‘å®šçš„ä¼ æ’­æ¨¡å¼</li></ol><p><code>volume</code>: é…ç½®é¢å¤–çš„é€‰é¡¹</p><ol><li><code>nocopy</code>: åˆ›å»ºå·æ—¶ç¦ç”¨ä»å®¹å™¨å¤åˆ¶æ•°æ®çš„æ ‡å¿—</li></ol><p><code>tmpfs</code>: é…ç½®é¢å¤–çš„ tmpfs é€‰é¡¹</p><ol><li><code>size</code>ï¼štmpfs æŒ‚è½½çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  web:
</span></span><span class=line><span class=cl>    image: nginx:alpine
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>      - &#34;80:80&#34;
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - type: volume
</span></span><span class=line><span class=cl>        source: mydata
</span></span><span class=line><span class=cl>        target: /data
</span></span><span class=line><span class=cl>        volume:
</span></span><span class=line><span class=cl>          nocopy: true
</span></span><span class=line><span class=cl>      - type: bind
</span></span><span class=line><span class=cl>        source: ./static
</span></span><span class=line><span class=cl>        target: /opt/app/static
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>networks:
</span></span><span class=line><span class=cl>  webnet:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>  mydata:
</span></span></code></pre></td></tr></table></div></div><a href=#ä¸€çº§-volume-è¯¦ç»†é…ç½®><h4 id=ä¸€çº§-volume-è¯¦ç»†é…ç½®><span class=hanchor arialabel=Anchor># </span>ä¸€çº§ Volume è¯¦ç»†é…ç½®ï¼š</h4></a><ul><li><p>driver æŒ‡å®šè¯¥å·åº”ä½¿ç”¨å“ªä¸ªå·é©±åŠ¨ç¨‹åº</p></li><li><p>driver_opts å°†é€‰é¡¹åˆ—è¡¨æŒ‡å®šä¸ºé”®å€¼å¯¹ä»¥ä¼ é€’ç»™æ­¤å·çš„é©±åŠ¨ç¨‹åº</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>  example:
</span></span><span class=line><span class=cl>    driver_opts:
</span></span><span class=line><span class=cl>      type: &#34;nfs&#34;
</span></span><span class=line><span class=cl>      o: &#34;addr=10.40.0.199,nolock,soft,rw&#34;
</span></span><span class=line><span class=cl>      device: &#34;:/docker/example&#34;
</span></span></code></pre></td></tr></table></div></div><ul><li><p>external å¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™æŒ‡å®šè¯¥å·æ˜¯åœ¨ Compose ä¹‹å¤–åˆ›å»ºçš„</p></li><li><p>labels æ·»åŠ å…ƒæ•°æ®</p></li><li><p>name ä¸ºæ­¤å·è®¾ç½®è‡ªå®šä¹‰åç§°</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>version: &#34;3.9&#34;
</span></span><span class=line><span class=cl>volumes:
</span></span><span class=line><span class=cl>  data:
</span></span><span class=line><span class=cl>    name: my-app-data
</span></span></code></pre></td></tr></table></div></div><a href=#å˜é‡ç½®æ¢><h2 id=å˜é‡ç½®æ¢><span class=hanchor arialabel=Anchor># </span>å˜é‡ç½®æ¢</h2></a><p>ä½ å¯ä»¥ä½¿ç”¨ $VARIABLE æˆ–è€… ${VARIABLE} æ¥ç½®æ¢å˜é‡</p><ul><li><p><code>${VARIABLE:-default}VARIABLE</code>åœ¨ç¯å¢ƒä¸­æœªè®¾ç½®æˆ–ä¸ºç©ºæ—¶è®¾ç½®ä¸ºdefaultã€‚</p></li><li><p><code>${VARIABLE-default}</code>ä»…å½“<code>VARIABLE</code>åœ¨ç¯å¢ƒä¸­æœªè®¾ç½®æ—¶æ‰è®¾ç½®ä¸ºdefaultã€‚</p></li><li><p><code>${VARIABLE:?err}</code>é€€å‡ºå¹¶æ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼Œå…¶ä¸­åŒ…å«ç¯å¢ƒä¸­çš„<code>err</code>if <code>VARIABLE</code>æœªè®¾ç½®æˆ–ä¸ºç©ºã€‚</p></li><li><p><code>${VARIABLE?err}</code>é€€å‡ºå¹¶æ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼Œå…¶ä¸­åŒ…å«<code>err</code>if <code>VARIABLE</code>åœ¨ç¯å¢ƒä¸­æœªè®¾ç½®ã€‚</p></li><li><p>å¦‚æœæƒ³ä½¿ç”¨ä¸€ä¸ªä¸è¢«composeå¤„ç†çš„å˜é‡ï¼Œå¯ç”¨ä½¿ç”¨</p></li></ul><p>ä¸€ä¸ªé…ç½®æ–‡ä»¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>zookeeper</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>docker</span><span class=p>.</span><span class=n>io</span><span class=o>/</span><span class=n>bitnami</span><span class=o>/</span><span class=n>zookeeper</span><span class=p>:</span><span class=mi>3</span><span class=p>.</span><span class=mi>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=s2>&#34;22181:2181&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=s2>&#34;zookeeper_data:/bitnami&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>ALLOW_ANONYMOUS_LOGIN</span><span class=o>=</span><span class=n>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>kafka</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>container_name</span><span class=p>:</span><span class=w> </span><span class=n>kafka1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>docker</span><span class=p>.</span><span class=n>io</span><span class=o>/</span><span class=n>bitnami</span><span class=o>/</span><span class=n>kafka</span><span class=p>:</span><span class=mi>3</span><span class=p>.</span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=s2>&#34;9192:9092&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=s2>&#34;kafka_data:/bitnami&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>KAFKA_CFG_ZOOKEEPER_CONNECT</span><span class=o>=</span><span class=n>zookeeper</span><span class=p>:</span><span class=mi>2181</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>ALLOW_PLAINTEXT_LISTENER</span><span class=o>=</span><span class=n>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>KAFKA_CFG_ADVERTISED_LISTENERS</span><span class=o>=</span><span class=n>PLAINTEXT</span><span class=p>:</span><span class=o>//</span><span class=err>å®¿ä¸»æœº</span><span class=n>ip</span><span class=p>:</span><span class=mi>9192</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE</span><span class=o>=</span><span class=k>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>-</span><span class=w> </span><span class=n>zookeeper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>kafka</span><span class=o>-</span><span class=n>ui</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>image</span><span class=p>:</span><span class=w> </span><span class=n>provectuslabs</span><span class=o>/</span><span class=n>kafka</span><span class=o>-</span><span class=n>ui</span><span class=p>:</span><span class=n>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>container_name</span><span class=p>:</span><span class=w> </span><span class=n>kafka</span><span class=o>-</span><span class=n>ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>restart</span><span class=p>:</span><span class=w> </span><span class=n>always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>-</span><span class=w> </span><span class=mi>10010</span><span class=p>:</span><span class=mi>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>-</span><span class=w> </span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=k>localtime</span><span class=p>:</span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=k>localtime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>KAFKA_CLUSTERS_0_NAME</span><span class=o>=</span><span class=k>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>-</span><span class=w> </span><span class=n>KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS</span><span class=o>=</span><span class=n>kafka1</span><span class=p>:</span><span class=mi>9092</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>zookeeper_data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=k>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>kafka_data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=k>local</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://quartz.jzhao.xyz/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Jacky Zhao using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2023</p><ul><li><a href=https://quartz.jzhao.xyz/>Home</a></li><li><a href=https://twitter.com/_jzhao>Twitter</a></li><li><a href=https://github.com/jackyzha0>GitHub</a></li></ul></footer></div></div></body></html>