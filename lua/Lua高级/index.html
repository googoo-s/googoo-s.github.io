<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="元表 元表 (metatable) 的表现行为类似于 C++ 语言中的操作符重载，例如我们可以重载 &ldquo;__add&rdquo; 元方法 (metamethod)，来计算两个 Lua 数组的并集；或者重载 &ldquo;__index&rdquo; 方法，来定义我们自己的 Hash 函数。Lua 提供了两个十分重要的用来处理元表的方法
  setmetatable(table, metatable)：此方法用于为一个表设置元表。"><meta property="og:title" content="Lua高级"><meta property="og:description" content="元表 元表 (metatable) 的表现行为类似于 C++ 语言中的操作符重载，例如我们可以重载 &ldquo;__add&rdquo; 元方法 (metamethod)，来计算两个 Lua 数组的并集；或者重载 &ldquo;__index&rdquo; 方法，来定义我们自己的 Hash 函数。Lua 提供了两个十分重要的用来处理元表的方法
  setmetatable(table, metatable)：此方法用于为一个表设置元表。"><meta property="og:type" content="website"><meta property="og:image" content="https://googoo-s.github.io/icon.png"><meta property="og:url" content="https://googoo-s.github.io/lua/Lua%E9%AB%98%E7%BA%A7/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lua高级"><meta name=twitter:description content="元表 元表 (metatable) 的表现行为类似于 C++ 语言中的操作符重载，例如我们可以重载 &ldquo;__add&rdquo; 元方法 (metamethod)，来计算两个 Lua 数组的并集；或者重载 &ldquo;__index&rdquo; 方法，来定义我们自己的 Hash 函数。Lua 提供了两个十分重要的用来处理元表的方法
  setmetatable(table, metatable)：此方法用于为一个表设置元表。"><meta name=twitter:image content="https://googoo-s.github.io/icon.png"><title>Lua高级</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://googoo-s.github.io//icon.png><link href=https://googoo-s.github.io/styles.19109a40042e9f0e72e952fda4442a34.min.css rel=stylesheet><link href=https://googoo-s.github.io/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://googoo-s.github.io/js/darkmode.953af745b0f9342644d632fc167f3727.min.js></script>
<script src=https://googoo-s.github.io/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script defer src=https://googoo-s.github.io/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://googoo-s.github.io/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://googoo-s.github.io/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://googoo-s.github.io/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://googoo-s.github.io/",fetchData=Promise.all([fetch("https://googoo-s.github.io/indices/linkIndex.f65387078bd3afa8657e01f74a9355e6.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://googoo-s.github.io/indices/contentIndex.e576b2ae648e555a918c9c8268be8ce3.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://googoo-s.github.io",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://googoo-s.github.io",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/googoo-s.github.io\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=googoo-s.github.io src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://googoo-s.github.io/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://googoo-s.github.io/>googoo-s 😄😸😎</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Lua高级</h1><p class=meta>Last updated
Jul 31, 2023</p><ul class=tags><li><a href=https://googoo-s.github.io/tags/lua/>Lua</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#元表>元表</a><ol><li><a href=#修改表的操作符行为><strong>修改表的操作符行为</strong></a></li><li><a href=#__index-元方法><strong>__index 元方法</strong></a></li><li><a href=#__tostring-元方法><strong>__tostring 元方法</strong></a></li><li><a href=#__call-元方法><strong>__call 元方法</strong></a></li><li><a href=#__metatable-元方法><strong>__metatable 元方法</strong></a></li></ol></li><li><a href=#面向对象>面向对象</a><ol><li><a href=#类>类</a></li><li><a href=#继承>继承</a></li><li><a href=#成员私有性>成员私有性</a></li></ol></li><li><a href=#局部变量>局部变量</a><ol><li><a href=#定义><strong>定义</strong></a></li><li><a href=#作用域><strong>作用域</strong></a></li><li><a href=#使用局部变量的好处>使用局部变量的好处</a></li><li><a href=#检测模块的函数使用局部变量>检测模块的函数使用局部变量</a></li></ol></li><li><a href=#判断数组的大小>判断数组的大小</a></li><li><a href=#非空判断>非空判断</a></li><li><a href=#正则表达式>正则表达式</a><ol><li><ol><li></li></ol></li></ol></li><li><a href=#虚变量>虚变量</a><ol><li><a href=#返回值>返回值</a></li><li><a href=#迭代>迭代</a></li></ol></li><li><a href=#抵制使用-module-定义模块><strong>抵制使用 module() 定义模块</strong></a><ol><li><a href=#调用函数前先定义函数>调用函数前先定义函数</a></li></ol></li><li><a href=#点号操作符和冒号操作符的区别>点号操作符和冒号操作符的区别</a></li><li><a href=#module的缺点>module的缺点</a></li><li><a href=#ffi>FFI</a><ol><li><a href=#ffi-库-词汇><strong>ffi 库 词汇</strong></a></li><li><a href=#ffi-api><em><em>ffi.</em> API</em>*</a></li></ol></li><li><a href=#jit>JIT</a><ol><li><a href=#可以被-jit-编译的元操作><strong>可以被 JIT 编译的元操作</strong></a><ol><li><a href=#基础库的支持情况><strong>基础库的支持情况</strong></a></li><li><a href=#字符串库><strong>字符串库</strong></a></li><li><a href=#表><strong>表</strong></a></li><li><a href=#math-库><strong>math 库</strong></a></li></ol></li></ol></li></ol></nav></details></aside><a href=#元表><h1 id=元表><span class=hanchor arialabel=Anchor># </span>元表</h1></a><p>元表 <em>(metatable)</em> 的<strong>表现行为类似于 C++ 语言中的操作符重载</strong>，例如我们可以重载 &ldquo;__add&rdquo; 元方法 <em>(metamethod)</em>，来计算两个 Lua 数组的并集；或者重载 &ldquo;__index&rdquo; 方法，来定义我们自己的 Hash 函数。Lua 提供了两个十分重要的用来处理元表的方法</p><ul><li><p>setmetatable(table, metatable)：此方法用于为一个表设置元表。</p></li><li><p>getmetatable(table)：此方法用于获取表的元表对象</p></li></ul><p>设置元表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>mytable</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>mymetatable</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=n>setmetatable</span><span class=p>(</span><span class=n>mytable</span><span class=p>,</span> <span class=n>mymetatable</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><a href=#修改表的操作符行为><h2 id=修改表的操作符行为><span class=hanchor arialabel=Anchor># </span><strong>修改表的操作符行为</strong></h2></a><p>通过重载 &ldquo;__add&rdquo; 元方法来计算集合的并集实例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>set1</span> <span class=o>=</span> <span class=p>{</span><span class=mi>10</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>30</span><span class=p>}</span>   <span class=c1>-- 集合</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>set2</span> <span class=o>=</span> <span class=p>{</span><span class=mi>20</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=mi>50</span><span class=p>}</span>   <span class=c1>-- 集合</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- 将用于重载__add的函数，注意第一个参数是self</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>union</span> <span class=o>=</span> <span class=kr>function</span> <span class=p>(</span><span class=n>self</span><span class=p>,</span> <span class=n>another</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>set</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>result</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>-- 利用数组来确保集合的互异性</span>
</span></span><span class=line><span class=cl>    <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>self</span><span class=p>)</span> <span class=kr>do</span> <span class=n>set</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span> <span class=kr>end</span>
</span></span><span class=line><span class=cl>    <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>another</span><span class=p>)</span> <span class=kr>do</span> <span class=n>set</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span> <span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>-- 加入结果集合</span>
</span></span><span class=line><span class=cl>    <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>set</span><span class=p>)</span> <span class=kr>do</span> <span class=n>table.insert</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=kr>end</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=n>setmetatable</span><span class=p>(</span><span class=n>set1</span><span class=p>,</span> <span class=p>{</span><span class=n>__add</span> <span class=o>=</span> <span class=n>union</span><span class=p>})</span> <span class=c1>-- 重载 set1 表的 __add 元方法</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>set3</span> <span class=o>=</span> <span class=n>set1</span> <span class=o>+</span> <span class=n>set2</span>
</span></span><span class=line><span class=cl><span class=kr>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>j</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>set3</span><span class=p>)</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>    <span class=n>io.write</span><span class=p>(</span><span class=n>j</span><span class=o>..</span><span class=s2>&#34; &#34;</span><span class=p>)</span>               <span class=c1>--&gt;output：30 50 20 40 10</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></td></tr></table></div></div><p>除了加法可以被重载之外，Lua 提供的所有操作符都可以被重载：</p><table><thead><tr><th>元方法</th><th>含义</th></tr></thead><tbody><tr><td>&ldquo;__add</td><td>#NAME?</td></tr><tr><td>&ldquo;__sub</td><td>- 操作 其行为类似于 &ldquo;add&rdquo; 操作</td></tr><tr><td>&ldquo;__mul</td><td>* 操作 其行为类似于 &ldquo;add&rdquo; 操作</td></tr><tr><td>&ldquo;__div</td><td>/ 操作 其行为类似于 &ldquo;add&rdquo; 操作</td></tr><tr><td>&ldquo;__mod</td><td>% 操作 其行为类似于 &ldquo;add&rdquo; 操作</td></tr><tr><td>&ldquo;__pow</td><td>^ （幂）操作 其行为类似于 &ldquo;add&rdquo; 操作</td></tr><tr><td>&ldquo;__unm&rdquo;</td><td>一元 - 操作</td></tr><tr><td>&ldquo;__concat&rdquo;</td><td>.. （字符串连接）操作</td></tr><tr><td>&ldquo;__len&rdquo;</td><td># 操作</td></tr><tr><td>&ldquo;__eq&rdquo;</td><td>== 操作 函数 getcomphandler 定义了 Lua 怎样选择一个处理器来作比较操作 仅在两个对象类型相同且有对应操作相同的元方法时才起效</td></tr><tr><td>&ldquo;__lt&rdquo;</td><td>&lt; 操作</td></tr><tr><td>&ldquo;__le&rdquo;</td><td>&lt;= 操作</td></tr></tbody></table><p>除了操作符之外，如下元方法也可以被重载，下面会依次解释使用方法：</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>元方法</td><td>含义</td></tr><tr><td>&ldquo;__index&rdquo;</td><td>取下标操作用于访问 table[key]</td></tr><tr><td>&ldquo;__newindex&rdquo;</td><td>赋值给指定下标 table[key] = value</td></tr><tr><td>&ldquo;__tostring&rdquo;</td><td>转换成字符串</td></tr><tr><td>&ldquo;__call&rdquo;</td><td>当 Lua 调用一个值时调用</td></tr><tr><td>&ldquo;__mode&rdquo;</td><td>用于弱表(week table)</td></tr><tr><td>&ldquo;__metatable&rdquo;</td><td>用于保护metatable不被访问</td></tr></tbody></table><a href=#__index-元方法><h2 id=__index-元方法><span class=hanchor arialabel=Anchor># </span><strong>__index 元方法</strong></h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>mytable</span> <span class=o>=</span> <span class=n>setmetatable</span><span class=p>({</span><span class=n>key1</span> <span class=o>=</span> <span class=s2>&#34;value1&#34;</span><span class=p>},</span>   <span class=c1>--原始表</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=n>__index</span> <span class=o>=</span> <span class=kr>function</span><span class=p>(</span><span class=n>self</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>            <span class=c1>--重载函数</span>
</span></span><span class=line><span class=cl>    <span class=kr>if</span> <span class=n>key</span> <span class=o>==</span> <span class=s2>&#34;key2&#34;</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>        <span class=kr>return</span> <span class=s2>&#34;metatablevalue&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>mytable.key1</span><span class=p>,</span><span class=n>mytable.key2</span><span class=p>)</span>  <span class=c1>--&gt; output：value1 metatablevalue</span>
</span></span></code></pre></td></tr></table></div></div><p>关于 __index 元方法，有很多比较高阶的技巧，例如：__index 的元方法不需要非是一个函数，他也可以是一个表。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=n>setmetatable</span><span class=p>({[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;hello&#34;</span><span class=p>},</span> <span class=p>{</span><span class=n>__index</span> <span class=o>=</span> <span class=p>{[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;world&#34;</span><span class=p>}})</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>t</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>   <span class=c1>--&gt;hello wor</span>
</span></span></code></pre></td></tr></table></div></div><a href=#__tostring-元方法><h2 id=__tostring-元方法><span class=hanchor arialabel=Anchor># </span><strong>__tostring 元方法</strong></h2></a><p>与 Java 中的 toString() 函数类似，可以实现自定义的字符串转换。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>arr</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>arr</span> <span class=o>=</span> <span class=n>setmetatable</span><span class=p>(</span><span class=n>arr</span><span class=p>,</span> <span class=p>{</span><span class=n>__tostring</span> <span class=o>=</span> <span class=kr>function</span> <span class=p>(</span><span class=n>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>result</span> <span class=o>=</span> <span class=s1>&#39;{&#39;</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>sep</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=kr>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>i</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>self</span><span class=p>)</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>result</span> <span class=o>..</span><span class=n>sep</span> <span class=o>..</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>        <span class=n>sep</span> <span class=o>=</span> <span class=s1>&#39;, &#39;</span>
</span></span><span class=line><span class=cl>    <span class=kr>end</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>result</span> <span class=o>..</span> <span class=s1>&#39;}&#39;</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl><span class=kr>end</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>arr</span><span class=p>)</span>  <span class=c1>--&gt; {1, 2, 3, 4}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#__call-元方法><h2 id=__call-元方法><span class=hanchor arialabel=Anchor># </span><strong>__call 元方法</strong></h2></a><p>__call 元方法的功能类似于 C++ 中的仿函数，使得普通的表也可以被调用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>functor</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>func1</span><span class=p>(</span><span class=n>self</span><span class=p>,</span> <span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span> <span class=p>(</span><span class=s2>&#34;called from&#34;</span><span class=p>,</span> <span class=n>arg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl><span class=n>setmetatable</span><span class=p>(</span><span class=n>functor</span><span class=p>,</span> <span class=p>{</span><span class=n>__call</span> <span class=o>=</span> <span class=n>func1</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>functor</span><span class=p>(</span><span class=s2>&#34;functor&#34;</span><span class=p>)</span>  <span class=c1>--&gt; called from functor</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>functor</span><span class=p>)</span>      <span class=c1>--&gt; output：0x00076fc8 （后面这串数字可能不一样）</span>
</span></span></code></pre></td></tr></table></div></div><a href=#__metatable-元方法><h2 id=__metatable-元方法><span class=hanchor arialabel=Anchor># </span><strong>__metatable 元方法</strong></h2></a><p>假如我们想保护我们的对象使其使用者既看不到也不能修改 metatables。我<strong>们可以对 metatable 设置了 __metatable 的值，getmetatable 将返回这个域的值，而调用 setmetatable 将会出错</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>bject</span> <span class=o>=</span> <span class=n>setmetatable</span><span class=p>({},</span> <span class=p>{</span><span class=n>__metatable</span> <span class=o>=</span> <span class=s2>&#34;You cannot access here&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>getmetatable</span><span class=p>(</span><span class=n>Object</span><span class=p>))</span> <span class=c1>--&gt; You cannot access heresetmetatable(Object, {})    --&gt; 引发编译器报错</span>
</span></span></code></pre></td></tr></table></div></div><a href=#面向对象><h1 id=面向对象><span class=hanchor arialabel=Anchor># </span>面向对象</h1></a><a href=#类><h2 id=类><span class=hanchor arialabel=Anchor># </span>类</h2></a><p>在 Lua 中，我们可以使用表和函数实现面向对象。<strong>将函数和相关的数据放置于同一个表中就形成了一个对象。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>local _M = {}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>local mt = { __index = _M }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function _M.deposit (self, v)
</span></span><span class=line><span class=cl>    self.balance = self.balance + v
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function _M.withdraw (self, v)
</span></span><span class=line><span class=cl>    if self.balance &gt; v then
</span></span><span class=line><span class=cl>        self.balance = self.balance - v
</span></span><span class=line><span class=cl>    else
</span></span><span class=line><span class=cl>        error(&#34;insufficient funds&#34;)
</span></span><span class=line><span class=cl>    end
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function _M.new (self, balance)
</span></span><span class=line><span class=cl>    balance = balance or 0
</span></span><span class=line><span class=cl>    return setmetatable({balance = balance}, mt)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>return _M
</span></span></code></pre></td></tr></table></div></div><p>引用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>account</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s2>&#34;account&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>a</span> <span class=o>=</span> <span class=n>account</span><span class=p>:</span><span class=n>new</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>:</span><span class=n>deposit</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>b</span> <span class=o>=</span> <span class=n>account</span><span class=p>:</span><span class=n>new</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=p>:</span><span class=n>deposit</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>a.balance</span><span class=p>)</span>  <span class=c1>--&gt; output: 100</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>b.balance</span><span class=p>)</span>  <span class=c1>--&gt; output: 50</span>
</span></span></code></pre></td></tr></table></div></div><p>上面这段代码 &ldquo;setmetatable({balance = balance}, mt)"，其中 mt 代表 <code>{ __index = _M }</code> ，这句话值得注意。根据我们在元表这一章学到的知识，我们明白，setmetatable 将 <code>_M</code> 作为新建表的原型，所以在自己的表内找不到 &lsquo;deposit&rsquo;、&lsquo;withdraw&rsquo; 这些方法和变量的时候，便会到 __index 所指定的 _M 类型中去寻找。</p><a href=#继承><h2 id=继承><span class=hanchor arialabel=Anchor># </span>继承</h2></a><p>继承可以用元表实现，它提供了在父类中查找存在的方法和变量的机制。在 Lua 中是不推荐使用继承方式完成构造的，这样做引入的问题可能比解决的问题要多，下面一个是字符串操作类库，给大家演示一下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=c1>---------- s_base.lualocal _M = {}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>mt</span> <span class=o>=</span> <span class=p>{</span> <span class=n>__index</span> <span class=o>=</span> <span class=n>_M</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>upper</span> <span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=kr>return</span> <span class=n>string.upper</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>endreturn</span> <span class=n>_M</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>---------- s_more.lualocal s_base = require(&#34;s_base&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>_M</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=n>_M</span> <span class=o>=</span> <span class=n>setmetatable</span><span class=p>(</span><span class=n>_M</span><span class=p>,</span> <span class=p>{</span> <span class=n>__index</span> <span class=o>=</span> <span class=n>s_base</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>lower</span> <span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=kr>return</span> <span class=n>string.lower</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>endreturn</span> <span class=n>_M</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>---------- test.lualocal s_more = require(&#34;s_more&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>s_more.upper</span><span class=p>(</span><span class=s2>&#34;Hello&#34;</span><span class=p>))</span>   <span class=c1>-- output: HELLOprint(s_more.lower(&#34;Hello&#34;))   -- output: hello</span>
</span></span></code></pre></td></tr></table></div></div><a href=#成员私有性><h2 id=成员私有性><span class=hanchor arialabel=Anchor># </span>成员私有性</h2></a><p>在动态语言中引入成员私有性并没有太大的必要，反而会显著增加运行时的开销，毕竟这种检查无法像许多静态语言那样在编译期完成。下面的技巧把对象作为各方法的 upvalue，本身是很巧妙的，但会让子类继承变得困难，同时构造函数动态创建了函数，会导致构造函数无法被 JIT 编译。</p><p>在 Lua 中，成员的私有性，使用类似于函数闭包的形式来实现。在我们之前的银行账户的例子中，我们使用一个工厂方法来创建新的账户实例，通过工厂方法对外提供的闭包来暴露对外接口。而不想暴露在外的例如 balance 成员变量，则被很好的隐藏起来。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=kr>function</span> <span class=nf>newAccount</span> <span class=p>(</span><span class=n>initialBalance</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>self</span> <span class=o>=</span> <span class=p>{</span><span class=n>balance</span> <span class=o>=</span> <span class=n>initialBalance</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>withdraw</span> <span class=o>=</span> <span class=kr>function</span> <span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>self.balance</span> <span class=o>=</span> <span class=n>self.balance</span> <span class=o>-</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=kr>end</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>deposit</span> <span class=o>=</span> <span class=kr>function</span> <span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>self.balance</span> <span class=o>=</span> <span class=n>self.balance</span> <span class=o>+</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>    <span class=kr>end</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>getBalance</span> <span class=o>=</span> <span class=kr>function</span> <span class=p>()</span> 
</span></span><span class=line><span class=cl>        <span class=kr>return</span> <span class=n>self.balance</span> 
</span></span><span class=line><span class=cl>    <span class=kr>end</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>withdraw</span> <span class=o>=</span> <span class=n>withdraw</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>deposit</span> <span class=o>=</span> <span class=n>deposit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>getBalance</span> <span class=o>=</span> <span class=n>getBalance</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>newAccount</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>a.deposit</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>a.getBalance</span><span class=p>())</span> <span class=c1>--&gt; 200print(a.balance)      --&gt; nil</span>
</span></span></code></pre></td></tr></table></div></div><a href=#局部变量><h1 id=局部变量><span class=hanchor arialabel=Anchor># </span>局部变量</h1></a><p>Lua 的设计有一点很奇怪，<strong>在一个 block 中的变量，如果之前没有定义过，那么认为它是一个全局变量</strong>，<strong>而不是这个 block 的局部变量</strong>。这一点和别的语言不同。<strong>容易造成不小心覆盖了全局同名变量的错误</strong>。</p><a href=#定义><h2 id=定义><span class=hanchor arialabel=Anchor># </span><strong>定义</strong></h2></a><p>Lua 中的局部变量要用 local 关键字来显式定义，不使用 local 显式定义的变量就是全局变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>g_var</span> <span class=o>=</span> <span class=mi>1</span>         <span class=c1>-- global var</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>l_var</span> <span class=o>=</span> <span class=mi>2</span>   <span class=c1>-- local var</span>
</span></span></code></pre></td></tr></table></div></div><a href=#作用域><h2 id=作用域><span class=hanchor arialabel=Anchor># </span><strong>作用域</strong></h2></a><p><strong>局部变量的生命周期是有限的，它的作用域仅限于声明它的块（block）</strong>。一个块是一个控制结构的执行体、或者是一个函数的执行体再或者是一个程序块（chunk）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>x</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span>         <span class=c1>-- 程序块中的局部变量 i</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>while</span> <span class=n>i</span> <span class=o>&lt;=</span><span class=n>x</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>x</span> <span class=o>=</span> <span class=n>i</span> <span class=o>*</span> <span class=mi>2</span>   <span class=c1>-- while 循环体中的局部变量 x</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>          <span class=c1>-- output： 2, 4, 6, 8, ...</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>20</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=kd>local</span> <span class=n>x</span>           <span class=c1>-- then 中的局部变量 x</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span>      <span class=c1>-- 如果i &gt; 20 将会打印 22，此处的 x 是局部变量</span>
</span></span><span class=line><span class=cl><span class=kr>else</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>          <span class=c1>-- 打印 10，这里 x 是全局变量</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>            <span class=c1>-- 打印 10</span>
</span></span></code></pre></td></tr></table></div></div><a href=#使用局部变量的好处><h2 id=使用局部变量的好处><span class=hanchor arialabel=Anchor># </span>使用局部变量的好处</h2></a><ol><li><p>局部变量可以避免因为命名问题污染了全局环境</p></li><li><p>local 变量的访问比全局变量更快</p></li><li><p>由于局部变量出了作用域之后生命周期结束，这样可以被垃圾回收器及时释放</p></li></ol><a href=#检测模块的函数使用局部变量><h2 id=检测模块的函数使用局部变量><span class=hanchor arialabel=Anchor># </span>检测模块的函数使用局部变量</h2></a><p>foo.lua</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>_M</span> <span class=o>=</span> <span class=p>{</span> <span class=n>_VERSION</span> <span class=o>=</span> <span class=s1>&#39;0.01&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>add</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>     <span class=c1>--两个number型变量相加</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>update_A</span><span class=p>()</span>    <span class=c1>--更新变量值</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span> <span class=o>=</span> <span class=mi>365</span>               <span class=c1>-- A 是全局变量</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>return</span> <span class=n>_M</span>
</span></span></code></pre></td></tr></table></div></div><p>use_foo.lua</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>A</span> <span class=o>=</span> <span class=mi>360</span>     <span class=c1>--定义全局变量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>foo</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s2>&#34;foo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>b</span> <span class=o>=</span> <span class=n>foo.add</span><span class=p>(</span><span class=n>A</span><span class=p>,</span> <span class=n>A</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;b = &#34;</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>foo.update_A</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;A = &#34;</span><span class=p>,</span> <span class=n>A</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>因为A 是全局变量，改变了A的值</p><p>Lua 上下文中应当严格避免使用自己定义的全局变量。<strong>可以使用一个 lj-releng 工具来扫描 Lua 代码，定位使用 Lua 全局变量的地方</strong>。lj-releng 的相关链接：
<a href=https://github.com/openresty/openresty-devel-utils/blob/master/lj-releng rel=noopener>https://github.com/openresty/openresty-devel-utils/blob/master/lj-releng</a></p><p>Windows 用户把 lj-releng 文件所在的目录的绝对路径添加进 PATH 环境变量。然后进入你自己的 Lua 文件所在的工作目录，得到如下结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=o>#</span>  <span class=n>lj</span><span class=o>-</span><span class=n>releng</span>
</span></span><span class=line><span class=cl><span class=n>foo.lua</span><span class=p>:</span> <span class=mf>0.01</span> <span class=p>(</span><span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Checking</span> <span class=n>use</span> <span class=n>of</span> <span class=n>Lua</span> <span class=n>global</span> <span class=n>variables</span> <span class=kr>in</span> <span class=n>file</span> <span class=n>foo.lua</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>op</span> <span class=n>no</span><span class=p>.</span>  <span class=n>line</span>  <span class=n>instruction</span> <span class=n>args</span>  <span class=p>;</span> <span class=n>code</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>  <span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=n>SETGLOBAL</span> <span class=mi>0</span> <span class=o>-</span><span class=mi>1</span>  <span class=p>;</span> <span class=n>A</span>
</span></span><span class=line><span class=cl><span class=n>Checking</span> <span class=n>line</span> <span class=n>length</span> <span class=n>exceeding</span> <span class=mf>80.</span><span class=o>..</span>
</span></span><span class=line><span class=cl><span class=n>WARNING</span><span class=p>:</span> <span class=n>No</span> <span class=s2>&#34;_VERSION&#34;</span> <span class=ow>or</span> <span class=s2>&#34;version&#34;</span> <span class=n>field</span> <span class=n>found</span> <span class=kr>in</span> <span class=err>`</span><span class=n>use_foo.lua</span><span class=err>`</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=n>Checking</span> <span class=n>use</span> <span class=n>of</span> <span class=n>Lua</span> <span class=n>global</span> <span class=n>variables</span> <span class=kr>in</span> <span class=n>file</span> <span class=n>use_foo.lua</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>op</span> <span class=n>no</span><span class=p>.</span>  <span class=n>line</span>  <span class=n>instruction</span> <span class=n>args</span>  <span class=p>;</span> <span class=n>code</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>  <span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=n>SETGLOBAL</span> <span class=mi>0</span> <span class=o>-</span><span class=mi>1</span>  <span class=p>;</span> <span class=n>A</span>
</span></span><span class=line><span class=cl><span class=mi>7</span>  <span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=n>GETGLOBAL</span> <span class=mi>2</span> <span class=o>-</span><span class=mi>1</span>  <span class=p>;</span> <span class=n>A</span>
</span></span><span class=line><span class=cl><span class=mi>8</span>  <span class=p>[</span><span class=mi>4</span><span class=p>]</span> <span class=n>GETGLOBAL</span> <span class=mi>3</span> <span class=o>-</span><span class=mi>1</span>  <span class=p>;</span> <span class=n>A</span>
</span></span><span class=line><span class=cl><span class=mi>18</span> <span class=p>[</span><span class=mi>8</span><span class=p>]</span> <span class=n>GETGLOBAL</span> <span class=mi>4</span> <span class=o>-</span><span class=mi>1</span>  <span class=p>;</span> <span class=n>A</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，更推荐采用 <strong>luacheck 来检查项目中全局变量，之后的“代码静态分析”一节，我们还会讲到如何使用 luacheck</strong>。</p><a href=#判断数组的大小><h1 id=判断数组的大小><span class=hanchor arialabel=Anchor># </span>判断数组的大小</h1></a><ul><li><p>table.getn(t) 等价于 t 但<strong>计算的是数组元素，不包括 hash 键值</strong>。而且数组是以第一个 nil 元素来判断数组结束。</p></li><li><p><code>#</code> 只计算 array 的元素个数，它实际上调用了对象的 metatable 的 <code>__len</code> 函数。对于有 <code>__len</code> 方法的函数返回函数返回值，不然就返回数组成员数目</p></li><li><p><em>Lua</em> 内部实际采用哈希表和数组分别保存键值对、普通值，所以不推荐混合使用这两种赋值方式。</p></li><li><p>Lua 数组中允许 nil 值的存在，但是数组默认结束标志却是 nil。这类比于 C 语言中的字符串，字符串中允许 &lsquo;\0&rsquo; 存在，但当读到 &lsquo;\0&rsquo; 时，就认为字符串已经结束了。</p></li><li><p>初始化是例外，在 Lua 相关源码中，初始化数组时首先判断数组的长度，若长度大于 0 ，并且最后一个值不为 nil，返回包括 nil 的长度；若最后一个值为 nil，则返回截至第一个非 nil 值的长度。</p></li><li><p><strong>如果你要删除一个数组中的元素，请使用 remove 函数，而不是用 nil 赋值</strong></p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=c1>-- test.lua</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>tblTest1</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;Test1 &#34;</span> <span class=o>..</span> <span class=o>#</span><span class=p>(</span><span class=n>tblTest1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>tblTest2</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=kc>nil</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;Test2 &#34;</span> <span class=o>..</span> <span class=o>#</span><span class=p>(</span><span class=n>tblTest2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>tblTest3</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=mi>2</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;Test3 &#34;</span> <span class=o>..</span> <span class=o>#</span><span class=p>(</span><span class=n>tblTest3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>tblTest4</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=kc>nil</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;Test4 &#34;</span> <span class=o>..</span> <span class=o>#</span><span class=p>(</span><span class=n>tblTest4</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>tblTest5</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=kc>nil</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;Test5 &#34;</span> <span class=o>..</span> <span class=o>#</span><span class=p>(</span><span class=n>tblTest5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>tblTest6</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=kc>nil</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;Test6 &#34;</span> <span class=o>..</span> <span class=o>#</span><span class=p>(</span><span class=n>tblTest6</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>我们分别使用 Lua 和 LuaJIT 来执行一下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=err>➜</span> <span class=n>luajit</span> <span class=n>test.lua</span>
</span></span><span class=line><span class=cl><span class=n>Test1</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>Test2</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>Test3</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>Test4</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>Test5</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>Test6</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>➜</span> <span class=n>lua</span> <span class=n>test.lua</span>
</span></span><span class=line><span class=cl><span class=n>Test1</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>Test2</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>Test3</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>Test4</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>Test5</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>Test6</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><p>这一段的输出结果，就是这么 <strong>匪夷所思</strong>。不要在 Lua 的 table 中使用 nil 值，<strong>如果一个元素要删除，直接 remove，不要用 nil 去代替</strong>。</p><a href=#非空判断><h1 id=非空判断><span class=hanchor arialabel=Anchor># </span>非空判断</h1></a><p>有时候不小心引用了一个没有赋值的变量，这时它的值默认为 nil。如果对一个 nil 进行索引的话，会导致异常。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>local person = {name = &#34;Bob&#34;, sex = &#34;M&#34;}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-- do something
</span></span><span class=line><span class=cl>person = nil
</span></span><span class=line><span class=cl>-- do something
</span></span><span class=line><span class=cl>print(person.name)
</span></span></code></pre></td></tr></table></div></div><p>会报错</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>stdin</span><span class=p>:</span><span class=mi>1</span><span class=p>:</span><span class=n>attempt</span> <span class=n>to</span> <span class=n>index</span> <span class=n>global</span> <span class=s1>&#39;person&#39;</span> <span class=p>(</span><span class=n>a</span> <span class=kc>nil</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stack</span> <span class=n>traceback</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=n>stdin</span><span class=p>:</span><span class=mi>1</span><span class=p>:</span> <span class=kr>in</span> <span class=n>main</span> <span class=n>chunk</span>
</span></span><span class=line><span class=cl>   <span class=p>[</span><span class=n>C</span><span class=p>]:</span> <span class=err>?</span>
</span></span></code></pre></td></tr></table></div></div><p>在实际的工程代码中，我们很难这么轻易地发现我们引用了 nil 变量。因此，在很多情况下我们在访问一些 table 型变量时，需要先判断该变量是否为 nil，例如将上面的代码改成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>person</span> <span class=o>=</span> <span class=p>{</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;Bob&#34;</span><span class=p>,</span> <span class=n>sex</span> <span class=o>=</span> <span class=s2>&#34;M&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>-- do something</span>
</span></span><span class=line><span class=cl><span class=n>person</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=c1>-- do something</span>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>person</span> <span class=o>~=</span> <span class=kc>nil</span> <span class=ow>and</span> <span class=n>person.name</span> <span class=o>~=</span> <span class=kc>nil</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=n>person.name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>else</span>
</span></span><span class=line><span class=cl><span class=c1>-- do somethingend</span>
</span></span></code></pre></td></tr></table></div></div><p>对于简单类型的变量，我们可以用 <em>if (var == nil) then</em> 这样的简单句子来判断。<strong>但是对于 table 型的 Lua 对象，就不能这么简单判断它是否为空了。一个 table 型变量的值可能是</strong> <strong><code>{}</code></strong>，这时它不等于 nil。我们来看下面这段代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>next</span> <span class=o>=</span> <span class=n>next</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>a</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>b</span> <span class=o>=</span> <span class=p>{</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;Bob&#34;</span><span class=p>,</span> <span class=n>sex</span> <span class=o>=</span> <span class=s2>&#34;Male&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>c</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;Male&#34;</span><span class=p>,</span> <span class=s2>&#34;Female&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>d</span> <span class=o>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=o>#</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=o>#</span><span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=o>#</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>--print(#d)    -- error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>a</span> <span class=o>==</span> <span class=kc>nil</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;a == nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>b</span> <span class=o>==</span> <span class=kc>nil</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;b == nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>c</span> <span class=o>==</span> <span class=kc>nil</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;c == nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>d</span><span class=o>==</span> <span class=kc>nil</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;d == nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>next</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>==</span> <span class=kc>nil</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;next(a) == nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>next</span><span class=p>(</span><span class=n>b</span><span class=p>)</span> <span class=o>==</span> <span class=kc>nil</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;next(b) == nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>if</span> <span class=n>next</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=o>==</span> <span class=kc>nil</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=s2>&#34;next(c) == nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=n>d</span> <span class=o>==</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=n>next</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>==</span> <span class=kc>nil</span>
</span></span></code></pre></td></tr></table></div></div><p>因此，我们要判断一个 table 是否为 <code>{}</code>，不能采用 <code>#table == 0</code> 的方式来判断。可以用下面这样的方法来判断：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>function isTableEmpty(t)
</span></span><span class=line><span class=cl>    return t <mark> nil or next(t) </mark> nil
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><p>注意：<strong><code>next</code></strong> <strong>指令是不能被 LuaJIT 的 JIT 编译优化，并且 LuaJIT 貌似没有明确计划支持这个指令优化，在不是必须的情况下，尽量少用。</strong></p><a href=#正则表达式><h1 id=正则表达式><span class=hanchor arialabel=Anchor># </span>正则表达式</h1></a><p>同时存在两套正则表达式规范：<em>Lua</em> 语言的规范和 <code>ngx.re.*</code> 的规范，即使您对 <em>Lua</em> 语言中的规范非常熟悉，我们仍不建议使用 <em>Lua</em> 中的正则表达式。</p><ul><li><p>一是因为 <em>Lua</em> 中正则表达式的性能并不如 <code>ngx.re.*</code> 中的正则表达式优秀；</p></li><li><p>二是 <em>Lua</em> 中的正则表达式并不符合 <em>POSIX</em> 规范，而 <code>ngx.re.*</code> 中实现的是标准的 <em>POSIX</em> 规范，后者明显更具备通用性。</p></li></ul><p><code>ngx.re.*</code> 中的 <code>o</code> 选项，指明该参数，被编译的 Pattern 将会在工作进程中缓存，并且被当前工作进程的每次请求所共享。Pattern 缓存的上限值通过 <code>lua_regex_cache_max_entries</code> 来修改，它的默认值为1024。</p><p><code>ngx.re.*</code> 中的 <code>j</code> 选项，指明该参数，如果使用的 PCRE 库支持 JIT，OpenResty 会在编译 Pattern 时启用 JIT。启用 JIT 后正则匹配会有明显的性能提升。较新的平台，自带的 PCRE 库均支持 JIT。如果系统自带的 PCRE 库不支持 JIT，出于性能考虑，最好自己编译一份 libpcre.so，然后在编译 OpenResty 时链接过去。要想验证当前 PCRE 库是否支持 JIT，可以这么做</p><ol><li><p>编译 OpenResty 时在 <code>./configure</code> 中指定 <code>--with-debug</code> 选项</p></li><li><p>在 <code>error_log</code> 指令中指定日志级别为 <code>debug</code></p></li><li><p>运行正则匹配代码，查看日志中是否有 <code>pcre JIT compiling result: 1</code></p></li></ol><p>即使运行在不支持 JIT 的 OpenResty 上，加上 <code>j</code> 选项也不会带来坏的影响。在 OpenResty 官方的 Lua 库中，正则匹配至少都会带上 <code>jo</code> 这两个选项。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>location</span> <span class=o>/</span><span class=n>test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>content_by_lua_block</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>local</span> <span class=n>regex</span> <span class=o>=</span> <span class=s>[[\d+]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>-- 参数 &#34;j&#34; 启用 JIT 编译，参数 &#34;o&#34; 是开启缓存必须的</span>
</span></span><span class=line><span class=cl>        <span class=kd>local</span> <span class=n>m</span> <span class=o>=</span> <span class=n>ngx.re</span><span class=p>.</span><span class=n>match</span><span class=p>(</span><span class=s2>&#34;hello, 1234&#34;</span><span class=p>,</span> <span class=n>regex</span><span class=p>,</span> <span class=s2>&#34;jo&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>if</span> <span class=n>m</span> <span class=kr>then</span>
</span></span><span class=line><span class=cl>            <span class=n>ngx.say</span><span class=p>(</span><span class=n>m</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=kr>else</span>
</span></span><span class=line><span class=cl>            <span class=n>ngx.say</span><span class=p>(</span><span class=s2>&#34;not matched!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>end</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#lua-正则简单汇总><h4 id=lua-正则简单汇总><span class=hanchor arialabel=Anchor># </span><strong>Lua 正则简单汇总</strong></h4></a><p><em>Lua</em> 中正则表达式语法上最大的区别，<em>Lua</em> 使用 <em>&rsquo;%&rsquo;</em> 来进行转义，而其他语言的正则表达式使用 <em>&rsquo;'</em> 符号来进行转义。其次，<em>Lua</em> 中并不使用 <em>&rsquo;?&rsquo;</em> 来表示非贪婪匹配，而是定义了不同的字符来表示是否是贪婪匹配。定义如下：</p><table><thead><tr><th>符号</th><th>匹配次数</th><th>匹配模式</th></tr></thead><tbody><tr><td>+</td><td>匹配前一字符 1 次或多次</td><td>非贪婪</td></tr><tr><td><code>*</code></td><td>匹配前一字符 0 次或多次</td><td>贪婪</td></tr><tr><td>-</td><td>匹配前一字符 0 次或多次</td><td>非贪婪</td></tr><tr><td>?</td><td>匹配前一字符 0 次或1次</td><td>仅用于此，不用于标识是否贪婪</td></tr></tbody></table><table><thead><tr><th>符号</th><th>匹配模式</th></tr></thead><tbody><tr><td>.</td><td>任意字符</td></tr><tr><td>%a</td><td>字母</td></tr><tr><td>%c</td><td>控制字符</td></tr><tr><td>%d</td><td>数字</td></tr><tr><td>%l</td><td>小写字母</td></tr><tr><td>%p</td><td>标点字符</td></tr><tr><td>%s</td><td>空白符</td></tr><tr><td>%u</td><td>大写字母</td></tr><tr><td>%w</td><td>字母和数字</td></tr><tr><td>%x</td><td>十六进制数字</td></tr><tr><td>%z</td><td>代表 0 的字符</td></tr></tbody></table><a href=#虚变量><h1 id=虚变量><span class=hanchor arialabel=Anchor># </span>虚变量</h1></a><p>当一个方法返回多个值时，有些返回值有时候用不到，要是声明很多变量来一一接收，显然不太合适（不是不能）。<strong>Lua 提供了一个虚变量(dummy variable)的概念， 按照</strong>**
<a href=https://www.lua.org/pil/1.3.html rel=noopener>惯例</a>**<strong>以一个下划线（“_”）来命名，用它来表示丢弃不需要的数值，仅仅起到占位的作用。</strong></p><a href=#返回值><h2 id=返回值><span class=hanchor arialabel=Anchor># </span>返回值</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=c1>-- string.find (s,p) 从string 变量s的开头向后匹配 string</span>
</span></span><span class=line><span class=cl><span class=c1>-- p，若匹配不成功，返回nil，若匹配成功，返回第一次匹配成功</span>
</span></span><span class=line><span class=cl><span class=c1>-- 的起止下标。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>start</span><span class=p>,</span> <span class=n>finish</span> <span class=o>=</span> <span class=n>string.find</span><span class=p>(</span><span class=s2>&#34;hello&#34;</span><span class=p>,</span> <span class=s2>&#34;he&#34;</span><span class=p>)</span> <span class=c1>--start 值为起始下标，finish</span>
</span></span><span class=line><span class=cl><span class=c1>--值为结束下标</span>
</span></span><span class=line><span class=cl><span class=n>print</span> <span class=p>(</span> <span class=n>start</span><span class=p>,</span> <span class=n>finish</span> <span class=p>)</span>                          <span class=c1>--输出 1   2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>start</span> <span class=o>=</span> <span class=n>string.find</span><span class=p>(</span><span class=s2>&#34;hello&#34;</span><span class=p>,</span> <span class=s2>&#34;he&#34;</span><span class=p>)</span>      <span class=c1>-- start值为起始下标</span>
</span></span><span class=line><span class=cl><span class=n>print</span> <span class=p>(</span> <span class=n>start</span> <span class=p>)</span>                               <span class=c1>-- 输出 1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>_</span><span class=p>,</span><span class=n>finish</span> <span class=o>=</span> <span class=n>string.find</span><span class=p>(</span><span class=s2>&#34;hello&#34;</span><span class=p>,</span> <span class=s2>&#34;he&#34;</span><span class=p>)</span>   <span class=c1>--采用虚变量（即下划线），接收起</span>
</span></span><span class=line><span class=cl><span class=c1>--始下标值，然后丢弃，finish接收</span>
</span></span><span class=line><span class=cl><span class=c1>--结束下标值</span>
</span></span><span class=line><span class=cl><span class=n>print</span> <span class=p>(</span> <span class=n>finish</span> <span class=p>)</span>                              <span class=c1>--输出 2</span>
</span></span><span class=line><span class=cl><span class=n>print</span> <span class=p>(</span> <span class=n>_</span> <span class=p>)</span>    
</span></span></code></pre></td></tr></table></div></div><a href=#迭代><h2 id=迭代><span class=hanchor arialabel=Anchor># </span>迭代</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=c1>-- test.lua 文件</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>t</span> <span class=o>=</span> <span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;all  data:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>for</span> <span class=n>i</span><span class=p>,</span><span class=n>v</span> <span class=kr>in</span> <span class=n>ipairs</span><span class=p>(</span><span class=n>t</span><span class=p>)</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=s2>&#34;part data:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>for</span> <span class=n>_</span><span class=p>,</span><span class=n>v</span> <span class=kr>in</span> <span class=n>ipairs</span><span class=p>(</span><span class=n>t</span><span class=p>)</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>    <span class=n>print</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=o>#</span> <span class=n>luajit</span> <span class=n>test.lua</span>
</span></span><span class=line><span class=cl><span class=n>all</span>  <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>   <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>   <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>   <span class=mi>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>part</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=mi>5</span>
</span></span></code></pre></td></tr></table></div></div><a href=#抵制使用-module-定义模块><h1 id=抵制使用-module-定义模块><span class=hanchor arialabel=Anchor># </span><strong>抵制使用 module() 定义模块</strong></h1></a><p>旧式的模块定义方式是通过 <code>module("filename"[,package.seeall])*</code> 来显式声明一个包，现在官方不推荐再使用这种方式</p><p>这种方式将会返回一个由 <code>filename</code> 模块函数组成的 <code>table</code>，并且还会定义一个包含该 <code>table</code> 的全局变量。</p><ol><li><p><code>package.seeall</code> 这种方式破坏了模块的高内聚，原本引入 &ldquo;filename&rdquo; 模块只想调用它的 <em>foobar()</em> 函数，但是它却可以读写全局属性，例如 <code>"filename.os"</code>。</p></li><li><p><code>module</code> 函数压栈操作引发的副作用，污染了全局环境变量。例如 <code>module("filename")</code> 会创建一个 <code>filename</code> 的 <code>table</code>，并将这个 <code>table</code> 注入全局环境变量中，这样使得没有引用它的文件也能调用 <code>filename</code> 模块的方法。</p></li></ol><p>推荐的模块定义</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=c1>-- square.lua 长方形模块</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>_M</span> <span class=o>=</span> <span class=p>{}</span>           <span class=c1>-- 局部的变量</span>
</span></span><span class=line><span class=cl><span class=n>_M._VERSION</span> <span class=o>=</span> <span class=s1>&#39;1.0&#39;</span>     <span class=c1>-- 模块版本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>mt</span> <span class=o>=</span> <span class=p>{</span> <span class=n>__index</span> <span class=o>=</span> <span class=n>_M</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>new</span><span class=p>(</span><span class=n>self</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>setmetatable</span><span class=p>({</span> <span class=n>width</span><span class=o>=</span><span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=o>=</span><span class=n>height</span> <span class=p>},</span> <span class=n>mt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>get_square</span><span class=p>(</span><span class=n>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>self.width</span> <span class=o>*</span> <span class=n>self.height</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>get_circumference</span><span class=p>(</span><span class=n>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=p>(</span><span class=n>self.width</span> <span class=o>+</span> <span class=n>self.height</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>return</span> <span class=n>_M</span>
</span></span></code></pre></td></tr></table></div></div><p>使用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=kd>local</span> <span class=n>square</span> <span class=o>=</span> <span class=n>require</span> <span class=s2>&#34;square&#34;</span>
</span></span><span class=line><span class=cl><span class=kd>local</span> <span class=n>s1</span> <span class=o>=</span> <span class=n>square</span><span class=p>:</span><span class=n>new</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>s1</span><span class=p>:</span><span class=n>get_square</span><span class=p>())</span>          <span class=c1>--output: 2</span>
</span></span><span class=line><span class=cl><span class=n>print</span><span class=p>(</span><span class=n>s1</span><span class=p>:</span><span class=n>get_circumference</span><span class=p>())</span>   <span class=c1>--output: 6</span>
</span></span></code></pre></td></tr></table></div></div><p>另一个跟 Lua 的 module 模块相关需要注意的点是，当 lua_code_cache on 开启时，require 加载的模块是会被缓存下来的，这样我们的模块就会以最高效的方式运行，直到被显式地调用如下语句（这里有点像模块卸载）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>package.loaded[&#34;square&#34;] = nil
</span></span></code></pre></td></tr></table></div></div><a href=#调用函数前先定义函数><h2 id=调用函数前先定义函数><span class=hanchor arialabel=Anchor># </span>调用函数前先定义函数</h2></a><p>Lua 里面的函数必须放在调用的代码之前，下面的代码是一个常见的错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=c1>-- test.lua 文件local i = 100</span>
</span></span><span class=line><span class=cl><span class=n>i</span> <span class=o>=</span> <span class=n>add_one</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>function</span> <span class=nf>add_one</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>return</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=kr>end</span>
</span></span></code></pre></td></tr></table></div></div><p>因此在函数定义之前使用函数相当于在变量赋值之前使用变量，Lua 世界对于没有赋值的变量，默认都是 nil，所以这里也就产生了一个 nil 的错误。</p><a href=#点号操作符和冒号操作符的区别><h1 id=点号操作符和冒号操作符的区别><span class=hanchor arialabel=Anchor># </span>点号操作符和冒号操作符的区别</h1></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>local str = &#34;abcde&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>print(&#34;case 1:&#34;, str:sub(1, 2))
</span></span><span class=line><span class=cl>print(&#34;case 2:&#34;, str.sub(str, 1, 2))
</span></span></code></pre></td></tr></table></div></div><p>输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Lua data-lang=Lua><span class=line><span class=cl><span class=n>case</span> <span class=mi>1</span><span class=p>:</span> <span class=n>ab</span>
</span></span><span class=line><span class=cl><span class=n>case</span> <span class=mi>2</span><span class=p>:</span> <span class=n>ab</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>冒号操作会带入一个</strong> <strong><code>self</code></strong> <strong>参数，用来代表</strong> <strong><code>自己</code>****。</strong></p></li><li><p>而点号操作，只是 <code>内容</code> 的展开。</p></li></ul><p>在函数定义时，使用冒号将默认接收一个 <code>self</code> 参数，而使用点号则需要显式传入 <code>self</code> 参数</p><p>示例代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>obj = { x = 20 }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function obj:fun1()
</span></span><span class=line><span class=cl>    print(self.x)
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><p>等价于</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>obj = { x = 20 }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function obj.fun1(self)
</span></span><span class=line><span class=cl>    print(self.x)
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><a href=#module的缺点><h1 id=module的缺点><span class=hanchor arialabel=Anchor># </span>module的缺点</h1></a><p>由于 <code>lua_code_cache off</code> 情况下，缓存的代码会伴随请求完结而释放。module 的最大好处缓存这时候是无法发挥的，所以本章的内容都是基于 <code>lua_code_cache on</code> 的情况下。</p><p>先看看下面代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>local ngx_socket_tcp = ngx.socket.tcp           -- ①
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>local _M = { _VERSION = &#39;0.06&#39; }                -- ②
</span></span><span class=line><span class=cl>local mt = { __index = _M }                     -- ③
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function _M.new(self)
</span></span><span class=line><span class=cl>    local sock, err = ngx_socket_tcp()          -- ④
</span></span><span class=line><span class=cl>    if not sock then
</span></span><span class=line><span class=cl>        return nil, err
</span></span><span class=line><span class=cl>    end
</span></span><span class=line><span class=cl>    return setmetatable({ sock = sock }, mt)    -- ⑤
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function _M.set_timeout(self, timeout)
</span></span><span class=line><span class=cl>    local sock = self.sock
</span></span><span class=line><span class=cl>    if not sock then
</span></span><span class=line><span class=cl>        return nil, &#34;not initialized&#34;
</span></span><span class=line><span class=cl>    end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return sock:settimeout(timeout)
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-- ... 其他功能代码，这里简略
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>return _M
</span></span></code></pre></td></tr></table></div></div><ol><li><p>对于比较底层的模块，内部使用到的非本地函数，都需要 local 本地化，这样做的好处：</p><ol><li><p>避免命名冲突：防止外部是 <code>require(...)</code> 的方法调用造成全局变量污染</p></li><li><p>访问局部变量的速度比全局变量更快、更快、更快（重要事情说三遍）</p></li></ol></li><li><p>每个基础模块最好有自己 <code>_VERSION</code> 标识，方便后期利用 <code>_VERSION</code> 完成热代码部署等高级特性，也便于使用者对版本有整体意识。</p></li><li><p>其实 <code>_M</code> 和 <code>mt</code> 对于不同的请求实例（require 方法得到的对象）是相同的，因为 module 会被缓存到全局环境中。所以在这个位置千万不要放单请求内个性信息，例如 ngx.ctx 等变量。</p></li><li><p><strong>这里需要实现的是给每个实例绑定不同的 tcp 对象</strong>，后<strong>面 setmetatable 确保了每个实例拥有自己的 socket 对象，所以必须放在 new 函数中</strong>。如果放在 ③ 的下面，那么这时候所有的不同实例内部将绑定了同一个 socket 对象。</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>local mt = { __index = _M }                     -- ③
</span></span><span class=line><span class=cl>local sock = ngx_socket_tcp()                   -- ④ 错误的
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>function _M.new(self)
</span></span><span class=line><span class=cl>    return setmetatable({ sock = sock }, mt)    -- ⑤
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><ol start=5><li><p>Lua 的 module 有两种类型：</p><ol><li><p>支持面向对象痕迹可以保留私有属性；静态方法提供者，没有任何私有属性。</p></li><li><p>真正起到区别作用的就是 setmetatable 函数，是否有自己的个性元表，最终导致两种不同的形态。</p></li></ol></li></ol><a href=#ffi><h1 id=ffi><span class=hanchor arialabel=Anchor># </span>FFI</h1></a><p><a href=https://moonbingbing.gitbooks.io/openresty-best-practices/content/lua/FFI.html rel=noopener>https://moonbingbing.gitbooks.io/openresty-best-practices/content/lua/FFI.html</a></p><p>FFI 库，是 LuaJIT 中最重要的一个扩展库。它允许从纯 Lua 代码调用外部 C 函数，使用 C 数据结构。</p><p>FFI 库最大限度的省去了使用 C 手工编写繁重的 <code>Lua/C</code> 绑定的需要。不需要学习一门独立/额外的绑定语言——它解析普通 C 声明。这样可以从 C 头文件或参考手册中，直接剪切，粘贴。它的任务就是绑定很大的库，但不需要捣鼓脆弱的绑定生成器。</p><p>FFI 紧紧的整合进了 LuaJIT（几乎不可能作为一个独立的模块）。<code>JIT</code> 编译器在 C 数据结构上所产生的代码，等同于一个 C 编译器应该生产的代码。在 <code>JIT</code> 编译过的代码中，调用 C 函数，可以被内连处理，不同于基于 <code>Lua/C API</code> 函数调用。</p><a href=#ffi-库-词汇><h2 id=ffi-库-词汇><span class=hanchor arialabel=Anchor># </span><strong>ffi 库 词汇</strong></h2></a><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>noun</td><td>Explanation</td></tr><tr><td>cdecl</td><td>A definition of an abstract C type(actually, is a lua string)</td></tr><tr><td>ctype</td><td>C type object</td></tr><tr><td>cdata</td><td>C data object</td></tr><tr><td>ct</td><td>C type format, is a template object, may be cdecl, cdata, ctype</td></tr><tr><td>cb</td><td>callback object</td></tr><tr><td>VLA</td><td>An array of variable length</td></tr><tr><td>VLS</td><td>A structure of variable length</td></tr></tbody></table><a href=#ffi-api><h2 id=ffi-api><span class=hanchor arialabel=Anchor># </span><em><em>ffi.</em> API</em>*</h2></a><p><strong>功能：</strong> <em>Lua ffi 库的 API，与 LuaJIT 不可分割。</em></p><p>毫无疑问，在 <code>lua</code> 文件中使用 <code>ffi</code> 库的时候，必须要有下面的一行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>local ffi = require &#34;ffi&#34;
</span></span></code></pre></td></tr></table></div></div><a href=#jit><h1 id=jit><span class=hanchor arialabel=Anchor># </span>JIT</h1></a><p>看一下 LuaJIT 官方的解释：LuaJIT is a Just-In-Time Compilerfor the Lua programming language。</p><p><strong>LuaJIT 的运行时环境包括一个用手写汇编实现的 Lua 解释器和一个可以直接生成机器代码的 JIT 编译器</strong></p><ul><li><p>一开始的时候，Lua 字节码总是被 LuaJIT 的解释器解释执行。LuaJIT 的解释器会在执行字节码时同时记录一些运行时的统计信息，比如每个 Lua 函数调用入口的实际运行次数，还有每个 Lua 循环的实际执行次数。</p></li><li><p>当这些次数超过某个预设的阈值时，便认为对应的 Lua 函数入口或者对应的 Lua 循环足够的“热”，这时便会触发 JIT 编译器开始工作。</p></li><li><p>JIT 编译器会从热函数的入口或者热循环的某个位置开始尝试编译对应的 Lua 代码路径。编译的过程是把 LuaJIT 字节码先转换成 LuaJIT 自己定义的中间码（IR），然后再生成针对目标体系结构的机器码（比如 x86_64 指令组成的机器码）</p></li><li><p>如果当前 Lua 代码路径上的所有的操作都可以被 JIT 编译器顺利编译，则这条编译过的代码路径便被称为一个“trace”，在物理上对应一个 <code>trace</code> 类型的 GC 对象（即参与 Lua GC 的对象）。</p></li></ul><p>JIT 编译器不支持的原语被称为 <strong>NYI（Not Yet Implemented）原语</strong>。比较完整的 NYI 列表在这篇文档里面：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=line><span class=cl>http://wiki.luajit.org/NYI
</span></span></code></pre></td></tr></table></div></div><p>所谓“让更多的 Lua 代码被 JIT 编译”，其实就是帮助更多的 Lua 代码路径能为 JIT 编译器所接受。这一般通过两种途径来实现：</p><ol><li><p>调整对应的 Lua 代码，<strong>避免使用 NYI 原语</strong>。</p></li><li><p>增强 JIT 编译器，让越来越多的 NYI 原语能够被编译。</p></li></ol><a href=#可以被-jit-编译的元操作><h2 id=可以被-jit-编译的元操作><span class=hanchor arialabel=Anchor># </span><strong>可以被 JIT 编译的元操作</strong></h2></a><p>下面给大家列一下截止到目前已经可以被 JIT 编译的元操作。 其他还有 IO、Bit、FFI、Coroutine、OS、Package、Debug、JIT 等分类，使用频率相对较低，这里就不罗列了，可以参考官网：
<a href=http://wiki.luajit.org/NYI rel=noopener>http://wiki.luajit.org/NYI</a>。</p><a href=#基础库的支持情况><h3 id=基础库的支持情况><span class=hanchor arialabel=Anchor># </span><strong>基础库的支持情况</strong></h3></a><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>函数</td><td>编译?</td><td>备注</td></tr><tr><td>assert</td><td>yes</td><td></td></tr><tr><td>collectgarbage</td><td>no</td><td></td></tr><tr><td>dofile</td><td>never</td><td></td></tr><tr><td>error</td><td>never</td><td></td></tr><tr><td>getfenv</td><td>2.1 partial</td><td>只有 getfenv(0) 能编译</td></tr><tr><td>getmetatable</td><td>yes</td><td></td></tr><tr><td>ipairs</td><td>yes</td><td></td></tr><tr><td>load</td><td>never</td><td></td></tr><tr><td>loadfile</td><td>never</td><td></td></tr><tr><td>loadstring</td><td>never</td><td></td></tr><tr><td>next</td><td>no</td><td></td></tr><tr><td>pairs</td><td>no</td><td></td></tr><tr><td>pcall</td><td>yes</td><td></td></tr><tr><td>print</td><td>no</td><td></td></tr><tr><td>rawequal</td><td>yes</td><td></td></tr><tr><td>rawget</td><td>yes</td><td></td></tr><tr><td>rawlen (5.2)</td><td>yes</td><td></td></tr><tr><td>rawset</td><td>yes</td><td></td></tr><tr><td>select</td><td>partial</td><td>第一个参数是静态变量的时候可以编译</td></tr><tr><td>setfenv</td><td>no</td><td></td></tr><tr><td>setmetatable</td><td>yes</td><td></td></tr><tr><td>tonumber</td><td>partial</td><td>不能编译非10进制，非预期的异常输入</td></tr><tr><td>tostring</td><td>partial</td><td>只能编译：字符串、数字、布尔、nil 以及支持 __tostring元方法的类型</td></tr><tr><td>type</td><td>yes</td><td></td></tr><tr><td>unpack</td><td>no</td><td></td></tr><tr><td>xpcall</td><td>yes</td><td></td></tr></tbody></table><a href=#字符串库><h3 id=字符串库><span class=hanchor arialabel=Anchor># </span><strong>字符串库</strong></h3></a><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>函数</td><td>编译?</td><td>备注</td></tr><tr><td>string.byte</td><td>yes</td><td></td></tr><tr><td>string.char</td><td>2.1</td><td></td></tr><tr><td>string.dump</td><td>never</td><td></td></tr><tr><td>string.find</td><td>2.1 partial</td><td>只有字符串样式查找（没有样式）</td></tr><tr><td>string.format</td><td>2.1 partial</td><td>不支持 %p 或 非字符串参数的 %s</td></tr><tr><td>string.gmatch</td><td>no</td><td></td></tr><tr><td>string.gsub</td><td>no</td><td></td></tr><tr><td>string.len</td><td>yes</td><td></td></tr><tr><td>string.lower</td><td>2.1</td><td></td></tr><tr><td>string.match</td><td>no</td><td></td></tr><tr><td>string.rep</td><td>2.1</td><td></td></tr><tr><td>string.reverse</td><td>2.1</td><td></td></tr><tr><td>string.sub</td><td>yes</td><td></td></tr><tr><td>string.upper</td><td>2.1</td><td></td></tr></tbody></table><a href=#表><h3 id=表><span class=hanchor arialabel=Anchor># </span><strong>表</strong></h3></a><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>函数</td><td>编译?</td><td>备注</td></tr><tr><td>table.concat</td><td>2.1</td><td></td></tr><tr><td>table.foreach</td><td>no</td><td>2.1: 内部编译，但还没有外放</td></tr><tr><td>table.foreachi</td><td>2.1</td><td></td></tr><tr><td>table.getn</td><td>yes</td><td></td></tr><tr><td>table.insert</td><td>partial</td><td>只有 push 操作</td></tr><tr><td>table.maxn</td><td>no</td><td></td></tr><tr><td>table.pack (5.2)</td><td>no</td><td></td></tr><tr><td>table.remove</td><td>2.1</td><td>部分，只有 pop 操作</td></tr><tr><td>table.sort</td><td>no</td><td></td></tr><tr><td>table.unpack (5.2)</td><td>no</td><td></td></tr></tbody></table><a href=#math-库><h3 id=math-库><span class=hanchor arialabel=Anchor># </span><strong>math 库</strong></h3></a><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>函数</td><td>编译?</td><td>备注</td></tr><tr><td>math.abs</td><td>yes</td><td></td></tr><tr><td>math.acos</td><td>yes</td><td></td></tr><tr><td>math.asin</td><td>yes</td><td></td></tr><tr><td>math.atan</td><td>yes</td><td></td></tr><tr><td>math.atan2</td><td>yes</td><td></td></tr><tr><td>math.ceil</td><td>yes</td><td></td></tr><tr><td>math.cos</td><td>yes</td><td></td></tr><tr><td>math.cosh</td><td>yes</td><td></td></tr><tr><td>math.deg</td><td>yes</td><td></td></tr><tr><td>math.exp</td><td>yes</td><td></td></tr><tr><td>math.floor</td><td>yes</td><td></td></tr><tr><td>math.fmod</td><td>no</td><td></td></tr><tr><td>math.frexp</td><td>no</td><td></td></tr><tr><td>math.ldexp</td><td>yes</td><td></td></tr><tr><td>math.log</td><td>yes</td><td></td></tr><tr><td>math.log10</td><td>yes</td><td></td></tr><tr><td>math.max</td><td>yes</td><td></td></tr><tr><td>math.min</td><td>yes</td><td></td></tr><tr><td>math.modf</td><td>yes</td><td></td></tr><tr><td>math.pow</td><td>yes</td><td></td></tr><tr><td>math.rad</td><td>yes</td><td></td></tr><tr><td>math.random</td><td>yes</td><td></td></tr><tr><td>math.randomseed</td><td>no</td><td></td></tr><tr><td>math.sin</td><td>yes</td><td></td></tr><tr><td>math.sinh</td><td>yes</td><td></td></tr><tr><td>math.sqrt</td><td>yes</td><td></td></tr><tr><td>math.tan</td><td>yes</td><td></td></tr><tr><td>math.tanh</td><td>yes</td><td></td></tr></tbody></table></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/lua/%E7%94%A8Go%E5%AE%9E%E7%8E%B0Lua/%E5%89%8D%E8%A8%80/ data-ctx=Lua高级 data-src=/lua/%E7%94%A8Go%E5%AE%9E%E7%8E%B0Lua/%E5%89%8D%E8%A8%80 class=internal-link>前言</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://googoo-s.github.io/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by googoo-s using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://googoo-s.github.io/>Home</a></li><li><a href=https://github.com/googoo-s>GitHub</a></li></ul></footer></div></div></body></html>